<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>F1 Resource — Mobile SPA (Admin Manager)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#021023; --card:#07121a; --muted:#9fb0c8; --accent:#0b5fff; --accent2:#7b5cff;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#021023,#041428);color:#eaf3ff}
.app{max-width:980px;margin:0 auto;min-height:100vh;display:flex;flex-direction:column}
.header{display:flex;align-items:center;gap:12px;padding:12px}
.logo{height:44px;border-radius:8px}
.title{font-weight:700;font-size:16px}
.muted{color:var(--muted);font-size:13px}
main{flex:1;padding:12px}
.centerCard{max-width:720px;margin:18px auto;padding:14px;background:linear-gradient(180deg,#0b1624,#08121a);border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
.input,textarea,select{width:100%;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;margin-top:10px;font-size:15px}
.btn{padding:10px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:700}
.btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#021022}
.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
.row{display:flex;gap:8px}
.hidden{display:none}
.item{padding:10px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);border:1px solid rgba(255,255,255,0.02);display:flex;justify-content:space-between;align-items:center}
.list{display:flex;flex-direction:column;gap:8px;margin-top:10px}
.sideMenu{position:fixed;left:8px;top:72px;bottom:72px;width:88%;max-width:360px;background:linear-gradient(180deg,#071723,#06121a);border-radius:12px;padding:12px;border:1px solid rgba(255,255,255,0.03);z-index:70;overflow:auto;transform:translateX(-120%);transition:0.28s}
.sideMenu.open{transform:translateX(0)}
.menuItem{padding:10px;border-radius:8px;margin-bottom:6px;cursor:pointer}
.menuItem.active{background:rgba(255,255,255,0.03)}
.adminBadge{background:#2b8a3e;padding:6px 8px;border-radius:8px;font-weight:700}
.bottomBar{position:fixed;left:0;right:0;bottom:0;padding:12px;background:linear-gradient(180deg,rgba(2,6,23,0.6),rgba(2,6,23,0.86));display:flex;gap:8px;justify-content:center;z-index:50}
.page{display:none}
.page.active{display:block}
.page-module{display:none}
.page-module.visible{display:block}
.kv{font-size:13px;color:var(--muted)}
@media (min-width:900px){main{max-width:980px;margin:0 auto} .sideMenu{left:24px}}
</style>
</head>
<body>

<div class="app" id="app">

  <!-- Header -->
  <div class="header" id="header" style="display:none">
    <button id="menuToggle" class="btn ghost small">☰ Menu</button>
    <img id="logo" class="logo" src="https://c6ee69d755.cbaul-cdnwnd.com/af0c9920a8129f9bf9a0921ecfe9d264/200000017-17b1717b1a/700/F1Resource-removebg-preview.webp?ph=c6ee69d755" alt="logo">
    <div style="flex:1">
      <div class="title" id="hdrTitle">F1 Resource</div>
      <div class="muted" id="hdrSub">Oswego County</div>
    </div>
    <div style="text-align:right">
      <div id="adminIndicator" class="kv" style="display:inline-block;margin-bottom:6px"></div>
      <div class="muted" id="userInfo"></div>
      <div style="margin-top:6px"><button id="btnLogout" class="btn ghost small">Logout</button></div>
    </div>
  </div>

  <main id="main">

    <!-- ACCESS CODE SCREEN -->
    <section id="view-access" class="page active">
      <div class="centerCard">
        <div style="text-align:center">
          <img src="" id="bigLogo" style="height:84px;border-radius:10px;display:block;margin:0 auto 8px">
          <h2 style="margin:4px 0">F1 Resource</h2>
          <div class="muted">Enter your department access code to continue</div>
        </div>
        <input id="accessInput" class="input" placeholder="Access Code">
        <div style="display:flex;gap:8px;margin-top:10px">
          <button id="accessBtn" class="btn primary">Verify</button>
          <button id="cadBtn" class="btn ghost">Mobile CAD Login</button>
        </div>
        <div style="display:flex;gap:8px;margin-top:10px">
          <button id="adminTriggerBtn" class="btn ghost small">Admin</button>
        </div>
        <div id="accessMsg" class="muted" style="margin-top:10px;color:#ff9b9b"></div>
      </div>
    </section>

    <!-- ADMIN CODE ENTRY (modal-like) -->
    <div id="adminCodeModal" class="centerCard hidden" style="position:fixed;left:8px;right:8px;top:100px;z-index:200">
      <h3 style="margin:0 0 8px">Admin Unlock</h3>
      <div class="muted">Enter master admin code to manage access codes</div>
      <input id="adminCodeInput" class="input" placeholder="Admin Master Code">
      <div style="display:flex;gap:8px;margin-top:10px">
        <button id="adminUnlockBtn" class="btn primary">Unlock Admin</button>
        <button id="adminCancelBtn" class="btn ghost">Cancel</button>
      </div>
      <div id="adminCodeMsg" class="muted" style="margin-top:8px;color:#ff9b9b"></div>
    </div>

    <!-- LOGIN SCREEN -->
    <section id="view-login" class="page">
      <div class="centerCard">
        <h3 id="loginAgency" style="margin:0 0 6px">Agency Login</h3>
        <div class="muted">Sign in with your department username</div>
        <input id="loginUser" class="input" placeholder="Username">
        <input id="loginPass" class="input" type="password" placeholder="Password">
        <div style="display:flex;gap:8px;margin-top:10px">
          <button id="loginBtn" class="btn primary">Login</button>
          <button id="backAccess" class="btn ghost">Back</button>
        </div>
        <div style="display:flex;gap:8px;margin-top:10px">
          <button id="createLocal" class="btn ghost small">Create Local Account</button>
          <button id="resetLocal" class="btn ghost small">Reset Local Users</button>
        </div>
        <div id="loginMsg" class="muted" style="margin-top:10px;color:#ff9b9b"></div>
      </div>
    </section>

    <!-- AGENCY SELECT -->
    <section id="view-agency-select" class="page">
      <div class="centerCard">
        <h3 style="margin:0 0 6px">Choose Agency</h3>
        <div class="muted">Select the agency you will operate under</div>
        <div id="agencyList" class="list" style="margin-top:12px"></div>
        <div style="display:flex;gap:8px;margin-top:12px">
          <button id="changeCode" class="btn ghost">Change Access Code</button>
        </div>
      </div>
    </section>

    <!-- AGENCY SHELL -->
    <section id="view-agency-shell" class="page">
      <div class="centerCard">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <h3 id="agencyNameDisplay" style="margin:0">Agency</h3>
            <div class="muted" id="agencyMeta">Agency home</div>
          </div>
          <div>
            <button id="openMenuBtn" class="btn ghost small">Open Menu</button>
          </div>
        </div>
        <div id="moduleContainer" style="margin-top:12px"></div>
      </div>
    </section>

    <!-- Module: Dashboard -->
    <div id="mod-dashboard" class="page-module">
      <div class="card">
        <h4 style="margin:0">Dashboard</h4>
        <div class="muted">Responding members</div>
        <div id="dashboardResponding" class="list" style="margin-top:12px"></div>
      </div>
    </div>

    <!-- Module: Incidents -->
    <div id="mod-incidents" class="page-module">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><h4 style="margin:0">Incidents</h4><div class="muted">Tap to open</div></div>
          <div><button id="newIncidentBtn" class="btn primary small">New</button></div>
        </div>
        <input id="incSearch" class="input" placeholder="Search address or ID">
        <div id="incidentList" class="list" style="margin-top:12px"></div>
      </div>
    </div>

    <!-- Incident modal -->
    <div id="incidentModal" class="centerCard hidden" style="position:fixed;left:8px;right:8px;top:80px;z-index:200">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong id="im_title">Incident</strong><div class="muted" id="im_sub"></div></div>
        <div><button id="im_close" class="btn ghost small">Close</button></div>
      </div>
      <div id="im_body" style="margin-top:10px"></div>
    </div>

    <!-- Module: Apparatus -->
    <div id="mod-apparatus" class="page-module">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><h4 style="margin:0">Apparatus</h4><div class="muted">Status & mutual aid</div></div>
          <div><button id="addAppBtn" class="btn primary small">Add</button></div>
        </div>
        <div id="apparatusList" class="list" style="margin-top:12px"></div>
      </div>
    </div>

    <!-- Module: Members -->
    <div id="mod-members" class="page-module">
      <div class="card">
        <h4 style="margin:0">Members</h4>
        <div id="membersList" class="list" style="margin-top:12px"></div>
      </div>
    </div>

    <!-- Module: Documents -->
    <div id="mod-documents" class="page-module">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><h4 style="margin:0">Documents</h4><div class="muted">Upload & view documents</div></div>
          <div><button id="docUploadBtn" class="btn primary small">Upload</button></div>
        </div>
        <input id="docFile" type="file" class="hidden" />
        <div id="docsList" class="list" style="margin-top:12px"></div>
      </div>
    </div>

    <!-- Module: Alarm List -->
    <div id="mod-alarms" class="page-module">
      <div class="card">
        <h4 style="margin:0">Alarm List</h4>
        <div id="alarmsList" class="list" style="margin-top:12px"></div>
      </div>
    </div>

    <!-- Module: Command Desk -->
    <div id="mod-command" class="page-module">
      <div class="card">
        <h4 style="margin:0">Command Desk</h4>
        <div id="commandList" style="margin-top:12px"></div>
        <div style="margin-top:10px;display:flex;gap:8px">
          <input id="cmdUnit" class="input" placeholder="Unit Callsign">
          <input id="cmdAssign" class="input" placeholder="Assignment">
        </div>
        <div style="margin-top:8px"><button id="btnAddCmd" class="btn primary">Add</button></div>
      </div>
    </div>

    <!-- Module: Events -->
    <div id="mod-events" class="page-module">
      <div class="card">
        <h4 style="margin:0">Events</h4>
        <div id="eventsList" class="list" style="margin-top:12px"></div>
      </div>
    </div>

    <!-- Module: Next Closest -->
    <div id="mod-nextclosest" class="page-module">
      <div class="card">
        <h4 style="margin:0">Next Closest Departments</h4>
        <div id="nextClosestList" class="list" style="margin-top:12px"></div>
      </div>
    </div>

    <!-- Module: Resources -->
    <div id="mod-resources" class="page-module">
      <div class="card">
        <h4 style="margin:0">Nearby Resources</h4>
        <div id="resourcesList" class="list" style="margin-top:12px"></div>
      </div>
    </div>

    <!-- Module: Response Dashboard -->
    <div id="mod-response" class="page-module">
      <div class="card">
        <h4 style="margin:0">Response Dashboard</h4>
        <div id="responseBoard" class="list" style="margin-top:12px"></div>
      </div>
    </div>

    <!-- Module: Rig Check -->
    <div id="mod-rigcheck" class="page-module">
      <div class="card">
        <h4 style="margin:0">Truck / Rig Check</h4>
        <div id="rigList" class="list" style="margin-top:12px"></div>
        <div style="margin-top:8px"><button id="rigUploadBtn" class="btn primary">Upload Rig Check</button></div>
      </div>
    </div>

    <!-- Module: Weather -->
    <div id="mod-weather" class="page-module">
      <div class="card">
        <h4 style="margin:0">Weather & Alerts</h4>
        <div id="weatherAlerts" style="margin-top:12px"></div>
      </div>
    </div>

  </main>

  <!-- Side menu -->
  <div id="sideMenu" class="sideMenu">
    <h3 id="menuAgency">Agency Menu</h3>
    <div class="muted" id="menuSub"></div>
    <div id="menuItems" style="margin-top:12px"></div>
    <hr>
    <div id="adminPanelButtonArea" style="margin-top:10px"></div>
    <div style="margin-top:12px">
      <button id="menuLogout" class="btn ghost small">Logout</button>
    </div>
  </div>

  <!-- Admin Manager Modal -->
  <div id="adminManager" class="centerCard hidden" style="position:fixed;left:8px;right:8px;top:80px;z-index:300">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div><h3 style="margin:0">Access Codes Manager</h3><div class="muted">Add / Edit / Delete access codes</div></div>
      <div><button id="adminClose" class="btn ghost small">Close</button></div>
    </div>

    <div style="margin-top:12px">
      <div style="display:flex;gap:8px">
        <input id="newAccessCode" class="input" placeholder="Access Code (e.g. 12345)">
        <input id="newAgencyId" class="input" placeholder="Agency ID (e.g. oswego_fd)">
      </div>
      <input id="newAgencyName" class="input" placeholder="Agency Display Name">
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="addAccessBtn" class="btn primary">Add</button>
      </div>
    </div>

    <hr style="margin-top:12px" />
    <div id="accessCodesList" class="list" style="margin-top:12px"></div>
  </div>

  <!-- bottom action bar -->
  <div class="bottomBar" id="bottomBar" style="display:none">
    <button id="statusBtn" class="btn primary">Change Response Status</button>
    <button id="dashBtn" class="btn ghost">See Dashboard</button>
  </div>

</div>

<!-- Firebase & app logic -->
<script type="module">
/* ---------------------------
   Firebase modular imports
   --------------------------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import {
  getFirestore, collection, doc, getDoc, setDoc, addDoc, getDocs, query, where,
  onSnapshot, deleteDoc, orderBy
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

/* ---------- config ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyBi0Xyljx7zzXTmyyRMAru11hZ2s5S3tsw",
  authDomain: "f1resource-8fedc.firebaseapp.com",
  projectId: "f1resource-8fedc",
  storageBucket: "f1resource-8fedc.firebasestorage.app",
  messagingSenderId: "182745701982",
  appId: "1:182745701982:web:9f4f3836b41b450987decf"
};
const firebaseApp = initializeApp(firebaseConfig);
const db = getFirestore(firebaseApp);

/* ---------------------------
   Local storage keys & helpers
   --------------------------- */
const LOCAL_USERS_KEY = 'f1_local_users_v1';
const SESSION_KEY = 'f1_session_v1';

function loadLocalUsers(){ try { return JSON.parse(localStorage.getItem(LOCAL_USERS_KEY)||'{}'); } catch(e){ return {}; } }
function saveLocalUsers(u){ localStorage.setItem(LOCAL_USERS_KEY, JSON.stringify(u)); }
function saveSession(s){ localStorage.setItem(SESSION_KEY, JSON.stringify(s)); }
function loadSession(){ try { return JSON.parse(localStorage.getItem(SESSION_KEY)||'null'); } catch(e){ return null; } }

/* seed local users if empty */
let localUsers = loadLocalUsers();
if(!Object.keys(localUsers).length){
  localUsers = {
    "ADMIN":{ password:"ADMIN", role:"ADMIN", displayName:"Administrator", dept:"" },
    "FDADMIN":{ password:"FDADMIN", role:"DEPT_ADMIN", displayName:"Dept Admin", dept:"" },
    "FDUSER":{ password:"FDUSER", role:"MEMBER", displayName:"Member", dept:"" }
  };
  saveLocalUsers(localUsers);
}

/* ---------------------------
   App state
   --------------------------- */
let ACCESS = null; // access doc data
let SESSION = loadSession(); // { username, role, agencyId, agencyName, accessCode }
let CURRENT_AGENCY_ID = SESSION?.agencyId || null;
let CURRENT_AGENCY_META = null;

/* admin unlocked flag + master code */
let adminUnlocked = false;
const ADMIN_MASTER_CODE = "FELTOPERATIONSADMINS"; // master code you provided

/* listeners holders */
let unsubApp=null, unsubInc=null, unsubMembers=null, unsubDocs=null;

/* ---------------------------
   DOM refs
   --------------------------- */
const bigLogo = document.getElementById('bigLogo');
bigLogo.src = document.getElementById('logo').src;

const viewAccess = document.getElementById('view-access');
const viewLogin = document.getElementById('view-login');
const viewAgencySelect = document.getElementById('view-agency-select');
const viewAgencyShell = document.getElementById('view-agency-shell');

const accessInput = document.getElementById('accessInput');
const accessBtn = document.getElementById('accessBtn');
const accessMsg = document.getElementById('accessMsg');
const cadBtn = document.getElementById('cadBtn');

const adminTriggerBtn = document.getElementById('adminTriggerBtn');
const adminCodeModal = document.getElementById('adminCodeModal');
const adminCodeInput = document.getElementById('adminCodeInput');
const adminUnlockBtn = document.getElementById('adminUnlockBtn');
const adminCancelBtn = document.getElementById('adminCancelBtn');
const adminCodeMsg = document.getElementById('adminCodeMsg');

const loginUser = document.getElementById('loginUser');
const loginPass = document.getElementById('loginPass');
const loginBtn = document.getElementById('loginBtn');
const backAccess = document.getElementById('backAccess');
const loginMsg = document.getElementById('loginMsg');
const loginAgency = document.getElementById('loginAgency');

const agencyListEl = document.getElementById('agencyList');
const agencyNameDisplay = document.getElementById('agencyNameDisplay');
const agencyMetaEl = document.getElementById('agencyMeta');
const moduleContainer = document.getElementById('moduleContainer');

const sideMenu = document.getElementById('sideMenu');
const menuItems = document.getElementById('menuItems');
const adminPanelButtonArea = document.getElementById('adminPanelButtonArea');
const adminManagerModal = document.getElementById('adminManager');

const accessCodesList = document.getElementById('accessCodesList');
const newAccessCode = document.getElementById('newAccessCode');
const newAgencyId = document.getElementById('newAgencyId');
const newAgencyName = document.getElementById('newAgencyName');
const addAccessBtn = document.getElementById('addAccessBtn');
const adminClose = document.getElementById('adminClose');

const bottomBar = document.getElementById('bottomBar');
const statusBtn = document.getElementById('statusBtn');
const dashBtn = document.getElementById('dashBtn');

const menuToggle = document.getElementById('menuToggle');
const menuLogout = document.getElementById('menuLogout');
const openMenuBtn = document.getElementById('openMenuBtn');

/* module pages map */
const pages = {
  dashboard: document.getElementById('mod-dashboard'),
  incidents: document.getElementById('mod-incidents'),
  apparatus: document.getElementById('mod-apparatus'),
  members: document.getElementById('mod-members'),
  documents: document.getElementById('mod-documents'),
  alarms: document.getElementById('mod-alarms'),
  command: document.getElementById('mod-command'),
  events: document.getElementById('mod-events'),
  nextclosest: document.getElementById('mod-nextclosest'),
  resources: document.getElementById('mod-resources'),
  response: document.getElementById('mod-response'),
  rigcheck: document.getElementById('mod-rigcheck'),
  weather: document.getElementById('mod-weather'),
  incidentsView: document.getElementById('incidentModal')
};

/* ---------------------------
   Page & module helpers
   --------------------------- */
function showView(name){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  if(name==='access') viewAccess.classList.add('active');
  if(name==='login') viewLogin.classList.add('active');
  if(name==='agency-select') viewAgencySelect.classList.add('active');
  if(name==='agency-shell') viewAgencyShell.classList.add('active');

  // header/bottom visibility
  if(name==='agency-shell'){ document.getElementById('header').style.display='flex'; bottomBar.style.display='flex'; }
  else { document.getElementById('header').style.display='none'; bottomBar.style.display='none'; }
  // hide all modules
  document.querySelectorAll('.page-module').forEach(m=>m.classList.remove('visible'));
}

function showModule(mod){
  document.querySelectorAll('.page-module').forEach(m=>m.classList.remove('visible'));
  const mm = pages[mod];
  if(mm) mm.classList.add('visible');
  moduleContainer.innerHTML = '';
  if(mm) moduleContainer.appendChild(mm);
  // highlight menu
  document.querySelectorAll('.menuItem').forEach(mi=>mi.classList.remove('active'));
  const mi = document.querySelector(`.menuItem[data-mod="${mod}"]`);
  if(mi) mi.classList.add('active');
}

/* ---------------------------
   Access code flow
   --------------------------- */
accessBtn.addEventListener('click', async ()=>{
  const code = (accessInput.value||'').trim();
  accessMsg.textContent='';
  if(!code){ accessMsg.textContent='Enter access code'; return; }
  try{
    const q = query(collection(db,'access_codes'), where('accessCode','==', code));
    const snap = await getDocs(q);
    if(snap.empty){ accessMsg.textContent='Invalid code'; return; }
    ACCESS = snap.docs[0].data(); ACCESS._id = snap.docs[0].id;
    // list agency (one-to-one)
    const agencies = await listAgenciesForAccess(ACCESS);
    renderAgencyList(agencies);
    showView('agency-select');
  } catch(e){ console.error(e); accessMsg.textContent='Error verifying code'; }
});

/* helper: list agencies for access (returns array) */
async function listAgenciesForAccess(accessDoc){
  const out=[];
  if(!accessDoc) return out;
  const aid = accessDoc.agencyId;
  const meta = await ensureAgencyMeta(aid, accessDoc.name || aid);
  out.push({ agencyId: aid, name: meta.name || accessDoc.name || aid, meta });
  return out;
}

/* render agency list */
function renderAgencyList(list){
  agencyListEl.innerHTML='';
  list.forEach(a=>{
    const row = document.createElement('div'); row.className='item';
    row.innerHTML = `<div><strong>${a.name}</strong><div class="muted">${a.agencyId}</div></div><div><button class="btn primary small">Open</button></div>`;
    agencyListEl.appendChild(row);
    row.querySelector('button').addEventListener('click', async ()=>{
      SESSION = { accessCode: ACCESS.accessCode, username:SESSION?.username||null, role:SESSION?.role||null, agencyId: a.agencyId, agencyName: a.name };
      saveSession(SESSION);
      CURRENT_AGENCY_ID = a.agencyId; CURRENT_AGENCY_META = a.meta;
      loginAgency.textContent = a.name + ' — Login';
      showView('login');
    });
  });
}

/* ensure agency meta doc exists */
async function ensureAgencyMeta(agencyId,nameFallback){
  try{
    const ref = doc(db,'agencies',agencyId,'meta','config');
    const snap = await getDoc(ref);
    if(snap.exists()) return snap.data();
    const base = { name: nameFallback || agencyId, createdAt: new Date().toISOString(), metaDescription:'', order:0 };
    await setDoc(ref, base);
    return base;
  } catch(e){ console.error(e); return { name: nameFallback || agencyId }; }
}

/* ---------------------------
   Local login handling
   --------------------------- */
loginBtn.addEventListener('click', ()=>{
  const u = (loginUser.value||'').trim().toUpperCase();
  const p = (loginPass.value||'').trim();
  if(!u||!p){ loginMsg.textContent='Enter username & password'; return; }
  localUsers = loadLocalUsers();
  const user = localUsers[u];
  if(!user || user.password !== p){ loginMsg.textContent='Invalid credentials'; return; }
  SESSION = SESSION || {};
  SESSION.username = u; SESSION.role = user.role; SESSION.agencyId = CURRENT_AGENCY_ID; SESSION.agencyName = CURRENT_AGENCY_META?.name || CURRENT_AGENCY_ID;
  saveSession(SESSION);
  // write member metadata (no password)
  setDoc(doc(db,'agencies',CURRENT_AGENCY_ID,'members',u.toLowerCase()), { username:u, displayName:user.displayName||u, role:user.role, createdAt:new Date().toISOString() }).catch(()=>{});
  startAgencyShell();
});

backAccess.addEventListener('click', ()=> showView('access'));
document.getElementById('createLocal').addEventListener('click', ()=>{
  const uname = prompt('New username (no spaces)').trim().toUpperCase(); if(!uname) return;
  const pass = prompt('Password for '+uname); if(!pass) return;
  const display = prompt('Display name', uname) || uname;
  const role = prompt('Role (ADMIN / DEPT_ADMIN / MEMBER)', 'MEMBER') || 'MEMBER';
  localUsers = loadLocalUsers();
  localUsers[uname] = { password: pass, role, displayName: display, dept: ACCESS?.agencyId || '' };
  saveLocalUsers(localUsers);
  setDoc(doc(db,'agencies',ACCESS.agencyId,'members',uname.toLowerCase()), { username:uname, displayName:display, role, createdAt:new Date().toISOString() });
  alert('Local user created');
});
document.getElementById('resetLocal').addEventListener('click', ()=>{
  if(!confirm('Reset local users on this device?')) return;
  localStorage.removeItem(LOCAL_USERS_KEY); alert('Local users cleared. Reload the page.'); location.reload();
});

/* ---------------------------
   Start Agency Shell
   --------------------------- */
async function startAgencyShell(){
  CURRENT_AGENCY_META = await ensureAgencyMeta(CURRENT_AGENCY_ID, SESSION.agencyName || CURRENT_AGENCY_ID);
  document.getElementById('hdrTitle').textContent = CURRENT_AGENCY_META.name || CURRENT_AGENCY_ID;
  document.getElementById('hdrSub').textContent = CURRENT_AGENCY_META.metaDescription || '';
  document.getElementById('userInfo').textContent = SESSION.username + ' • ' + SESSION.role;
  document.getElementById('adminIndicator').textContent = adminUnlocked ? 'ADMIN MODE' : '';
  buildMenu();
  attachListeners(CURRENT_AGENCY_ID);
  showView('agency-shell');
  showModule('dashboard');
}

/* build side menu with modules; show admin buttons if adminUnlocked */
function buildMenu(){
  menuItems.innerHTML = '';
  const pagesList = [
    {mod:'dashboard', label:'Dashboard'},
    {mod:'incidents', label:'Incidents'},
    {mod:'apparatus', label:'Apparatus'},
    {mod:'members', label:'Members'},
    {mod:'documents', label:'Documents'},
    {mod:'alarms', label:'Alarm List'},
    {mod:'command', label:'Command Desk'},
    {mod:'events', label:'Events'},
    {mod:'nextclosest', label:'Next Closest'},
    {mod:'resources', label:'Nearby Resources'},
    {mod:'response', label:'Response Dashboard'},
    {mod:'rigcheck', label:'Truck Check'},
    {mod:'weather', label:'Weather'}
  ];
  pagesList.forEach(p=>{
    const el = document.createElement('div'); el.className='menuItem'; el.dataset.mod = p.mod;
    el.innerHTML = `<strong>${p.label}</strong><div class="muted">${p.mod}</div>`;
    el.addEventListener('click', ()=>{ showModule(p.mod); sideMenu.classList.remove('open'); });
    menuItems.appendChild(el);
  });

  adminPanelButtonArea.innerHTML = '';
  if(adminUnlocked){
    const manageBtn = document.createElement('button'); manageBtn.className='btn ghost small'; manageBtn.textContent = 'Manage Access Codes';
    manageBtn.addEventListener('click', ()=> openAdminManager());
    adminPanelButtonArea.appendChild(manageBtn);
  }
}

/* menu open/close */
menuToggle.addEventListener('click', ()=> sideMenu.classList.toggle('open'));
openMenuBtn.addEventListener('click', ()=> sideMenu.classList.add('open'));
menuLogout.addEventListener('click', ()=> doLogout());
document.getElementById('btnLogout').addEventListener('click', ()=> doLogout());

function doLogout(){
  if(!confirm('Logout from this device?')) return;
  localStorage.removeItem(SESSION_KEY);
  SESSION = null; CURRENT_AGENCY_ID = null;
  if(unsubApp) unsubApp(); if(unsubInc) unsubInc(); if(unsubMembers) unsubMembers(); if(unsubDocs) unsubDocs();
  adminUnlocked = false;
  showView('access');
}

/* ---------------------------
   Firestore listeners for agency
   --------------------------- */
function attachListeners(agencyId){
  if(unsubApp) unsubApp(); if(unsubInc) unsubInc(); if(unsubMembers) unsubMembers(); if(unsubDocs) unsubDocs();

  try {
    const col = collection(db,'agencies',agencyId,'apparatus');
    unsubApp = onSnapshot(col, snap=>{ const arr=[]; snap.forEach(d=>arr.push({id:d.id,...d.data()})); renderApparatus(arr); });
  } catch(e){ console.warn(e); }

  try {
    const col = collection(db,'agencies',agencyId,'incidents');
    unsubInc = onSnapshot(col, snap=>{ const arr=[]; snap.forEach(d=>arr.push({id:d.id,...d.data()})); renderIncidents(arr); });
  } catch(e){ console.warn(e); }

  try {
    const col = collection(db,'agencies',agencyId,'members');
    unsubMembers = onSnapshot(col, snap=>{ const arr=[]; snap.forEach(d=>arr.push({id:d.id,...d.data()})); renderMembers(arr); });
  } catch(e){ console.warn(e); }

  try {
    const col = collection(db,'agencies',agencyId,'documents');
    unsubDocs = onSnapshot(col, snap=>{ const arr=[]; snap.forEach(d=>arr.push({id:d.id,...d.data()})); renderDocuments(arr); });
  } catch(e){ console.warn(e); }
}

/* ---------------------------
   Render functions
   --------------------------- */
function renderApparatus(arr){ const el=document.getElementById('apparatusList'); el.innerHTML=''; if(!arr.length) el.innerHTML='<div class="muted">No apparatus</div>'; arr.forEach(a=>{ const r=document.createElement('div'); r.className='item'; r.innerHTML=`<div><strong>${a.callsign||a.apparatusName||a.id}</strong><div class="muted">${a.type||''} • ${a.department||''}</div></div><div class="muted">${a.status||'IN SERVICE'}</div>`; el.appendChild(r); }); }
function renderIncidents(arr){ const el=document.getElementById('incidentList'); el.innerHTML=''; if(!arr.length) el.innerHTML='<div class="muted">No incidents</div>'; arr.sort((a,b)=>(b.createdAt||'').localeCompare(a.createdAt||'')); arr.forEach(i=>{ const r=document.createElement('div'); r.className='item'; r.innerHTML=`<div><strong>${i.type||'Incident'}</strong><div class="muted">${i.address||''} • ${i.createdAt||''}</div></div><div><button class="btn ghost small">Open</button></div>`; el.appendChild(r); r.querySelector('button').addEventListener('click', ()=> openIncident(i)); }); }
function renderMembers(arr){ const el=document.getElementById('membersList'); el.innerHTML=''; if(!arr.length) el.innerHTML='<div class="muted">No members</div>'; arr.sort((a,b)=>(a.displayName||a.username||'').localeCompare(b.displayName||b.username||'')); arr.forEach(m=>{ const r=document.createElement('div'); r.className='item'; r.innerHTML=`<div><strong>${m.displayName||m.username||m.id}</strong><div class="muted">${m.rank||m.role||''}</div></div><div><button class="btn ghost small">View</button></div>`; el.appendChild(r); }); }
function renderDocuments(arr){ const el=document.getElementById('docsList'); el.innerHTML=''; if(!arr.length) el.innerHTML='<div class="muted">No documents</div>'; arr.forEach(d=>{ const r=document.createElement('div'); r.className='item'; const exp=d.expiresAt?` • Expires ${d.expiresAt}`:''; r.innerHTML=`<div><strong>${d.title||d.filename||d.id}</strong><div class="muted">${d.ownerId||''}${exp}</div></div><div><button class="btn ghost small">Download</button></div>`; el.appendChild(r); r.querySelector('button').addEventListener('click', ()=> downloadDocument(CURRENT_AGENCY_ID, d.id)); }); }

/* ---------------------------
   Incident modal
   --------------------------- */
function openIncident(inc){ document.getElementById('im_title').textContent = inc.type||'Incident'; document.getElementById('im_sub').textContent = inc.address||''; document.getElementById('im_body').innerHTML = `<div class="muted">Created: ${inc.createdAt||''} • By: ${inc.createdBy||''}</div><div style="margin-top:8px">${inc.notes||''}</div>`; document.getElementById('incidentModal').classList.remove('hidden'); }
document.getElementById('im_close').addEventListener('click', ()=> document.getElementById('incidentModal').classList.add('hidden'));

/* ---------------------------
   Create / Add actions
   --------------------------- */
document.getElementById('addAppBtn').addEventListener('click', async ()=>{ const id = prompt('Apparatus ID (ENGINE511)'); if(!id) return; const name = prompt('Display name', id)||id; const type = prompt('Type (Engine/Ladder/Rescue)','Engine')||'Engine'; await setDoc(doc(db,'agencies',CURRENT_AGENCY_ID,'apparatus',id.trim().toUpperCase()),{apparatusName:name,callsign:id.trim().toUpperCase(),type,status:'IN SERVICE'}); alert('Added'); });

document.getElementById('newIncidentBtn').addEventListener('click', async ()=>{ const addr = prompt('Address / Location'); if(!addr) return; const type = prompt('Type / Nature','Structure')||'Structure'; const notes = prompt('Notes','')||''; await addDoc(collection(db,'agencies',CURRENT_AGENCY_ID,'incidents'),{address:addr,type,notes,createdBy:SESSION.username,createdAt:new Date().toISOString(),archived:false}); alert('Created'); });

document.getElementById('btnAddCmd').addEventListener('click', async ()=>{ const unit = document.getElementById('cmdUnit').value.trim().toUpperCase(); const assign = document.getElementById('cmdAssign').value.trim(); if(!unit||!assign) return alert('Enter unit and assignment'); await addDoc(collection(db,'agencies',CURRENT_AGENCY_ID,'command_logs'),{unit,assignment:assign,by:SESSION.username,ts:new Date().toISOString()}); const incs = await getDocs(query(collection(db,'agencies',CURRENT_AGENCY_ID,'incidents'), orderBy('createdAt','desc'))); if(!incs.empty){ const incId = incs.docs[0].id; await addDoc(collection(db,'agencies',CURRENT_AGENCY_ID,'incidents',incId,'timeline'),{title:'Command',text:`${unit} -> ${assign}`,sender:SESSION.username,ts:new Date().toISOString()}); } alert('Command added'); });

/* ---------------------------
   Documents chunk upload/download
   --------------------------- */
const CHUNK_SIZE = 800000;
function chunkString(str,size=CHUNK_SIZE){ const out=[]; for(let i=0;i<str.length;i+=size) out.push(str.slice(i,i+size)); return out; }
function fileToBase64(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onerror=()=>rej('readerr'); r.onload=()=>{ const data = r.result.split(',')[1]; res(data); }; r.readAsDataURL(file); }); }

document.getElementById('docUploadBtn').addEventListener('click', ()=> document.getElementById('docFile').click());
document.getElementById('docFile').addEventListener('change', async (ev)=>{
  const f = ev.target.files[0]; if(!f) return;
  try{
    const base64 = await fileToBase64(f);
    const chunks = chunkString(base64);
    const metaRef = await addDoc(collection(db,'agencies',CURRENT_AGENCY_ID,'documents'),{title:f.name,filename:f.name,mimeType:f.type,sizeBytes:f.size,ownerId:SESSION.username,uploadedAt:new Date().toISOString(),chunkCount:chunks.length});
    for(let i=0;i<chunks.length;i++){ await addDoc(collection(db,'agencies',CURRENT_AGENCY_ID,'documents',metaRef.id,'chunks'),{index:i,data:chunks[i]}); }
    alert('Upload complete');
    ev.target.value='';
  } catch(e){ console.error(e); alert('Upload failed'); }
});

/* ---------------------------
   Download document
   --------------------------- */
import { query as fsQuery, orderBy as fsOrderBy } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
async function downloadDocument(agencyId, docId){
  try{
    const metaSnap = await getDoc(doc(db,'agencies',agencyId,'documents',docId));
    if(!metaSnap.exists()) throw new Error('Missing');
    const meta = metaSnap.data();
    const chunksSnap = await getDocs(fsQuery(collection(db,'agencies',agencyId,'documents',docId,'chunks'), fsOrderBy('index','asc')));
    let base64=''; chunksSnap.forEach(c=> base64 += c.data().data);
    const binary = atob(base64);
    const len = binary.length; const u8 = new Uint8Array(len);
    for(let i=0;i<len;i++) u8[i]=binary.charCodeAt(i);
    const blob = new Blob([u8], { type: meta.mimeType || 'application/octet-stream' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = meta.filename || meta.title || 'file'; document.body.appendChild(a); a.click();
    setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); },1500);
  } catch(e){ alert('Download failed: '+e.message); console.error(e); }
}

/* ---------------------------
   Admin manager: open/close and Firestore ops
   --------------------------- */
adminTriggerBtn.addEventListener('click', ()=> {
  adminCodeModal.classList.remove('hidden');
  adminCodeMsg.textContent = '';
  adminCodeInput.value = '';
});
adminCancelBtn.addEventListener('click', ()=> adminCodeModal.classList.add('hidden'));

/* Unlock admin by comparing entered code to master code (plain compare) */
adminUnlockBtn.addEventListener('click', async ()=>{
  const val = (adminCodeInput.value||'').trim();
  if(!val){ adminCodeMsg.textContent='Enter admin code'; return; }
  if(val === ADMIN_MASTER_CODE){
    adminUnlocked = true;
    adminCodeModal.classList.add('hidden');
    document.getElementById('adminIndicator').textContent = 'ADMIN MODE';
    buildMenu(); // adds admin manager button
    await loadAccessCodesIntoAdminList();
    alert('Admin unlocked — Manage Access Codes via the menu');
  } else {
    adminCodeMsg.textContent='Incorrect admin code';
  }
});

/* open admin manager modal */
function openAdminManager(){
  adminManagerModal.classList.remove('hidden');
  accessCodesList.innerHTML = '<div class="muted">Loading...</div>';
  loadAccessCodesIntoAdminList();
}

/* close admin manager */
adminClose.addEventListener('click', ()=> adminManagerModal.classList.add('hidden'));

/* load access_codes collection and render list */
async function loadAccessCodesIntoAdminList(){
  try{
    accessCodesList.innerHTML = '<div class="muted">Loading...</div>';
    const snap = await getDocs(collection(db,'access_codes'));
    accessCodesList.innerHTML = '';
    if(snap.empty) accessCodesList.innerHTML = '<div class="muted">No access codes found</div>';
    snap.forEach(docSnap=>{
      const d = docSnap.data(); const id = docSnap.id;
      const div = document.createElement('div'); div.className='item';
      div.innerHTML = `<div><strong>${d.name || d.agencyId || id}</strong><div class="muted">Code: ${d.accessCode} • Agency: ${d.agencyId}</div></div>
        <div style="display:flex;flex-direction:column;gap:6px">
          <button class="btn ghost small" data-act="edit" data-id="${id}">Edit</button>
          <button class="btn ghost small" data-act="del" data-id="${id}">Delete</button>
        </div>`;
      accessCodesList.appendChild(div);
      div.querySelector('[data-act="edit"]').addEventListener('click', ()=> editAccessCode(id,d));
      div.querySelector('[data-act="del"]').addEventListener('click', ()=> deleteAccessCode(id, d));
    });
  } catch(e){ console.error(e); accessCodesList.innerHTML = '<div class="muted">Error loading</div>'; }
}

/* add new access code */
addAccessBtn.addEventListener('click', async ()=>{
  const code = (newAccessCode.value||'').trim();
  const aid = (newAgencyId.value||'').trim();
  const name = (newAgencyName.value||'').trim();
  if(!code||!aid||!name){ alert('Fill code, agency ID and name'); return; }
  try{
    await addDoc(collection(db,'access_codes'), { accessCode: code, agencyId: aid, name });
    newAccessCode.value=''; newAgencyId.value=''; newAgencyName.value='';
    await loadAccessCodesIntoAdminList();
    alert('Access code added');
  } catch(e){ console.error(e); alert('Failed to add'); }
});

/* edit access code */
async function editAccessCode(docId, data){
  const code = prompt('Access code', data.accessCode || '');
  if(code === null) return;
  const aid = prompt('Agency ID', data.agencyId || '') || '';
  const name = prompt('Display name', data.name || '') || '';
  try{
    await setDoc(doc(db,'access_codes',docId), { accessCode: code, agencyId: aid, name });
    await loadAccessCodesIntoAdminList();
    alert('Saved');
  } catch(e){ console.error(e); alert('Save failed'); }
}

/* delete access code */
async function deleteAccessCode(docId, data){
  if(!confirm(`Delete access code for ${data.name || data.agencyId || docId}?`)) return;
  try{
    await deleteDoc(doc(db,'access_codes',docId));
    await loadAccessCodesIntoAdminList();
    alert('Deleted');
  } catch(e){ console.error(e); alert('Delete failed'); }
}

/* ---------------------------
   Utilities & init
   --------------------------- */
function uid(){ return 'id_'+Math.random().toString(36).slice(2,9); }
async function getAgencyMeta(agencyId){ const snap = await getDoc(doc(db,'agencies',agencyId,'meta','config')); return snap.exists()?snap.data():null; }

/* resume session if present */
(async function init(){
  bigLogo.src = document.getElementById('logo').src;
  if(SESSION && SESSION.agencyId && SESSION.username){
    CURRENT_AGENCY_ID = SESSION.agencyId;
    CURRENT_AGENCY_META = await ensureAgencyMeta(CURRENT_AGENCY_ID, SESSION.agencyName || CURRENT_AGENCY_ID);
    document.getElementById('hdrTitle').textContent = CURRENT_AGENCY_META.name || CURRENT_AGENCY_ID;
    document.getElementById('userInfo').textContent = SESSION.username + ' • ' + SESSION.role;
    buildMenu();
    attachListeners(CURRENT_AGENCY_ID);
    showView('agency-shell');
    showModule('dashboard');
  } else {
    showView('access');
  }
})();

/* CAD button */
cadBtn.addEventListener('click', ()=> window.open('dispatch.html','_blank'));

</script>
</body>
</html>
