<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>F1 Resource — Oswego County</title>
  <meta name="description" content="F1 Resource - Fire & EMS resource hub" />
  <style>
    /* ---- Theme + layout ---- */
    :root{
      --accent1:#7b5cff;
      --accent2:#ff6f91;
      --bg-light:#f6f7fb;
      --bg-light2:#eef2f7;
      --bg-dark:#0b0622;
      --muted-light:#4b5563;
      --muted-dark:#cbd5e1;
      --card-bg: rgba(255,255,255,0.02);
      --radius:12px;
    }
    @media (prefers-color-scheme: dark){
      :root{ --bg:var(--bg-dark); --text:#f7f7fb; --muted:var(--muted-dark); }
    }
    @media (prefers-color-scheme: light){
      :root{ --bg:linear-gradient(180deg,var(--bg-light),var(--bg-light2)); --text:#0b1220; --muted:var(--muted-light); }
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--text);background:var(--bg)}
    a{color:inherit}
    .app{display:flex;min-height:100vh}
    .sidebar{width:220px;padding:18px;flex-shrink:0;display:flex;flex-direction:column;gap:12px;border-right:1px solid rgba(0,0,0,0.04)}
    .logoImg{height:44px;border-radius:8px}
    .appTitle{font-weight:800;font-size:16px}
    .nav{display:flex;flex-direction:column;gap:6px;margin-top:8px}
    .nav button{background:transparent;border:none;text-align:left;padding:10px 12px;border-radius:8px;font-weight:700;color:var(--muted);cursor:pointer}
    .nav button.active, .nav button:hover{background:linear-gradient(90deg,rgba(123,92,255,0.12),rgba(255,111,145,0.06));color:var(--text);transform:translateX(2px)}
    .main{flex:1;display:flex;flex-direction:column;gap:18px;padding:22px}
    .topBar{display:flex;justify-content:space-between;align-items:center}
    .siteLogo{height:60px;border-radius:10px}
    .title{font-size:22px;margin:0}
    .muted{color:var(--muted);font-size:13px}
    .card{background:var(--card-bg);padding:16px;border-radius:var(--radius);box-shadow:0 10px 30px rgba(0,0,0,0.06);border:1px solid rgba(0,0,0,0.03)}
    .view{display:none}
    .view.active{display:block}
    .list{display:flex;flex-direction:column;gap:10px;margin-top:12px}
    .listItem{display:flex;justify-content:space-between;align-items:center;background:rgba(255,255,255,0.02);padding:12px;border-radius:10px;border:1px solid rgba(0,0,0,0.03)}
    .meta{color:var(--muted);font-size:12px}
    .btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:700}
    .btn.primary{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#fff}
    .btn.ghost{background:transparent;border:1px solid rgba(0,0,0,0.06);color:var(--muted)}
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:999;backdrop-filter:blur(4px)}
    .modal-backdrop.show{display:flex}
    .modal{width:720px;max-width:96%;max-height:86vh;overflow:auto;border-radius:12px;padding:18px;background:var(--card-bg);border:1px solid rgba(0,0,0,0.06)}
    .modal input,.modal textarea,.modal select{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);background:transparent;color:var(--text)}
    @media (max-width:980px){
      .sidebar{display:none}
      .mobileTop{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid rgba(0,0,0,0.04);background:transparent}
      .drawer{position:fixed;left:0;top:0;height:100%;width:260px;background:var(--card-bg);box-shadow:6px 0 28px rgba(0,0,0,0.3);transform:translateX(-120%);transition:transform .22s;z-index:1000;padding:18px}
      .drawer.open{transform:translateX(0)}
    }
    .small{padding:6px 8px;font-size:13px;border-radius:8px}
    .mutedBlock{color:var(--muted);font-size:13px}
    .hidden{display:none}
  </style>
</head>
<body>
  <!-- NOTE: Place your logo in the project root as "logo.png" (or replace ./logo.png with your path).
       Dev path we have in the environment: /mnt/data/F1Resource-removebg-preview.png (for reference). -->
  <!-- Login view -->
  <div id="loginView" style="display:flex;align-items:center;justify-content:center;min-height:100vh;padding:20px">
    <div class="card" style="max-width:820px;width:100%;display:flex;gap:18px;align-items:center">
      <img id="logoLogin" src="https://c6ee69d755.cbaul-cdnwnd.com/af0c9920a8129f9bf9a0921ecfe9d264/200000017-17b1717b1a/700/F1Resource-removebg-preview.webp?ph=c6ee69d755" alt="logo" class="logoImg" style="height:96px">
      <div style="flex:1">
        <h2 style="margin:0">F1 Resource — Login</h2>
        <p class="muted">Local login (Admin / Department Admin / Department User). Data stored in Firestore beneath a single root (f1resource).</p>
        <div style="margin-top:12px;display:flex;gap:8px;flex-direction:column">
          <input id="login_user" placeholder="Username" />
          <input id="login_pass" type="password" placeholder="Password" />
          <div style="display:flex;gap:8px">
            <button id="loginBtn" class="btn primary">Login</button>
            <button id="loginFill" class="btn ghost">Demo Fill</button>
          </div>
          <div id="loginMsg" class="muted" style="color:crimson"></div>
        </div>
        <p class="muted" style="margin-top:10px">Demo local accounts: <strong>ADMIN/ADMIN</strong>, <strong>DEPTADMIN/DEPTADMIN</strong>, <strong>DEPTUSER/DEPTUSER</strong></p>
      </div>
    </div>
  </div>

  <!-- SPA -->
  <div id="spa" class="app hidden" style="display:none">
    <aside class="sidebar" role="navigation" aria-label="Main navigation">
      <div style="display:flex;align-items:center;gap:12px">
        <img src="https://c6ee69d755.cbaul-cdnwnd.com/af0c9920a8129f9bf9a0921ecfe9d264/200000017-17b1717b1a/700/F1Resource-removebg-preview.webp?ph=c6ee69d755" class="logoImg" alt="logo">
        <div><div class="appTitle">F1 Resource</div><div class="muted">Oswego County</div></div>
      </div>
      <nav class="nav" aria-label="Pages">
        <button data-view="home" class="active">HOME</button>
        <button data-view="departments">FIRE DEPARTMENTS</button>
        <button data-view="ems">EMS AGENCIES</button>
        <button data-view="coordinators">COUNTY COORDINATORS</button>
        <button data-view="teams">COUNTY TEAMS</button>
        <button data-view="hazmat">HAZMAT SEARCH</button>
        <button data-view="ev">EV SAFETY</button>
        <button data-view="risks">FIRE &amp; DRIVING RISK</button>
        <button data-view="weather">WEATHER</button>
        <button data-view="admin">ADMIN</button>
        <button id="logoutButton">LOGOUT</button>
      </nav>
      <div style="margin-top:auto" class="muted">Version 1.0</div>
    </aside>

    <!-- mobile header & drawer -->
    <div id="mobileHeader" class="mobileTop hidden" style="display:none">
      <button id="mobileToggle" class="small">MENU</button>
      <img src="https://c6ee69d755.cbaul-cdnwnd.com/af0c9920a8129f9bf9a0921ecfe9d264/200000017-17b1717b1a/700/F1Resource-removebg-preview.webp?ph=c6ee69d755" style="height:44px">
      <div id="mobileUser" class="muted"></div>
    </div>
    <div id="mobileDrawer" class="drawer hidden" aria-hidden="true"></div>

    <main class="main">
      <div class="topBar">
        <div style="display:flex;gap:12px;align-items:center">
          <img src="https://c6ee69d755.cbaul-cdnwnd.com/af0c9920a8129f9bf9a0921ecfe9d264/200000017-17b1717b1a/700/F1Resource-removebg-preview.webp?ph=c6ee69d755" class="siteLogo" alt="logo">
          <div>
            <h1 class="title">WELCOME</h1>
            <div class="muted">This is <strong>F1 Resource</strong> — use the navigation to access tools.</div>
          </div>
        </div>
        <div id="userStatus" class="muted"></div>
      </div>

      <!-- Views -->
      <section id="home" class="view active">
        <div class="card">
          <h2 style="margin:0">Home</h2>
          <div class="mutedBlock" style="margin-top:8px">Home intentionally displays no lists or sensitive data. Use the navigation to load each tool view.</div>
        </div>
      </section>

      <section id="departments" class="view">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>Fire Departments</strong><div class="muted">Click to view details. Use the Add button to create a department.</div></div>
            <div><button id="addDeptBtn" class="btn primary small">+ Add Department</button></div>
          </div>
          <div id="departmentsList" class="list"></div>
        </div>
      </section>

      <section id="ems" class="view">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>EMS Agencies</strong><div class="muted">Manage EMS agencies.</div></div>
            <div><button id="addEmsBtn" class="btn primary small">+ Add EMS</button></div>
          </div>
          <div id="emsList" class="list"></div>
        </div>
      </section>

      <section id="coordinators" class="view">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>County Coordinators</strong></div>
            <div><button id="addCoordBtn" class="btn primary small">+ Add</button></div>
          </div>
          <div id="coordList" class="list"></div>
        </div>
      </section>

      <section id="teams" class="view">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>County Teams &amp; Special Ops</strong></div>
            <div><button id="addTeamBtn" class="btn primary small">+ Add Team</button></div>
          </div>
          <div id="teamList" class="list"></div>
        </div>
      </section>

      <section id="hazmat" class="view">
        <div class="card">
          <h3 style="margin:0 0 8px">Hazardous Material Search</h3>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <input id="hazInput" placeholder="UN/NA number e.g. 1203" style="min-width:160px;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06)"/>
            <input id="placardInput" placeholder="Placard number (optional)" style="min-width:140px;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06)"/>
            <button id="hazSearchBtn" class="btn primary small">Search</button>
            <button id="hazAddBtn" class="btn ghost small">Admin Add/Edit</button>
          </div>
          <div id="hazResult" style="margin-top:12px"></div>
        </div>
      </section>

      <section id="ev" class="view">
        <div class="card">
          <h3 style="margin:0 0 8px">Electric Vehicle Safety</h3>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <input id="evPlate" placeholder="License Plate (optional)" style="padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06)"/>
            <input id="evVIN" placeholder="VIN (optional)" style="padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06)"/>
            <input id="evYMM" placeholder="Year,Make,Model (e.g. 2021,Tesla,Model 3)" style="flex:1;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06)"/>
            <button id="evSearchBtn" class="btn primary small">Find Vehicle</button>
          </div>
          <div id="evResult" style="margin-top:12px"></div>
        </div>
      </section>

      <section id="risks" class="view">
        <div class="card">
          <h3 style="margin:0 0 8px">Fire &amp; Driving Risk</h3>
          <div class="muted">Risk checklists and guidance (Admin editable).</div>
          <div id="riskBody" style="margin-top:12px"></div>
        </div>
      </section>

      <section id="weather" class="view">
        <div class="card">
          <h3 style="margin:0 0 8px">Weather</h3>
          <div class="muted">Active weather alerts for Oswego County</div>
          <div id="weatherAlerts" style="margin-top:12px" class="muted">Loading alerts...</div>
        </div>
      </section>

      <section id="admin" class="view">
        <div class="card">
          <h3 style="margin:0 0 8px">Admin</h3>
          <div class="muted">Manage HazMat entries, EV links, import CSVs, and local users.</div>
          <div style="display:flex;gap:8px;margin-top:12px">
            <button id="manageUsersBtn" class="btn primary">Manage Local Users</button>
            <button id="adminAddHaz" class="btn ghost">Add HazMat</button>
            <button id="adminAddEv" class="btn ghost">Add EV Link</button>
            <button id="importCsvBtn" class="btn ghost">Import CSV</button>
          </div>
          <div id="adminBody" style="margin-top:12px" class="muted"></div>
        </div>
      </section>

    </main>
  </div>

  <!-- modal -->
  <div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <h3 id="modalTitle"></h3>
      <div id="modalBody"></div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button id="modalCancel" class="btn ghost">Cancel</button>
        <button id="modalSave" class="btn primary">Save</button>
      </div>
    </div>
  </div>

  <script type="module">
    /*******************************************************************
     * Single-file SPA for F1 Resource using Firestore (Option 2)
     * - Root document: collection "f1root" (doc id "f1resource") OR use a single doc 'f1resource' under root.
     * - Subcollections under that document: fire_departments, ems_agencies, coordinators, county_teams, hazmat, ev_guides
     * - Local-only login (no Firebase Auth)
     *******************************************************************/

    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import {
      getFirestore, collection, doc, addDoc, setDoc, deleteDoc, getDoc,
      onSnapshot, query
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // ---------- FIREBASE CONFIG (your provided config) ----------
    const firebaseConfig = {
      apiKey: "AIzaSyBi0Xyljx7zzXTmyyRMAru11hZ2s5S3tsw",
      authDomain: "f1resource-8fedc.firebaseapp.com",
      projectId: "f1resource-8fedc",
      storageBucket: "f1resource-8fedc.firebasestorage.app",
      messagingSenderId: "182745701982",
      appId: "1:182745701982:web:9f4f3836b41b450987decf"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ---------- Root doc & subcollection helper ----------
    // We'll use a root doc 'f1resource' in collection 'f1root' (so doc path: f1root/f1resource).
    // All app data lives under this doc's subcollections.
    const ROOT_COL = 'f1root';
    const ROOT_DOC_ID = 'f1resource';

    function subColRef(name){
      return collection(db, ROOT_COL, ROOT_DOC_ID, name);
    }

    // ---------- Local login users ----------
    const LOCAL_USERS = {
      "ADMIN": { password: "ADMIN", role: "ADMIN" },
      "DEPTADMIN": { password: "DEPTADMIN", role: "DEPTADMIN", dept: null },
      "DEPTUSER": { password: "DEPTUSER", role: "DEPTUSER", dept: null }
    };

    // ---------- Small helpers ----------
    function el(id){ return document.getElementById(id); }
    function escapeHtml(s){ if(!s) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
    function saveSession(u){ localStorage.setItem('f1_user', JSON.stringify(u)); }
    function getSession(){ try{return JSON.parse(localStorage.getItem('f1_user')); }catch(e){return null;} }
    function clearSession(){ localStorage.removeItem('f1_user'); }
    function showLogin(){ el('loginView').style.display='flex'; el('spa').style.display='none'; }
    function showApp(){ el('loginView').style.display='none'; el('spa').style.display='flex'; }
    function setActiveView(id){
      document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
      const v = el(id); if(v) v.classList.add('active');
      document.querySelectorAll('.nav button[data-view]').forEach(b=> b.classList.toggle('active', b.dataset.view === id));
      // close mobile drawer
      const drawer = el('mobileDrawer'); if(drawer) drawer.classList.remove('open');
    }

    // modal
    const modalBackdrop = el('modalBackdrop'), modalTitle = el('modalTitle'), modalBody = el('modalBody'), modalSave = el('modalSave'), modalCancel = el('modalCancel');
    function showModal(title, buildContent, onSave){
      modalTitle.textContent = title;
      modalBody.innerHTML = '';
      buildContent(modalBody);
      modalBackdrop.classList.add('show');
      modalSave.onclick = async ()=>{ await onSave(); modalBackdrop.classList.remove('show'); modalBody.innerHTML=''; modalSave.onclick = null; };
      modalCancel.onclick = ()=>{ modalBackdrop.classList.remove('show'); modalBody.innerHTML=''; modalSave.onclick = null; };
    }

    // ---------- Session & permissions ----------
    let currentUser = null;
    function isAdmin(){ return currentUser && currentUser.role === 'ADMIN'; }
    function canEditDepartment(deptObj){
      if(!currentUser) return false;
      if(currentUser.role === 'ADMIN') return true;
      if(currentUser.role === 'DEPTADMIN' && currentUser.dept && deptObj && deptObj.name === currentUser.dept) return true;
      return false;
    }

    // ---------- Login handlers ----------
    el('loginFill').addEventListener('click', ()=>{ el('login_user').value='ADMIN'; el('login_pass').value='ADMIN'; });
    el('loginBtn').addEventListener('click', ()=>{
      const u = (el('login_user').value||'').trim().toUpperCase();
      const p = (el('login_pass').value||'').trim();
      if(!u||!p){ el('loginMsg').textContent = 'Enter username & password'; return; }
      const user = LOCAL_USERS[u];
      if(!user || user.password !== p){ el('loginMsg').textContent = 'Invalid credentials'; return; }
      currentUser = { username: u, role: user.role, dept: user.dept || null };
      saveSession(currentUser);
      bootApp();
    });

    el('logoutButton').addEventListener('click', ()=> { clearSession(); location.reload(); });

    // ---------- Firestore listeners to keep UI live ----------
    function watchSubCollection(name, renderFn){
      const q = query(subColRef(name));
      return onSnapshot(q, snap => {
        const out = {};
        snap.forEach(docSnap => out[docSnap.id] = docSnap.data());
        renderFn(out);
      }, err => console.error('watch error', name, err));
    }

    // UI containers
    const DEPT_LIST = el('departmentsList');
    const EMS_LIST = el('emsList');
    const COORD_LIST = el('coordList');
    const TEAM_LIST = el('teamList');
    const HAZ_RESULT = el('hazResult');
    const EV_RESULT = el('evResult');
    const HAZ_INPUT = el('hazInput');
    const WEATHER_ALERTS = el('weatherAlerts');

    // renderers
    function renderDepartments(data){
      DEPT_LIST.innerHTML = '';
      Object.entries(data||{}).forEach(([id,d])=>{
        const div = document.createElement('div'); div.className='listItem';
        div.innerHTML = `<div><div style="font-weight:800">${escapeHtml(d.name||'Unnamed')}</div><div class="meta">${escapeHtml(d.battalion||'')} ${d.address ? ' • '+escapeHtml(d.address):''}</div></div>
          <div style="display:flex;gap:8px">
            <button class="btn" data-id="${id}" data-act="view-dept">View</button>
            ${canEditDepartment(d) ? `<button class="btn" data-id="${id}" data-act="edit-dept">Edit</button><button class="btn ghost" data-id="${id}" data-act="del-dept">Delete</button>` : ''}
          </div>`;
        DEPT_LIST.appendChild(div);
      });
    }

    function renderEMS(data){
      EMS_LIST.innerHTML = '';
      Object.entries(data||{}).forEach(([id,e])=>{
        const div = document.createElement('div'); div.className='listItem';
        div.innerHTML = `<div><div style="font-weight:800">${escapeHtml(e.name||'Unnamed')}</div><div class="meta">${escapeHtml(e.address||'')}</div></div>
          <div><button class="btn" data-id="${id}" data-act="view-ems">View</button></div>`;
        EMS_LIST.appendChild(div);
      });
    }

    function renderCoordinators(data){
      COORD_LIST.innerHTML = '';
      Object.entries(data||{}).forEach(([id,c])=>{
        const div = document.createElement('div'); div.className='listItem';
        div.innerHTML = `<div><div style="font-weight:800">${escapeHtml(c.name||'')}</div><div class="meta">${escapeHtml(c.callsign||'')}</div></div>
          <div>${isAdmin() ? `<button class="btn" data-id="${id}" data-act="edit-coord">Edit</button>` : ''}</div>`;
        COORD_LIST.appendChild(div);
      });
    }

    function renderTeams(data){
      TEAM_LIST.innerHTML = '';
      Object.entries(data||{}).forEach(([id,t])=>{
        const div = document.createElement('div'); div.className='listItem';
        div.innerHTML = `<div><div style="font-weight:800">${escapeHtml(t.name||'')}</div><div class="meta">${escapeHtml(t.lead||'')}</div></div>
          <div>${isAdmin() ? `<button class="btn" data-id="${id}" data-act="edit-team">Edit</button>` : ''}</div>`;
        TEAM_LIST.appendChild(div);
      });
    }

    // ---------- CRUD wrappers ----------
    async function addToSub(colName, obj){
      await addDoc(subColRef(colName), obj);
    }
    async function setToSub(colName, id, obj){
      await setDoc(doc(subColRef(colName).path.split('/').slice(0,-1).join('/'), subColRef(colName).path.split('/').pop(), id), obj).catch(async ()=>{
        // fallback: direct set by doc()
        await setDoc(doc(db, ROOT_COL, ROOT_DOC_ID, colName, id), obj);
      });
    }
    async function deleteFromSub(colName, id){
      await deleteDoc(doc(db, ROOT_COL, ROOT_DOC_ID, colName, id));
    }
    async function getFromSub(colName, id){
      const d = await getDoc(doc(db, ROOT_COL, ROOT_DOC_ID, colName, id));
      return d.exists() ? d.data() : null;
    }

    // ---------- View actions wiring ----------
    el('addDeptBtn').addEventListener('click', ()=> {
      if(!currentUser || (currentUser.role !== 'ADMIN' && currentUser.role !== 'DEPTADMIN')) return alert('Permission denied');
      showModal('Add Fire Department', (root)=>{
        root.innerHTML = `
          <div style="display:flex;flex-direction:column;gap:8px">
            <input id="m_name" placeholder="Department name" />
            <input id="m_batt" placeholder="Battalion" />
            <input id="m_addr" placeholder="Address" />
            <input id="m_app" placeholder="Apparatus (use | to separate)" />
            <div class="muted">Example: Chief 101 | Engine 101</div>
          </div>`;
      }, async ()=> {
        const name = (el('m_name').value||'').trim()||'Unnamed';
        const batt = (el('m_batt').value||'').trim();
        const addr = (el('m_addr').value||'').trim();
        const app = (el('m_app').value||'').trim();
        await addToSub('fire_departments', { name, battalion: batt, address: addr, apparatus: app });
      });
    });

    DEPT_LIST.addEventListener('click', async (e)=>{
      const btn = e.target.closest('button'); if(!btn) return;
      const id = btn.dataset.id, act = btn.dataset.act;
      if(act === 'view-dept'){
        const d = await getFromSub('fire_departments', id);
        showModal(d.name || 'Department', (root)=>{
          const apps = (d.apparatus||'').split('|').map(s=>s.trim()).filter(Boolean).map(a=>`<div>• ${escapeHtml(a)}</div>`).join('');
          root.innerHTML = `<div style="display:flex;flex-direction:column;gap:8px">
            <div style="font-weight:800">${escapeHtml(d.name)}</div>
            <div class="meta">${escapeHtml(d.battalion||'')} ${d.address ? ' • '+escapeHtml(d.address):''}</div>
            <div style="margin-top:8px"><strong>Apparatus</strong><div style="margin-top:6px">${apps || '<div class="muted">No apparatus listed</div>'}</div></div>
            <div style="margin-top:8px"><strong>Notes</strong><div class="muted">${escapeHtml(d.notes||'')}</div></div>
          </div>`;
        }, async ()=>{});
      }
      if(act === 'edit-dept'){
        const d = await getFromSub('fire_departments', id);
        if(!canEditDepartment(d)) return alert('Permission denied.');
        showModal('Edit Department', (root)=>{
          root.innerHTML = `<div style="display:flex;flex-direction:column;gap:8px">
            <input id="m_name" value="${escapeHtml(d.name||'')}" placeholder="Department name" />
            <input id="m_batt" value="${escapeHtml(d.battalion||'')}" placeholder="Battalion" />
            <input id="m_addr" value="${escapeHtml(d.address||'')}" placeholder="Address" />
            <input id="m_app" value="${escapeHtml(d.apparatus||'')}" placeholder="Apparatus (| separated)" />
            <textarea id="m_notes" placeholder="Notes">${escapeHtml(d.notes||'')}</textarea>
          </div>`;
        }, async ()=>{
          const name = (el('m_name').value||'').trim()||'Unnamed';
          const batt = (el('m_batt').value||'').trim();
          const addr = (el('m_addr').value||'').trim();
          const app = (el('m_app').value||'').trim();
          const notes = (el('m_notes').value||'').trim();
          await setToSub('fire_departments', id, { name, battalion: batt, address: addr, apparatus: app, notes });
        });
      }
      if(act === 'del-dept'){
        if(!confirm('Delete department?')) return;
        await deleteFromSub('fire_departments', id);
      }
    });

    // EMS add
    el('addEmsBtn').addEventListener('click', ()=> {
      if(!currentUser || (currentUser.role !== 'ADMIN' && currentUser.role !== 'DEPTADMIN')) return alert('Permission denied');
      showModal('Add EMS Agency', (r)=> {
        r.innerHTML = `<div style="display:flex;flex-direction:column;gap:8px"><input id="m_name" placeholder="Name"/><input id="m_addr" placeholder="Address"/><input id="m_app" placeholder="Apparatus (| separated)"/></div>`;
      }, async ()=> {
        const name = (el('m_name').value||'').trim()||'Unnamed';
        const addr = (el('m_addr').value||'').trim()||'';
        const app = (el('m_app').value||'').trim()||'';
        await addToSub('ems_agencies', { name, address: addr, apparatus: app });
      });
    });

    // Add coordinator
    el('addCoordBtn').addEventListener('click', ()=> {
      if(!currentUser || (currentUser.role !== 'ADMIN' && currentUser.role !== 'DEPTADMIN')) return alert('Permission denied');
      showModal('Add Coordinator', (r)=> {
        r.innerHTML = `<div style="display:flex;flex-direction:column;gap:8px"><input id="m_name" placeholder="Name"/><input id="m_callsign" placeholder="Callsign"/></div>`;
      }, async ()=> {
        const name = (el('m_name').value||'').trim(); const callsign = (el('m_callsign').value||'').trim();
        if(!name) return alert('Enter a name');
        await addToSub('coordinators', { name, callsign });
      });
    });

    // Add team
    el('addTeamBtn').addEventListener('click', ()=> {
      if(!currentUser || (currentUser.role !== 'ADMIN' && currentUser.role !== 'DEPTADMIN')) return alert('Permission denied');
      showModal('Add County Team', (r)=> {
        r.innerHTML = `<div style="display:flex;flex-direction:column;gap:8px"><input id="m_name" placeholder="Team name"/><input id="m_lead" placeholder="Lead"/><input id="m_caps" placeholder="Capabilities (| separated)"/></div>`;
      }, async ()=> {
        const name = (el('m_name').value||'').trim()||'Unnamed';
        const lead = (el('m_lead').value||'').trim()||'';
        const caps = (el('m_caps').value||'').trim()||'';
        await addToSub('county_teams', { name, lead, capabilities: caps });
      });
    });

    // HazMat search & admin add
    el('hazSearchBtn').addEventListener('click', async ()=>{
      const q = (el('hazInput').value||'').trim();
      if(!q) return alert('Enter UN number');
      // Try doc id first (we store UN entries with ID = un when added)
      const d = await getFromSub('hazmat', q);
      if(d){ renderHazmat(d); return; }
      // fallback: read entire subcollection and search by 'un' field
      const found = [];
      // do snapshot once (not efficient for big DB)
      // (we use live watchers elsewhere for admin)
      const qSnap = await (async ()=>{
        // simple quick approach: read all documents by watching snapshot once is not available — instead use a get via the root
        // We'll call watchSubCollection to render; for search we can rely on doc ID method.
        return null;
      })();
      if(!d) el('hazResult').innerHTML = `<div class="muted">No record found for UN ${escapeHtml(q)}</div>`;
    });

    el('hazAddBtn').addEventListener('click', ()=> {
      if(!isAdmin()) return alert('Admin only');
      showModal('Add HazMat entry', (r)=> {
        r.innerHTML = `<div style="display:flex;flex-direction:column;gap:8px">
          <input id="m_un" placeholder="UN number"/>
          <input id="m_name" placeholder="Common name"/>
          <input id="m_class" placeholder="Hazard class"/>
          <input id="m_flame" placeholder="Flammability"/>
          <input id="m_water" placeholder="Water reactivity"/>
          <input id="m_agent" placeholder="Recommended extinguishing agent"/>
          <textarea id="m_notes" placeholder="Notes / response tips"></textarea>
        </div>`;
      }, async ()=> {
        const un = (el('m_un').value||'').trim(); if(!un) return alert('Enter UN number');
        const name = (el('m_name').value||'').trim()||'';
        const hazard_class = (el('m_class').value||'').trim()||'';
        const flammability = (el('m_flame').value||'').trim()||'';
        const water_reactivity = (el('m_water').value||'').trim()||'';
        const extinguishing_agent = (el('m_agent').value||'').trim()||'';
        const notes = (el('m_notes').value||'').trim()||'';
        // Store with doc id = un under subcollection 'hazmat'
        await setDoc(doc(db, ROOT_COL, ROOT_DOC_ID, 'hazmat', un), { un, name, hazard_class, flammability, water_reactivity, extinguishing_agent, notes });
      });
    });

    function renderHazmat(entry){
      HAZ_RESULT.innerHTML = `<div style="font-weight:800">${escapeHtml(entry.name || 'Unknown')} (UN ${escapeHtml(entry.un || '')})</div>
        <div class="muted" style="margin-top:6px">${escapeHtml(entry.hazard_class || '')}</div>
        <div style="margin-top:8px"><strong>Flammability / Fire Hazards:</strong> ${escapeHtml(entry.flammability||'—')}</div>
        <div><strong>Water reactivity / behavior:</strong> ${escapeHtml(entry.water_reactivity||'—')}</div>
        <div><strong>Recommended extinguishing agent:</strong> ${escapeHtml(entry.extinguishing_agent||'—')}</div>
        <div style="margin-top:8px"><strong>Response notes:</strong><div class="muted">${escapeHtml(entry.notes||'—')}</div></div>`;
    }

    // EV: admin add link & search by key (make -> doc id)
    el('adminAddEv').addEventListener('click', ()=> {
      if(!isAdmin()) return alert('Admin only');
      showModal('Add EV guide', (r)=> {
        r.innerHTML = `<div style="display:flex;flex-direction:column;gap:8px"><input id="m_make" placeholder="Make (e.g. Tesla)"/><input id="m_url" placeholder="Guide URL"/></div>`;
      }, async ()=> {
        const make = (el('m_make').value||'').trim(); const url = (el('m_url').value||'').trim();
        if(!make||!url) return alert('Enter both fields');
        const key = make.toLowerCase().replace(/\s+/g,'_');
        await setDoc(doc(db, ROOT_COL, ROOT_DOC_ID, 'ev_guides', key), { make, url });
      });
    });

    el('evSearchBtn').addEventListener('click', async ()=> {
      const ymm = (el('evYMM').value||'').trim();
      if(!ymm) return alert('Enter Year,Make,Model (e.g. 2021,Tesla,Model 3)');
      const parts = ymm.split(',').map(s=>s.trim());
      const make = (parts[1] || parts[0]).toLowerCase().replace(/\s+/g,'_');
      const docRef = doc(db, ROOT_COL, ROOT_DOC_ID, 'ev_guides', make);
      const d = await getDoc(docRef);
      if(d.exists()){
        const data = d.data();
        EV_RESULT.innerHTML = `<div style="font-weight:800">${escapeHtml(data.make)} ${escapeHtml(parts[2]||'')} ${escapeHtml(parts[0]||'')}</div><div style="margin-top:8px"><a href="${escapeHtml(data.url)}" target="_blank">${escapeHtml(data.url)}</a></div>`;
      } else {
        EV_RESULT.innerHTML = `<div class="muted">Manufacturer guide not found for '${escapeHtml(make)}'. Admin can add guides in Admin → Add EV Link.</div>`;
      }
    });

    // Admin: manage local users
    el('manageUsersBtn').addEventListener('click', ()=> {
      if(!isAdmin()) return alert('Admin only');
      showModal('Manage Local Users', (r)=> {
        r.innerHTML = `<div style="display:flex;flex-direction:column;gap:8px">
          <div class="muted">Local users stored in app config. Add/update demo users here.</div>
          <input id="lu_name" placeholder="Username (uppercase)"/>
          <input id="lu_pass" placeholder="Password"/>
          <select id="lu_role"><option>ADMIN</option><option>DEPTADMIN</option><option>DEPTUSER</option></select>
          <input id="lu_dept" placeholder="Department (for DEPTADMIN only)"/>
          <div style="display:flex;gap:8px"><button id="luAdd" class="btn primary">Add / Update User</button></div>
        </div>`;
        r.querySelector('#luAdd').addEventListener('click', ()=> {
          const u = (el('lu_name').value||'').trim().toUpperCase();
          const p = (el('lu_pass').value||'').trim();
          const role = r.querySelector('#lu_role').value;
          const dept = (el('lu_dept').value||'').trim();
          if(!u||!p) return alert('Enter username & password');
          LOCAL_USERS[u] = { password: p, role, dept: dept||null };
          alert('User saved locally. (Local users persist only in deployed code; to persist centrally, we can store users in Firestore.)');
        });
      }, async ()=>{});
    });

    el('importCsvBtn').addEventListener('click', ()=> {
      if(!isAdmin()) return alert('Admin only');
      alert('CSV import: provide a CSV and I will wire an import routine. (Available on request)');
    });

    // ---------- Watch subcollections (live UI) ----------
    watchSubCollection('fire_departments', renderDepartments);
    watchSubCollection('ems_agencies', renderEMS);
    watchSubCollection('coordinators', renderCoordinators);
    watchSubCollection('county_teams', renderTeams);
    // watch hazmat & ev_guides too so admin additions reflect quickly
    watchSubCollection('hazmat', ()=>{ /* no-op UI until search used */ });
    watchSubCollection('ev_guides', ()=>{ /* no-op */ });

    // ---------- Weather alerts (NWS) ----------
    async function fetchWeatherAlerts(){
      try{
        const r = await fetch('https://api.weather.gov/alerts/active?area=OSW');
        const json = await r.json();
        if(json && Array.isArray(json.features) && json.features.length){
          weatherAlerts.textContent = json.features.map(f => `${f.properties.event} — ${f.properties.areaDesc}`).join('\\n\\n');
        } else weatherAlerts.textContent = 'No active alerts';
      } catch(e){
        weatherAlerts.textContent = 'Weather service unavailable';
      }
    }
    fetchWeatherAlerts();

    // ---------- Boot app from session ----------
    function bootApp(){
      const s = getSession();
      if(!s){ showLogin(); return; }
      currentUser = s;
      showApp();
      setActiveView('home');
      el('userStatus').textContent = `${currentUser.username} — ${currentUser.role}${currentUser.dept? ' • '+currentUser.dept:''}`;
      // mobile header logic
      if(window.innerWidth <= 980){
        document.getElementById('mobileHeader').classList.remove('hidden'); document.getElementById('mobileHeader').style.display='flex';
        try{ document.querySelector('.sidebar').style.display='none'; }catch(e){}
        const drawer = el('mobileDrawer'); if(drawer){ drawer.classList.remove('hidden'); drawer.innerHTML = document.querySelector('.nav').outerHTML; drawer.querySelectorAll('button').forEach(b=>{
          b.addEventListener('click', ()=> { setActiveView(b.dataset.view); drawer.classList.remove('open'); });
        }); }
        el('mobileToggle')?.addEventListener('click', ()=> { el('mobileDrawer').classList.toggle('open'); });
      }
    }

    // wire nav desktop
    document.querySelectorAll('.nav button[data-view]').forEach(b=>{
      b.addEventListener('click', ()=> setActiveView(b.dataset.view));
    });

    // restore or show login
    if(getSession()) bootApp(); else showLogin();

    // ESC closes modal
    document.addEventListener('keydown', e => { if(e.key === 'Escape') modalBackdrop.classList.remove('show'); });

  </script>
</body>
</html>

