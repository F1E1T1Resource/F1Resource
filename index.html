<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>F1 Resource — Oswego County</title>
  <meta name="description" content="F1 Resource - Fire & EMS resource hub" />
  <style>
    /* ===== Shared styles & theme (auto light/dark) ===== */
    :root{
      --accent1: #0b5fff;
      --accent2: #9b5cff;
      --bgLight: #f5f7fb;
      --bgLight2: #eef2f7;
      --bgDark: #0b0c10;
      --mutedLight: #4b5563;
      --mutedDark: #cbd5e1;
      --cardBlur: rgba(255,255,255,0.02);
      --radius: 12px;
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg: var(--bgDark);
        --text: #f7f7fb;
        --muted: var(--mutedDark);
      }
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg: linear-gradient(180deg,var(--bgLight),var(--bgLight2));
        --text: #0b1220;
        --muted: var(--mutedLight);
      }
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--text);background:var(--bg)}
    a{color:inherit}
    /* layout */
    .app{display:flex;min-height:100vh}
    .sidebar{width:220px;padding:18px;flex-shrink:0;display:flex;flex-direction:column;gap:12px;border-right:1px solid rgba(0,0,0,0.04);background:transparent}
    .logoWrap{display:flex;align-items:center;gap:12px}
    .logoImg{height:44px;width:auto;border-radius:8px}
    .appTitle{font-weight:800;font-size:16px}
    .nav{display:flex;flex-direction:column;gap:6px;margin-top:8px}
    .nav button{background:transparent;border:none;text-align:left;padding:10px 12px;border-radius:8px;font-weight:700;color:var(--muted);cursor:pointer}
    .nav button.active, .nav button:hover{background:linear-gradient(90deg,rgba(11,95,255,0.08),rgba(155,92,255,0.06));color:var(--text);transform:translateX(2px)}
    .main{flex:1;display:flex;flex-direction:column;gap:18px;padding:22px}
    .topBar{display:flex;justify-content:space-between;align-items:center}
    .siteLogo{height:60px;border-radius:10px}
    .title{font-size:22px;margin:0}
    .muted{color:var(--muted);font-size:13px}
    .card{background:var(--cardBlur);padding:16px;border-radius:var(--radius);box-shadow:0 10px 30px rgba(0,0,0,0.06);border:1px solid rgba(0,0,0,0.03)}
    /* pages */
    .view{display:none}
    .view.active{display:block}
    .list{display:flex;flex-direction:column;gap:10px;margin-top:12px}
    .listItem{display:flex;justify-content:space-between;align-items:center;background:rgba(255,255,255,0.02);padding:12px;border-radius:10px;border:1px solid rgba(0,0,0,0.03)}
    .meta{color:var(--muted);font-size:12px}
    .btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:700}
    .btn.primary{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#fff}
    .btn.ghost{background:transparent;border:1px solid rgba(0,0,0,0.06);color:var(--muted)}
    /* modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:999;backdrop-filter:blur(4px)}
    .modal-backdrop.show{display:flex}
    .modal{width:720px;max-width:96%;max-height:86vh;overflow:auto;border-radius:12px;padding:18px;background:var(--cardBlur);border:1px solid rgba(0,0,0,0.06)}
    .modal input,.modal textarea,.modal select{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);background:transparent;color:var(--text)}
    /* responsive: mobile topbar + drawer */
    @media (max-width:980px){
      .sidebar{display:none}
      .mobileTop{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid rgba(0,0,0,0.04);background:transparent}
      .mobileMenu{background:transparent;border:none;font-weight:800;padding:8px;border-radius:8px;cursor:pointer}
      .drawer{position:fixed;left:0;top:0;height:100%;width:260px;background:var(--cardBlur);box-shadow:6px 0 28px rgba(0,0,0,0.3);transform:translateX(-120%);transition:transform .22s;z-index:1000;padding:18px}
      .drawer.open{transform:translateX(0)}
    }
    /* small helpers */
    .row{display:flex;gap:8px;align-items:center}
    .small{padding:6px 8px;font-size:13px;border-radius:8px}
    .mutedBlock{color:var(--muted);font-size:13px}
    .hidden{display:none}
  </style>
</head>
<body>
  <div id="appRoot">
    <!-- Login screen modal-like centered -->
    <div id="loginView" style="display:flex;align-items:center;justify-content:center;min-height:100vh;padding:20px">
      <div class="card" style="max-width:820px;width:100%;display:flex;gap:18px;align-items:center">
        <img id="logoImg" src="/mnt/data/F1Resource-removebg-preview.png" alt="logo" class="logoImg" style="height:96px">
        <div style="flex:1">
          <h2 style="margin:0">F1 Resource — Login</h2>
          <p class="muted">Local login (Admin / Department Admin / Department User). Data stored in Firestore; login remains local for simplicity.</p>
          <div style="margin-top:12px;display:flex;gap:8px;flex-direction:column">
            <input id="login_user" placeholder="Username" />
            <input id="login_pass" type="password" placeholder="Password" />
            <div style="display:flex;gap:8px">
              <button id="loginBtn" class="btn primary">Login</button>
              <button id="loginFill" class="btn ghost">Demo (fill)</button>
            </div>
            <div id="loginMsg" class="muted" style="color:crimson"></div>
          </div>
          <p class="muted" style="margin-top:10px">Demo local accounts: <strong>ADMIN / ADMIN</strong>, <strong>DEPTADMIN / DEPTADMIN</strong>, <strong>DEPTUSER / DEPTUSER</strong></p>
        </div>
      </div>
    </div>

    <!-- SPA root -->
    <div id="spa" class="app hidden" style="display:none">
      <!-- sidebar (desktop) -->
      <aside class="sidebar" role="navigation" aria-label="Main navigation">
        <div class="logoWrap"><img id="logoSidebar" src="/mnt/data/F1Resource-removebg-preview.png" class="logoImg" alt="logo"><div><div class="appTitle">F1 Resource</div><div class="muted">Oswego County</div></div></div>
        <nav class="nav" id="navButtons" aria-label="Pages">
          <button data-view="home" class="active">HOME</button>
          <button data-view="departments">FIRE DEPARTMENTS</button>
          <button data-view="ems">EMS AGENCIES</button>
          <button data-view="coordinators">COUNTY COORDINATORS</button>
          <button data-view="teams">COUNTY TEAMS</button>
          <button data-view="hazmat">HAZMAT SEARCH</button>
          <button data-view="ev">EV SAFETY</button>
          <button data-view="risks">FIRE &amp; DRIVING RISK</button>
          <button data-view="weather">WEATHER</button>
          <button data-view="admin">ADMIN</button>
          <button id="logoutButton">LOGOUT</button>
        </nav>
        <div style="margin-top:auto" class="muted">Version 1.0</div>
      </aside>

      <!-- mobile header -->
      <div id="mobileHeader" class="mobileTop hidden" style="display:none">
        <button id="mobileToggle" class="mobileMenu">MENU</button>
        <img src="/mnt/data/F1Resource-removebg-preview.png" style="height:44px">
        <div id="mobileUser" class="muted"></div>
      </div>

      <!-- drawer for mobile -->
      <div id="mobileDrawer" class="drawer hidden" aria-hidden="true">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
          <img src="/mnt/data/F1Resource-removebg-preview.png" style="height:44px;border-radius:8px">
          <div><div style="font-weight:800">F1 Resource</div><div class="muted">Oswego County</div></div>
        </div>
        <nav style="display:flex;flex-direction:column;gap:8px">
          <!-- will be cloned -->
        </nav>
      </div>

      <!-- main area -->
      <main class="main">
        <div class="topBar">
          <div style="display:flex;gap:12px;align-items:center">
            <img src="/mnt/data/F1Resource-removebg-preview.png" class="siteLogo" alt="logo">
            <div>
              <h1 class="title">WELCOME</h1>
              <div class="muted">This is <strong>F1 Resource</strong>, your all inclusive application for the resources in Oswego County.</div>
            </div>
          </div>
          <div id="userStatus" class="muted"></div>
        </div>

        <!-- Views -->
        <section id="home" class="view active">
          <div class="card">
            <h2 style="margin:0">Home</h2>
            <div class="mutedBlock" style="margin-top:8px">This page intentionally shows no lists or sensitive data. Use the left navigation to access departmental pages and tools.</div>
          </div>
        </section>

        <section id="departments" class="view">
          <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div><strong>Fire Departments</strong><div class="muted">Add and manage fire departments. Clicking a department opens a detail view.</div></div>
              <div><button id="addDeptBtn" class="btn primary small">+ Add Department</button></div>
            </div>
            <div id="departmentsList" class="list"></div>
          </div>
        </section>

        <section id="ems" class="view">
          <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div><strong>EMS Agencies</strong><div class="muted">Manage EMS agency records.</div></div>
              <div><button id="addEmsBtn" class="btn primary small">+ Add EMS</button></div>
            </div>
            <div id="emsList" class="list"></div>
          </div>
        </section>

        <section id="coordinators" class="view">
          <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div><strong>County Coordinators</strong><div class="muted">Calls signs and contact info.</div></div>
              <div><button id="addCoordBtn" class="btn primary small">+ Add</button></div>
            </div>
            <div id="coordList" class="list"></div>
          </div>
        </section>

        <section id="teams" class="view">
          <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div><strong>County Teams &amp; Special Ops</strong><div class="muted">HazMat, Dive, Tech Rescue, Investigations</div></div>
              <div><button id="addTeamBtn" class="btn primary small">+ Add Team</button></div>
            </div>
            <div id="teamList" class="list"></div>
          </div>
        </section>

        <section id="hazmat" class="view">
          <div class="card">
            <h3 style="margin:0 0 8px">Hazardous Material Search</h3>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <input id="hazInput" placeholder="UN/NA number e.g. 1203" style="min-width:160px;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06)"/>
              <input id="placardInput" placeholder="Placard number (optional)" style="min-width:140px;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06)"/>
              <button id="hazSearchBtn" class="btn primary small">Search</button>
              <button id="hazAddBtn" class="btn ghost small">Admin Add/Edit</button>
            </div>
            <div id="hazResult" style="margin-top:12px"></div>
          </div>
        </section>

        <section id="ev" class="view">
          <div class="card">
            <h3 style="margin:0 0 8px">Electric Vehicle Safety</h3>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <input id="evPlate" placeholder="License Plate (optional)" style="padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06)"/>
              <input id="evVIN" placeholder="VIN (optional)" style="padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06)"/>
              <input id="evYMM" placeholder="Year,Make,Model (e.g. 2021,Tesla,Model 3)" style="flex:1;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06)"/>
              <button id="evSearchBtn" class="btn primary small">Find Vehicle</button>
            </div>
            <div id="evResult" style="margin-top:12px"></div>
          </div>
        </section>

        <section id="risks" class="view">
          <div class="card">
            <h3 style="margin:0 0 8px">Fire &amp; Driving Risk</h3>
            <div class="muted">Risk checklists and guidance (editable by Admin).</div>
            <div id="riskBody" style="margin-top:12px"></div>
          </div>
        </section>

        <section id="weather" class="view">
          <div class="card">
            <h3 style="margin:0 0 8px">Weather</h3>
            <div class="muted">Active weather alerts for Oswego County will be shown below.</div>
            <div id="weatherAlerts" style="margin-top:12px" class="muted">Loading alerts...</div>
          </div>
        </section>

        <section id="admin" class="view">
          <div class="card">
            <h3 style="margin:0 0 8px">Admin</h3>
            <div class="muted">Manage HazMat entries, EV links, import CSVs, and local user info.</div>
            <div style="display:flex;gap:8px;margin-top:12px">
              <button id="manageUsersBtn" class="btn primary">Manage Local Users</button>
              <button id="adminAddHaz" class="btn ghost">Add HazMat</button>
              <button id="adminAddEv" class="btn ghost">Add EV Link</button>
              <button id="importCsvBtn" class="btn ghost">Import CSV</button>
            </div>
            <div id="adminBody" style="margin-top:12px" class="muted"></div>
          </div>
        </section>

      </main>
    </div>

    <!-- Modal (single shared modal) -->
    <div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true">
      <div class="modal">
        <h3 id="modalTitle"></h3>
        <div id="modalBody"></div>
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
          <button id="modalCancel" class="btn ghost">Cancel</button>
          <button id="modalSave" class="btn primary">Save</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
  /********************************************************************
   * F1 Resource SPA (single file)
   * - Firestore for data storage (real-time onSnapshot)
   * - Local-only login system
   * - Views: home, departments, ems, coordinators, teams, hazmat, ev, risks, weather, admin
   ********************************************************************/

  /* ----------------- Firebase (Firestore) initialization ----------------- */
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getFirestore, collection, doc, getDoc, getDocs, setDoc, addDoc, deleteDoc, onSnapshot, query } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

  // <-- USER PROVIDED CONFIG (YOUR FIREBASE) -->
  const firebaseConfig = {
    apiKey: "AIzaSyBi0Xyljx7zzXTmyyRMAru11hZ2s5S3tsw",
    authDomain: "f1resource-8fedc.firebaseapp.com",
    // databaseURL is present but Firestore uses projectId / etc.
    projectId: "f1resource-8fedc",
    storageBucket: "f1resource-8fedc.firebasestorage.app",
    messagingSenderId: "182745701982",
    appId: "1:182745701982:web:9f4f3836b41b450987decf"
  };
  const firebaseApp = initializeApp(firebaseConfig);
  const db = getFirestore(firebaseApp);

  /* ----------------- Local login users (kept client-side intentionally) ----------------- */
  const LOCAL_USERS = {
    "ADMIN": { password: "ADMIN", role: "ADMIN" },
    "DEPTADMIN": { password: "DEPTADMIN", role: "DEPTADMIN", dept: null }, // set dept after login if desired
    "DEPTUSER": { password: "DEPTUSER", role: "DEPTUSER", dept: null }
  };

  /* ----------------- Helpers & UI wiring ----------------- */
  const loginView = document.getElementById('loginView');
  const spa = document.getElementById('spa');
  const loginBtn = document.getElementById('loginBtn');
  const loginFill = document.getElementById('loginFill');
  const loginMsg = document.getElementById('loginMsg');
  const logoutButton = document.getElementById('logoutButton');
  const userStatus = document.getElementById('userStatus');
  const modalBackdrop = document.getElementById('modalBackdrop');
  const modalTitle = document.getElementById('modalTitle');
  const modalBody = document.getElementById('modalBody');
  const modalSave = document.getElementById('modalSave');
  const modalCancel = document.getElementById('modalCancel');
  const navButtons = document.querySelectorAll('.nav button[data-view]');
  const mobileToggle = document.getElementById('mobileToggle');
  const mobileDrawer = document.getElementById('mobileDrawer');

  function saveSession(user) { localStorage.setItem('f1_user', JSON.stringify(user)); }
  function clearSession(){ localStorage.removeItem('f1_user'); }
  function getSession(){ try{ return JSON.parse(localStorage.getItem('f1_user')); }catch(e){return null;} }

  function showLogin(){ loginView.style.display='flex'; spa.style.display='none'; }
  function showApp(){ loginView.style.display='none'; spa.style.display='flex'; }

  function setActiveView(id){
    document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
    const el = document.getElementById(id);
    if(el) el.classList.add('active');
    // update nav active
    document.querySelectorAll('.nav button[data-view]').forEach(b=> b.classList.toggle('active', b.dataset.view === id));
    // close mobile drawer if open
    if(mobileDrawer) mobileDrawer.classList.remove('open');
    // make sure home shows no lists
  }

  function showModal(title, buildContent, onSave){
    modalTitle.textContent = title;
    modalBody.innerHTML = '';
    buildContent(modalBody);
    modalBackdrop.classList.add('show');
    modalSave.onclick = async ()=>{ await onSave(); modalBackdrop.classList.remove('show'); modalBody.innerHTML=''; modalSave.onclick = null; };
    modalCancel.onclick = ()=> { modalBackdrop.classList.remove('show'); modalBody.innerHTML=''; modalSave.onclick = null; };
  }

  // parse apparatus string "Chief 101 | Engine 101" => array
  function parseApparatus(s){
    if(!s) return [];
    return s.split('|').map(x=>x.trim()).filter(Boolean);
  }

  /* ----------------- Login handlers ----------------- */
  loginFill.addEventListener('click', ()=> {
    document.getElementById('login_user').value = 'ADMIN';
    document.getElementById('login_pass').value = 'ADMIN';
  });

  loginBtn.addEventListener('click', ()=> {
    const u = document.getElementById('login_user').value.trim().toUpperCase();
    const p = document.getElementById('login_pass').value.trim();
    if(!u||!p){ loginMsg.textContent = 'Enter username and password'; return; }
    const user = LOCAL_USERS[u];
    if(!user || user.password !== p){ loginMsg.textContent = 'Invalid credentials'; return; }
    const session = { username: u, role: user.role, dept: user.dept || null };
    saveSession(session);
    bootApp();
  });

  function logout(){
    clearSession();
    location.reload();
  }
  if(logoutButton) logoutButton.addEventListener('click', logout);

  /* ----------------- Firestore listeners & UI renderers ----------------- */
  // Collections:
  // departments, ems, coordinators, countyTeams, hazmatDB, evLinks

  // Keep references to unsubscribe functions to manage live listeners
  const unsubscribers = {};

  function watchCollection(colName, onChange){
    const q = query(collection(db, colName));
    const unsub = onSnapshot(q, (snap) => {
      const data = {};
      snap.forEach(docSnap => data[docSnap.id] = docSnap.data());
      onChange(data);
    }, (err)=> console.error('watch error',colName,err));
    unsubscribers[colName] = unsub;
  }

  // UI containers
  const departmentsList = document.getElementById('departmentsList');
  const emsList = document.getElementById('emsList');
  const coordList = document.getElementById('coordList');
  const teamList = document.getElementById('teamList');
  const hazResult = document.getElementById('hazResult');
  const evResult = document.getElementById('evResult');
  const hazInput = document.getElementById('hazInput');
  const weatherAlerts = document.getElementById('weatherAlerts');

  // Department list render
  function renderDepartments(data){
    departmentsList.innerHTML = '';
    Object.entries(data||{}).forEach(([id, d])=>{
      const div = document.createElement('div'); div.className='listItem';
      div.innerHTML = `<div><div style="font-weight:800">${escapeHtml(d.name||'Unnamed')}</div><div class="meta">${escapeHtml(d.battalion||'')} ${d.address? ' • '+escapeHtml(d.address):''}</div></div>
        <div style="display:flex;gap:8px">
          <button class="btn" data-id="${id}" data-act="view">View</button>
          ${canEditDepartment(d) ? `<button class="btn" data-id="${id}" data-act="edit">Edit</button><button class="btn ghost" data-id="${id}" data-act="delete">Delete</button>` : ''}
        </div>`;
      departmentsList.appendChild(div);
    });
  }

  // EMS render
  function renderEMS(data){
    emsList.innerHTML = '';
    Object.entries(data||{}).forEach(([id, e])=>{
      const div = document.createElement('div'); div.className='listItem';
      div.innerHTML = `<div><div style="font-weight:800">${escapeHtml(e.name||'Unnamed')}</div><div class="meta">${escapeHtml(e.address||'')}</div></div>
        <div><button class="btn" data-id="${id}" data-act="view-ems">View</button></div>`;
      emsList.appendChild(div);
    });
  }

  // Coordinators
  function renderCoordinators(data){
    coordList.innerHTML = '';
    Object.entries(data||{}).forEach(([id, c])=>{
      const div = document.createElement('div'); div.className='listItem';
      div.innerHTML = `<div><div style="font-weight:800">${escapeHtml(c.name||'')}</div><div class="meta">${escapeHtml(c.callsign||'')}</div></div>
        <div>${currentUser.role === 'ADMIN' ? `<button class="btn" data-id="${id}" data-act="edit-coord">Edit</button>` : ''}</div>`;
      coordList.appendChild(div);
    });
  }

  // County teams
  function renderTeams(data){
    teamList.innerHTML = '';
    Object.entries(data||{}).forEach(([id,t])=>{
      const div = document.createElement('div'); div.className='listItem';
      div.innerHTML = `<div><div style="font-weight:800">${escapeHtml(t.name||'')}</div><div class="meta">${escapeHtml(t.lead||'')}</div></div>
        <div>${currentUser.role === 'ADMIN' ? `<button class="btn" data-id="${id}" data-act="edit-team">Edit</button>` : ''}</div>`;
      teamList.appendChild(div);
    });
  }

  /* ----------------- Permission helpers ----------------- */
  let currentUser = null;
  function canEditDepartment(deptObj){
    if(!currentUser) return false;
    if(currentUser.role === 'ADMIN') return true;
    if(currentUser.role === 'DEPTADMIN' && currentUser.dept && deptObj.name === currentUser.dept) return true;
    return false;
  }
  function isAdmin(){ return currentUser && currentUser.role === 'ADMIN'; }

  /* ----------------- Wiring view navigation (desktop + mobile) ----------------- */
  document.querySelectorAll('.nav button[data-view]').forEach(btn=>{
    btn.addEventListener('click', ()=> {
      const view = btn.dataset.view;
      setActiveView(view);
    });
  });

  // mobile drawer wiring
  if(mobileToggle){
    mobileToggle.addEventListener('click', ()=> mobileDrawer.classList.toggle('open'));
    // clone nav to drawer
    const mobileNav = mobileDrawer.querySelector('nav');
    document.querySelectorAll('.nav button[data-view]').forEach(b=>{
      const clone = b.cloneNode(true);
      clone.addEventListener('click', ()=> {
        setActiveView(clone.dataset.view);
        mobileDrawer.classList.remove('open');
      });
      mobileNav.appendChild(clone);
    });
  }

  /* ----------------- CRUD helpers using Firestore ----------------- */
  async function addDocument(colName, obj){
    await addDoc(collection(db, colName), obj);
  }
  async function setDocument(colName, id, obj){
    await setDoc(doc(db, colName, id), obj);
  }
  async function deleteDocument(colName, id){
    await deleteDoc(doc(db, colName, id));
  }
  async function getDocument(colName, id){
    const d = await getDoc(doc(db, colName, id));
    return d.exists() ? d.data() : null;
  }
  async function getCollectionOnce(colName){
    const snap = await getDocs(collection(db, colName));
    const out = {};
    snap.forEach(docSnap => out[docSnap.id] = docSnap.data());
    return out;
  }

  /* ----------------- View-specific actions ----------------- */
  // Add Department modal
  document.getElementById('addDeptBtn').addEventListener('click', ()=> {
    if(!currentUser || (currentUser.role !== 'ADMIN' && currentUser.role !== 'DEPTADMIN')) return alert('Permission denied');
    showModal('Add Fire Department', (root)=>{
      root.innerHTML = `
        <div style="display:flex;flex-direction:column;gap:8px">
          <input id="m_name" placeholder="Department name" />
          <input id="m_batt" placeholder="Battalion" />
          <input id="m_addr" placeholder="Address" />
          <input id="m_app" placeholder="Apparatus (use | to separate)" />
          <div class="muted">Example apparatus: Chief 101 | Engine 101</div>
        </div>`;
    }, async ()=> {
      const name = document.getElementById('m_name').value.trim() || 'Unnamed';
      const batt = document.getElementById('m_batt').value.trim();
      const addr = document.getElementById('m_addr').value.trim();
      const app = document.getElementById('m_app').value.trim();
      await addDocument('departments', { name, battalion: batt, address: addr, apparatus: app });
    });
  });

  // Departments list actions (delegate)
  departmentsList.addEventListener('click', async (e)=>{
    const btn = e.target.closest('button'); if(!btn) return;
    const id = btn.dataset.id; const act = btn.dataset.act;
    if(act === 'view'){
      // open modal showing full department (read-only except for permitted edits)
      const data = await getDocument('departments', id);
      showModal(data.name || 'Department', (root)=>{
        const apps = parseApparatus(data.apparatus||'').map(a=>`<div>• ${escapeHtml(a)}</div>`).join('');
        root.innerHTML = `<div style="display:flex;flex-direction:column;gap:8px">
          <div style="font-weight:800">${escapeHtml(data.name)}</div>
          <div class="meta">${escapeHtml(data.battalion||'')} ${data.address ? ' • '+escapeHtml(data.address):''}</div>
          <div style="margin-top:8px"><strong>Apparatus</strong><div style="margin-top:6px">${apps || '<div class="muted">No apparatus listed</div>'}</div></div>
          <div style="margin-top:8px"><strong>Notes</strong><div class="muted">${escapeHtml(data.notes||'')}</div></div>
        </div>`;
      }, async ()=> {});
    }
    if(act === 'edit'){
      // edit only for permitted users
      const data = await getDocument('departments', id);
      if(!canEditDepartment(data)) return alert('Permission denied');
      showModal('Edit Department', (root)=>{
        root.innerHTML = `<div style="display:flex;flex-direction:column;gap:8px">
          <input id="m_name" value="${escapeHtml(data.name||'')}" placeholder="Department name" />
          <input id="m_batt" value="${escapeHtml(data.battalion||'')}" placeholder="Battalion" />
          <input id="m_addr" value="${escapeHtml(data.address||'')}" placeholder="Address" />
          <input id="m_app" value="${escapeHtml(data.apparatus||'')}" placeholder="Apparatus (| separated)" />
          <textarea id="m_notes" placeholder="Notes">${escapeHtml(data.notes||'')}</textarea>
        </div>`;
      }, async ()=> {
        const name = document.getElementById('m_name').value.trim() || 'Unnamed';
        const batt = document.getElementById('m_batt').value.trim();
        const addr = document.getElementById('m_addr').value.trim();
        const app = document.getElementById('m_app').value.trim();
        const notes = document.getElementById('m_notes').value.trim();
        await setDocument('departments', id, { name, battalion: batt, address: addr, apparatus: app, notes });
      });
    }
    if(act === 'delete'){
      if(!confirm('Delete department?')) return;
      await deleteDocument('departments', id);
    }
  });

  // Add EMS
  document.getElementById('addEmsBtn').addEventListener('click', ()=> {
    if(!currentUser || (currentUser.role !== 'ADMIN' && currentUser.role !== 'DEPTADMIN')) return alert('Permission denied');
    showModal('Add EMS Agency', (r)=> {
      r.innerHTML = `<div style="display:flex;flex-direction:column;gap:8px"><input id="m_name" placeholder="Name"/><input id="m_addr" placeholder="Address"/><input id="m_app" placeholder="Apparatus (| separated)"/></div>`;
    }, async ()=> {
      const name = document.getElementById('m_name').value.trim()||'Unnamed';
      const addr = document.getElementById('m_addr').value.trim()||'';
      const app = document.getElementById('m_app').value.trim()||'';
      await addDocument('ems', { name, address: addr, apparatus: app });
    });
  });

  // coordinators add
  document.getElementById('addCoordBtn').addEventListener('click', ()=> {
    if(!currentUser || (currentUser.role !== 'ADMIN' && currentUser.role !== 'DEPTADMIN')) return alert('Permission denied');
    showModal('Add Coordinator', (r)=> {
      r.innerHTML = `<div style="display:flex;flex-direction:column;gap:8px"><input id="m_name" placeholder="Name"/><input id="m_callsign" placeholder="Callsign"/></div>`;
    }, async ()=> {
      const name = document.getElementById('m_name').value.trim(); const callsign = document.getElementById('m_callsign').value.trim();
      if(!name) return alert('Enter a name');
      await addDocument('coordinators', { name, callsign });
    });
  });

  // add team
  document.getElementById('addTeamBtn').addEventListener('click', ()=> {
    if(!currentUser || (currentUser.role !== 'ADMIN' && currentUser.role !== 'DEPTADMIN')) return alert('Permission denied');
    showModal('Add County Team', (r)=> {
      r.innerHTML = `<div style="display:flex;flex-direction:column;gap:8px"><input id="m_name" placeholder="Team name"/><input id="m_lead" placeholder="Lead"/><input id="m_caps" placeholder="Capabilities (| separated)"/></div>`;
    }, async ()=> {
      const name = document.getElementById('m_name').value.trim()||'Unnamed'; const lead = document.getElementById('m_lead').value.trim()||''; const caps = document.getElementById('m_caps').value.trim()||'';
      await addDocument('countyTeams', { name, lead, capabilities: caps });
    });
  });

  // HazMat search + admin add
  document.getElementById('hazSearchBtn').addEventListener('click', async ()=>{
    const q = (hazInput.value || '').trim();
    if(!q) return alert('Enter UN number');
    // search by document ID if stored by UN, or search collection for matching un field
    const docRef = doc(db, 'hazmatDB', q);
    const docSnap = await getDoc(docRef);
    if(docSnap.exists()){
      const entry = docSnap.data();
      renderHazmat(entry);
      return;
    }
    // fallback: full collection find
    const col = await getCollectionOnce('hazmatDB');
    let found = null;
    Object.values(col).forEach(e=>{ if(e.un === q || e.un == Number(q)) found = e; });
    if(found) { renderHazmat(found); return; }
    hazResult.innerHTML = `<div class="muted">No record found for UN ${escapeHtml(q)}.</div>`;
  });

  document.getElementById('hazAddBtn').addEventListener('click', ()=> {
    if(!isAdmin()) return alert('Admin only');
    showModal('Add HazMat entry', (r)=> {
      r.innerHTML = `<div style="display:flex;flex-direction:column;gap:8px">
        <input id="m_un" placeholder="UN number"/>
        <input id="m_name" placeholder="Common name"/>
        <input id="m_class" placeholder="Hazard class"/>
        <input id="m_flame" placeholder="Flammability"/>
        <input id="m_water" placeholder="Water reactivity"/>
        <input id="m_agent" placeholder="Recommended extinguishing agent"/>
        <textarea id="m_notes" placeholder="Notes / response tips"></textarea>
      </div>`;
    }, async ()=> {
      const un = document.getElementById('m_un').value.trim(); if(!un) return alert('Enter UN number');
      const name = document.getElementById('m_name').value.trim()||'';
      const hazard_class = document.getElementById('m_class').value.trim()||'';
      const flammability = document.getElementById('m_flame').value.trim()||'';
      const water_reactivity = document.getElementById('m_water').value.trim()||'';
      const extinguishing_agent = document.getElementById('m_agent').value.trim()||'';
      const notes = document.getElementById('m_notes').value.trim()||'';
      // store document with ID = un for easy lookup
      await setDocument('hazmatDB', un, { un, name, hazard_class, flammability, water_reactivity, extinguishing_agent, notes });
    });
  });

  function renderHazmat(entry){
    hazResult.innerHTML = `<div style="font-weight:800">${escapeHtml(entry.name || 'Unknown')} (UN ${escapeHtml(entry.un || '')})</div>
      <div class="muted" style="margin-top:6px">${escapeHtml(entry.hazard_class || '')}</div>
      <div style="margin-top:8px"><strong>Flammability / Fire Hazards:</strong> ${escapeHtml(entry.flammability||'—')}</div>
      <div><strong>Water reactivity / behavior:</strong> ${escapeHtml(entry.water_reactivity||'—')}</div>
      <div><strong>Recommended extinguishing agent:</strong> ${escapeHtml(entry.extinguishing_agent||'—')}</div>
      <div style="margin-top:8px"><strong>Response notes:</strong><div class="muted">${escapeHtml(entry.notes||'—')}</div></div>`;
  }

  // EV search: checks evLinks collection keyed by make lowercased with underscores
  document.getElementById('evSearchBtn').addEventListener('click', async ()=>{
    const ymm = (document.getElementById('evYMM').value||'').trim();
    if(!ymm) return alert('Enter Year,Make,Model (e.g. 2021,Tesla,Model 3)');
    const parts = ymm.split(',').map(s=>s.trim());
    const make = (parts[1] || parts[0]).toLowerCase().replace(/\s+/g,'_');
    // try doc with ID = make
    const docSnap = await getDoc(doc(db, 'evLinks', make));
    if(docSnap.exists()){
      const data = docSnap.data();
      evResult.innerHTML = `<div style="font-weight:800">${escapeHtml(data.make)} ${escapeHtml(parts[2]||'')} ${escapeHtml(parts[0]||'')}</div><div style="margin-top:8px"><a href="${escapeHtml(data.url)}" target="_blank">${escapeHtml(data.url)}</a></div>`;
    } else {
      evResult.innerHTML = `<div class="muted">No manufacturer rescue guide found for '${escapeHtml(make)}'. Admin can add guides in Admin → Add EV Link.</div>`;
    }
  });

  // Admin actions: add EV link
  document.getElementById('adminAddEv').addEventListener('click', ()=> {
    if(!isAdmin()) return alert('Admin only');
    showModal('Add EV guide', (r)=> {
      r.innerHTML = `<div style="display:flex;flex-direction:column;gap:8px"><input id="m_make" placeholder="Make (e.g. Tesla)"/><input id="m_url" placeholder="Guide URL"/></div>`;
    }, async ()=> {
      const make = (document.getElementById('m_make').value||'').trim();
      const url = (document.getElementById('m_url').value||'').trim();
      if(!make||!url) return alert('Enter values');
      const key = make.toLowerCase().replace(/\s+/g,'_');
      await setDocument('evLinks', key, { make, url });
    });
  });

  // Manage local users (Admin)
  document.getElementById('manageUsersBtn').addEventListener('click', ()=> {
    if(!isAdmin()) return alert('Admin only');
    showModal('Manage Local Users', (r)=> {
      r.innerHTML = `<div style="display:flex;flex-direction:column;gap:8px">
        <div class="muted">Local users are stored in the app configuration. You can add/edit demo users here.</div>
        <input id="lu_name" placeholder="Username (uppercase)" />
        <input id="lu_pass" placeholder="Password" />
        <select id="lu_role"><option value="ADMIN">ADMIN</option><option value="DEPTADMIN">DEPTADMIN</option><option value="DEPTUSER">DEPTUSER</option></select>
        <input id="lu_dept" placeholder="Department (for DEPTADMIN only, optional)"/>
        <div style="display:flex;gap:8px"><button id="luAdd" class="btn primary">Add / Update User</button></div>
      </div>`;
      r.querySelector('#luAdd').addEventListener('click', ()=> {
        const u = document.getElementById('lu_name').value.trim().toUpperCase();
        const p = document.getElementById('lu_pass').value.trim();
        const role = document.getElementById('lu_role').value;
        const dept = document.getElementById('lu_dept').value.trim();
        if(!u||!p) return alert('Enter username & password');
        LOCAL_USERS[u] = { password: p, role, dept: dept || null };
        alert('User saved locally. Note: local users are in-browser only; re-deploy loses local edits. For persistent users we can store them in Firestore.');
      });
    }, async ()=> {});
  });

  // CSV import stub
  document.getElementById('importCsvBtn').addEventListener('click', ()=> {
    if(!isAdmin()) return alert('Admin only');
    alert('CSV import feature available on request — upload a CSV file and I will wire an import that creates departments/ems entries.');
  });

  /* ----------------- Watch collections to keep UI in sync ----------------- */
  watchCollection('departments', (data)=> renderDepartments(data));
  watchCollection('ems', (data)=> renderEMS(data));
  watchCollection('coordinators', (data)=> renderCoordinators(data));
  watchCollection('countyTeams', (data)=> renderTeams(data));
  // watch hazmatDB and evLinks not absolutely required (we read on demand), but we can watch for admin changes:
  watchCollection('hazmatDB', ()=> { /* no-op: keep realtime */ });
  watchCollection('evLinks', ()=> { /* no-op */ });

  /* ----------------- Weather alerts (NWS) — active alerts for Oswego County (OSW) ----------------- */
  async function fetchWeatherAlerts(){
    try{
      const res = await fetch('https://api.weather.gov/alerts/active?area=OSW');
      const json = await res.json();
      if(json && Array.isArray(json.features) && json.features.length){
        const items = json.features.map(f=>`${f.properties.event} — ${f.properties.areaDesc}`).join('\\n\\n');
        weatherAlerts.textContent = items;
      } else {
        weatherAlerts.textContent = 'No active alerts';
      }
    } catch(e){
      weatherAlerts.textContent = 'Weather service unavailable';
    }
  }
  fetchWeatherAlerts();

  /* ----------------- App boot & session restore ----------------- */
  function escapeHtml(s){ if(!s) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

  function bootApp(){
    currentUser = getSession();
    if(!currentUser){ showLogin(); return; }
    // show SPA
    showApp();
    setActiveView('home');
    // set user status
    userStatus.textContent = `${currentUser.username} — ${currentUser.role}${currentUser.dept ? ' • '+currentUser.dept : ''}`;
    // display/hide admin-only UI
    document.querySelectorAll('[data-view]').forEach(b=> { /* no-op for now */ });
    // mobile UI tweak: show mobile header if small screen
    if(window.innerWidth <= 980){
      document.getElementById('mobileHeader').classList.remove('hidden');
      document.getElementById('mobileHeader').style.display = 'flex';
      document.querySelectorAll('.sidebar').forEach(s=> s.style.display = 'none');
      document.getElementById('mobileDrawer').classList.remove('hidden');
    } else {
      document.getElementById('mobileHeader').classList.add('hidden');
      document.getElementById('mobileDrawer').classList.add('hidden');
    }
  }

  // wire modal cancel close also to ESC
  document.addEventListener('keydown', (e)=> { if(e.key === 'Escape') modalBackdrop.classList.remove('show'); });

  // start
  const existing = getSession();
  if(existing) bootApp();
  else showLogin();

  </script>
</body>
</html>
