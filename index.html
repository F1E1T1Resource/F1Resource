<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>F1 Resource — Main App + Dispatch</title>
<style>
:root{
  --bg:#021023;--panel:#071727;--card:#0b1624;
  --accent:#0b5fff;--accent2:#7b5cff;--muted:#9aa6bd;
  --radius:12px;
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#021023,#041428);color:#eaf3ff;min-height:100vh}
.container{max-width:1100px;margin:20px auto;padding:12px}
.card{background:linear-gradient(180deg,#0b1624,#07121a);padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
.header{display:flex;align-items:center;gap:12px}
.header img{height:56px;border-radius:8px}
.grid{display:grid;grid-template-columns:260px 1fr;gap:16px}
.sidebar{background:linear-gradient(180deg,#071323,#06121a);padding:12px;border-radius:12px;height:calc(100vh - 80px);position:sticky;top:20px}
.nav button{display:block;width:100%;text-align:left;padding:10px;border-radius:8px;border:none;background:transparent;color:var(--muted);margin-bottom:6px;cursor:pointer;font-weight:700}
.nav button.active{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#001020;transform:translateX(6px)}
.view{display:none}
.view.active{display:block}
.input,textarea,select{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit;margin-top:8px}
.btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:700}
.btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#001020}
.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
.list{display:flex;flex-direction:column;gap:8px;margin-top:12px}
.listItem{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);border:1px solid rgba(255,255,255,0.02)}
.meta{color:var(--muted);font-size:13px}
.modal-backdrop{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:9999}
.modal{background:linear-gradient(180deg,#0b1624,#08121a);padding:16px;border-radius:12px;max-width:720px;width:96%;border:1px solid rgba(255,255,255,0.03)}
.drag-handle{margin-right:8px;cursor:grab;color:var(--muted)}
@media (max-width:900px){
  .grid{grid-template-columns:1fr}
  .sidebar{position:fixed;left:-320px;top:20px;height:calc(100vh-40px);z-index:1200;transition:left .22s}
  .sidebar.open{left:12px}
}
.small{padding:6px 8px;font-size:13px}
</style>
</head>
<body>
<div class="container card">
  <div class="header">
    <img id="logo" src="https://c6ee69d755.cbaul-cdnwnd.com/af0c9920a8129f9bf9a0921ecfe9d264/200000017-17b1717b1a/700/F1Resource-removebg-preview.webp?ph=c6ee69d755" alt="logo">
    <div>
      <h2 style="margin:0">F1 Resource</h2>
      <div class="meta">Oswego County — Resources & Dispatch</div>
    </div>
    <div style="margin-left:auto" id="topRightInfo" class="meta"></div>
  </div>

  <!-- LOGIN SCREEN -->
  <div id="loginScreen" style="margin-top:18px">
    <div class="card" style="display:flex;gap:12px;align-items:center">
      <div style="flex:0 0 88px"><img src="https://c6ee69d755.cbaul-cdnwnd.com/af0c9920a8129f9bf9a0921ecfe9d264/200000017-17b1717b1a/700/F1Resource-removebg-preview.webp?ph=c6ee69d755" style="height:80px;border-radius:10px"></div>
      <div style="flex:1">
        <h3 style="margin:0">Main App Login</h3>
        <div class="meta">Local login for admins & department users. Default admin: <strong>ADMIN / ADMIN</strong></div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:12px">
          <input id="loginUser" class="input" placeholder="Username">
          <input id="loginPass" class="input" type="password" placeholder="Password">
        </div>
        <div style="display:flex;gap:8px;margin-top:12px">
          <button id="btnLogin" class="btn primary">Login</button>
          <button id="btnFill" class="btn ghost">Demo Fill</button>
          <button id="gotoApparatus" class="btn ghost" style="margin-left:auto">Apparatus Login</button>
        </div>
        <div id="loginMsg" style="color:#ff9b9b;margin-top:8px"></div>
      </div>
    </div>
  </div>
  <!-- APP -->
  <div id="app" style="display:none;margin-top:18px">
    <div class="grid">
      <aside class="sidebar" id="sidebar">
        <div style="display:flex;gap:8px;align-items:center">
          <img src="https://c6ee69d755.cbaul-cdnwnd.com/af0c9920a8129f9bf9a0921ecfe9d264/200000017-17b1717b1a/700/F1Resource-removebg-preview.webp?ph=c6ee69d755" style="height:48px;border-radius:8px">
          <div style="font-weight:800">F1 Resource</div>
        </div>
        <nav class="nav" style="margin-top:12px">
          <button data-view="home" class="active">Home</button>
          <button data-view="departments">Fire Departments</button>
          <button data-view="ems">EMS Agencies</button>
          <button data-view="coordinators">County Coordinators</button>
          <button data-view="teams">County Teams</button>
          <button data-view="hazmat">HazMat Search</button>
          <button data-view="ev">EV Safety</button>
          <button data-view="risks">Fire & Driving Risk</button>
          <button data-view="weather">Weather</button>
          <button data-view="apparatus">Apparatus Control</button>
          <button data-view="admin">Admin</button>
          <button id="logoutBtn" class="btn ghost" style="margin-top:12px">Logout</button>
        </nav>
      </aside>

      <main>
        <div id="home" class="view active card">
          <h3>WELCOME</h3>
          <div class="meta">This is F1 Resource — your all inclusive application for resources and dispatch.</div>
        </div>

        <div id="departments" class="view card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>Fire Departments</strong><div class="meta">Manage departments</div></div>
            <div><button id="addDept" class="btn primary">+ Add</button></div>
          </div>
          <div id="deptList" class="list"></div>
        </div>

        <div id="ems" class="view card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>EMS Agencies</strong></div>
            <div><button id="addEms" class="btn primary">+ Add</button></div>
          </div>
          <div id="emsList" class="list"></div>
        </div>

        <div id="coordinators" class="view card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>County Coordinators</strong></div>
            <div><button id="addCoord" class="btn primary">+ Add</button></div>
          </div>
          <div id="coordList" class="list"></div>
        </div>
        <div id="teams" class="view card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>County Teams</strong></div>
            <div><button id="addTeam" class="btn primary">+ Add Team</button></div>
          </div>
          <div id="teamList" class="list"></div>
        </div>

        <div id="hazmat" class="view card">
          <h3>HazMat Search</h3>
          <div style="display:flex;gap:8px">
            <input id="hazQuery" class="input" placeholder="UN/NA number (e.g. 1203)">
            <button id="hazSearchBtn" class="btn primary">Search</button>
            <button id="hazAdminBtn" class="btn ghost">Add/Edit</button>
          </div>
          <div id="hazResult" style="margin-top:12px"></div>
        </div>

        <div id="ev" class="view card">
          <h3>EV Safety</h3>
          <div style="display:flex;gap:8px">
            <input id="evQuery" class="input" placeholder="VIN or Year,Make,Model">
            <button id="evSearchBtn" class="btn primary">Find</button>
          </div>
          <div id="evResult" style="margin-top:12px"></div>
        </div>

        <div id="risks" class="view card">
          <h3>Fire & Driving Risk</h3>
          <div id="riskBody" class="meta" style="margin-top:8px"></div>
        </div>

        <div id="weather" class="view card">
          <h3>Weather</h3>
          <div class="meta">Active weather alerts for Oswego County</div>
          <pre id="weatherBlock" style="white-space:pre-wrap;margin-top:8px;color:var(--muted)"></pre>
        </div>

        <div id="apparatus" class="view card">
          <h3>Apparatus Control</h3>
          <div style="display:flex;gap:8px">
            <button id="addApp" class="btn primary">+ Add Apparatus</button>
            <button id="refreshApp" class="btn ghost">Refresh</button>
          </div>
          <div id="appList" class="list" style="margin-top:12px"></div>
        </div>
        <div id="admin" class="view card">
          <h3>Admin</h3>
          <div style="display:flex;gap:8px;margin-top:12px">
            <button id="manageUsers" class="btn primary">Manage Local Users</button>
            <button id="manageHaz" class="btn ghost">HazMat Import</button>
          </div>
          <div id="userList" class="list" style="margin-top:12px"></div>
        </div>

        <div id="dispatchView" class="view card">
          <h3>Apparatus Mobile — Dispatch</h3>
          <div id="dispatchArea">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div><strong id="unitLabel">Unit</strong><div class="meta" id="unitMeta"></div></div>
              <div style="display:flex;gap:8px">
                <button id="createIncidentBtn" class="btn primary">Create Incident</button>
                <button id="viewArchiveBtn" class="btn ghost">Archive</button>
              </div>
            </div>
            <div id="incidentList" style="margin-top:12px"></div>
            <div id="createPanel" style="display:none;margin-top:12px">
              <input id="incAddress" class="input" placeholder="Address">
              <input id="incType" class="input" placeholder="Type / Nature">
              <textarea id="incDetails" class="input" placeholder="Details"></textarea>
              <div style="display:flex;gap:8px;margin-top:8px"><button id="submitInc" class="btn primary">Submit</button><button id="cancelInc" class="btn ghost">Cancel</button></div>
            </div>

            <div id="openIncidentPanel" style="display:none;margin-top:12px">
              <div id="openTitle" style="font-weight:800"></div>
              <div id="openMeta" class="meta" style="margin-top:6px"></div>
              <div style="margin-top:8px"><strong>Units & Status</strong><div id="unitsBlock" class="meta"></div></div>
              <div style="margin-top:8px"><strong>Update Status</strong><div style="display:flex;gap:6px;margin-top:6px"><button class="statusBtn btn small" data-status="Acknowledged">Acknowledged</button><button class="statusBtn btn small" data-status="Responding">Responding</button><button class="statusBtn btn small" data-status="Arrived">Arrived</button><button class="statusBtn btn small" data-status="Clear">Clear</button></div></div>
              <div style="margin-top:8px"><strong>Chat</strong><div id="chatBox" class="meta" style="min-height:100px;margin-top:6px"></div><div style="display:flex;gap:8px;margin-top:8px"><input id="chatInput" class="input" placeholder="Message"><button id="sendChat" class="btn primary">Send</button></div></div>
              <div style="display:flex;gap:8px;margin-top:8px"><button id="attachBtn" class="btn ghost">Attach</button><button id="archiveInc" class="btn ghost">Archive</button></div>
            </div>
          </div>
        </div>

      </main>
    </div>
  </div>
</div>
<!-- Modal -->
<div id="modalBackdrop" class="modal-backdrop"><div class="modal"><h3 id="modalTitle"></h3><div id="modalBody"></div><div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px"><button id="modalCancel" class="btn ghost">Cancel</button><button id="modalSave" class="btn primary">Save</button></div></div></div>

<script type="module">
// Firebase imports
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, doc, getDoc, getDocs, addDoc, setDoc, deleteDoc, onSnapshot, query } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBi0Xyljx7zzXTmyyRMAru11hZ2s5S3tsw",
  authDomain: "f1resource-8fedc.firebaseapp.com",
  projectId: "f1resource-8fedc",
  storageBucket: "f1resource-8fedc.firebasestorage.app",
  messagingSenderId: "182745701982",
  appId: "1:182745701982:web:9f4f3836b41b450987decf"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const ROOT_COL='f1root', ROOT_DOC='f1resource';
const subCol = (name)=> collection(db, ROOT_COL, ROOT_DOC, name);
const docRef = (col,id)=> doc(db, ROOT_COL, ROOT_DOC, col, id);

// Helpers
const $ = id => document.getElementById(id);
function esc(s){ return s? String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;') : ''; }

// Local users storage
const LOCAL_USERS_KEY = 'f1_local_users_v1';
function loadLocalUsers(){ try{ return JSON.parse(localStorage.getItem(LOCAL_USERS_KEY) || '{}'); }catch(e){ return {}; } }
function saveLocalUsers(obj){ localStorage.setItem(LOCAL_USERS_KEY, JSON.stringify(obj)); }
let localUsers = loadLocalUsers();
if(!localUsers.ADMIN){ localUsers.ADMIN = { password:'ADMIN', role:'ADMIN', dept:'' }; saveLocalUsers(localUsers); }

// Apparatus local accounts (for Option A)
const APP_USERS_KEY = 'f1_apparatus_local_v1';
function loadAppUsers(){ try{ return JSON.parse(localStorage.getItem(APP_USERS_KEY)||'{}'); }catch(e){ return {}; } }
function saveAppUsers(o){ localStorage.setItem(APP_USERS_KEY, JSON.stringify(o)); }
let appUsers = loadAppUsers();
if(!Object.keys(appUsers).length){
  appUsers['ENGINE511'] = { password:'ENGINE511', label:'Engine 511' };
  appUsers['ENGINE512'] = { password:'ENGINE512', label:'Engine 512' };
  saveAppUsers(appUsers);
}
// SSO keys
const MAIN_SESSION_KEY = 'f1_main_user';
const APP_SESSION_KEY = 'f1_apparatus_user';

// State
let CURRENT_USER = null; // main app user
let CURRENT_APP = null;  // apparatus user
let INCIDENTS = {}; let SELECTED_INC = null;

// Modal helpers
const modal = $('modalBackdrop'), modalTitle=$('modalTitle'), modalBody=$('modalBody'), modalSave=$('modalSave'), modalCancel=$('modalCancel');
function showModal(title, buildFn, onSave){
  modalTitle.textContent = title; modalBody.innerHTML=''; buildFn(modalBody);
  modal.classList.add('show'); modal.style.display='flex';
  modalSave.onclick = async ()=>{ await onSave(); modal.style.display='none'; modalBody.innerHTML=''; modalSave.onclick=null; };
  modalCancel.onclick = ()=>{ modal.style.display='none'; modalBody.innerHTML=''; modalSave.onclick=null; };
}

// Navigation
document.querySelectorAll('.nav button[data-view]').forEach(b=> b.addEventListener('click', ()=> setView(b.dataset.view)));
function setView(id){
  document.querySelectorAll('.view').forEach(v=> v.classList.remove('active'));
  const el = $(id); if(el) el.classList.add('active');
  document.querySelectorAll('.nav button[data-view]').forEach(b=> b.classList.toggle('active', b.dataset.view===id));
}

// Login handlers
$('btnFill').addEventListener('click', ()=>{ $('loginUser').value='ADMIN'; $('loginPass').value='ADMIN'; });
$('gotoApparatus').addEventListener('click', ()=> { // show apparatus login modal UI inside same file
  showModal('Apparatus Login', body=>{
    body.innerHTML = `<input id="ap_user" class="input" placeholder="Unit username"><input id="ap_pass" class="input" type="password" placeholder="Password"><div class="meta">Demo: ENGINE511 / ENGINE511</div>`;
  }, async ()=>{
    const u = ($('ap_user').value||'').trim().toUpperCase(); const p = ($('ap_pass').value||'').trim();
    if(!u||!p){ alert('Enter creds'); return; }
    appUsers = loadAppUsers();
    if(!appUsers[u] || appUsers[u].password !== p){ alert('Invalid apparatus login'); return; }
    // persist SSO
    localStorage.setItem(APP_SESSION_KEY, u);
    CURRENT_APP = { username:u, label: appUsers[u].label || u };
    modal.style.display='none';
    bootDispatchForApp();
  });
});

$('btnLogin').addEventListener('click', ()=>{
  const rawU = ($('loginUser').value||'').trim();
  const rawP = ($('loginPass').value||'').trim();
  if(!rawU||!rawP){ $('loginMsg').textContent='Enter username & password'; return; }
  const u = rawU.toUpperCase();
  localUsers = loadLocalUsers();
  const user = localUsers[u];
  if(!user || user.password !== rawP){ $('loginMsg').textContent='Invalid credentials'; return; }
  // success
  CURRENT_USER = { username:u, role:user.role, dept:user.dept||'' };
  localStorage.setItem(MAIN_SESSION_KEY, u);
  $('loginMsg').textContent='';
  $('topRightInfo').textContent = `${u} • ${user.role}`;
  $('loginScreen').style.display='none'; $('app').style.display='block';
  setupAfterLogin();
});

// Logout
$('logoutBtn').addEventListener('click', ()=>{ localStorage.removeItem(MAIN_SESSION_KEY); location.reload(); });

// Auto-login attempts
(function tryAutoLogin(){
  const savedMain = localStorage.getItem(MAIN_SESSION_KEY);
  if(savedMain){
    localUsers = loadLocalUsers();
    const u = savedMain.toUpperCase();
    if(localUsers[u]){ CURRENT_USER = { username:u, role:localUsers[u].role, dept:localUsers[u].dept||'' }; $('topRightInfo').textContent = `${u} • ${localUsers[u].role}`; $('loginScreen').style.display='none'; $('app').style.display='block'; setupAfterLogin(); return; }
    else localStorage.removeItem(MAIN_SESSION_KEY);
  }
  const savedApp = localStorage.getItem(APP_SESSION_KEY);
  if(savedApp){
    appUsers = loadAppUsers();
    if(appUsers[savedApp]){ CURRENT_APP = { username:savedApp, label: appUsers[savedApp].label }; bootDispatchForApp(); }
    else localStorage.removeItem(APP_SESSION_KEY);
  }
})();

function setupAfterLogin(){
  // show/hide apparatus control per role
  if(CURRENT_USER.role !== 'ADMIN') document.querySelector('button[data-view="admin"]').style.display='none';
  if(CURRENT_USER.role !== 'ADMIN' && CURRENT_USER.role !== 'DEPT_ADMIN') document.querySelector('button[data-view="apparatus"]').style.display='none';
  // attach CRUD buttons
  attachCrudHandlers();
  startRealtimeListeners();
}

// Firestore realtime listeners
function startRealtimeListeners(){
  onSnapshot(query(subCol('fire_departments')), snap => {
    const out={}; snap.forEach(d=> out[d.id]=d.data()); renderDepartmentsOrdered(out);
  });
  onSnapshot(query(subCol('ems_agencies')), snap => {
    const out={}; snap.forEach(d=> out[d.id]=d.data()); renderEMSOrdered(out);
  });
  onSnapshot(query(subCol('coordinators')), snap => {
    const out={}; snap.forEach(d=> out[d.id]=d.data()); renderCoordinatorsOrdered(out);
  });
  onSnapshot(query(subCol('county_teams')), snap => {
    const out={}; snap.forEach(d=> out[d.id]=d.data()); renderTeamsOrdered(out);
  });
  onSnapshot(query(subCol('apparatus')), snap => {
    const out={}; snap.forEach(d=> out[d.id]=d.data()); renderApparatus(out);
  });
  onSnapshot(query(subCol('incidents')), snap => {
    INCIDENTS={}; snap.forEach(d=> INCIDENTS[d.id]={ id:d.id, ...(d.data()) }); renderIncidentList();
  });
  renderUsersOrdered(loadLocalUsers());
  fetchWeather();
}

// Renderers and DnD (simplified)
function sortByOrder(map){ return Object.entries(map||{}).map(([id,d])=> ({ id, ...(d||{}) })).sort((a,b)=> ((a.order||1e9)-(b.order||1e9)) || (''+a.name).localeCompare(b.name)); }

function renderDepartmentsOrdered(map){
  const t=$('deptList'); t.innerHTML=''; const items = sortByOrder(map);
  items.forEach(d=>{
    const div=document.createElement('div'); div.className='listItem'; div.dataset.id=d.id;
    const drag = CURRENT_USER && CURRENT_USER.role==='ADMIN' ? '<span class="drag-handle">≡</span>' : '';
    div.draggable = !!(CURRENT_USER && CURRENT_USER.role==='ADMIN');
    div.innerHTML = `<div><div style="font-weight:800">${drag}${esc(d.name||'')}</div><div class='meta'>${esc(d.battalion||'')} ${d.address? ' • '+esc(d.address):''}</div></div>
      <div style="display:flex;gap:8px"><button class="small btn" data-id="${d.id}" data-act="view-dept">View</button>${CURRENT_USER && (CURRENT_USER.role==='ADMIN' || (CURRENT_USER.role==='DEPT_ADMIN' && CURRENT_USER.dept===d.name))?`<button class="small btn" data-id="${d.id}" data-act="edit-dept">Edit</button>`:''}</div>`;
    t.appendChild(div);
  });
  t.querySelectorAll('button[data-act="view-dept"]').forEach(b=> b.addEventListener('click', ()=> alert('Dept view placeholder')));
  t.querySelectorAll('button[data-act="edit-dept"]').forEach(b=> b.addEventListener('click', ()=> editDoc('fire_departments', b.dataset.id)));
  if(CURRENT_USER && CURRENT_USER.role==='ADMIN') enableDragReorder(t, persistFirestoreOrder('fire_departments'));
}

function renderEMSOrdered(map){
  const t=$('emsList'); t.innerHTML=''; const items = sortByOrder(map);
  items.forEach(e=>{
    const div=document.createElement('div'); div.className='listItem'; div.dataset.id=e.id;
    div.draggable = !!(CURRENT_USER && CURRENT_USER.role==='ADMIN');
    const drag = CURRENT_USER && CURRENT_USER.role==='ADMIN' ? '<span class="drag-handle">≡</span>' : '';
    div.innerHTML = `<div><div style="font-weight:800">${drag}${esc(e.name||'')}</div><div class="meta">${esc(e.address||'')}</div></div><div><button class="small btn" data-id="${e.id}" data-act="view-ems">View</button></div>`;
    t.appendChild(div);
  });
  t.querySelectorAll('button[data-act="view-ems"]').forEach(b=> b.addEventListener('click', ()=> alert('EMS view placeholder')));
  if(CURRENT_USER && CURRENT_USER.role==='ADMIN') enableDragReorder(t, persistFirestoreOrder('ems_agencies'));
}

function renderCoordinatorsOrdered(map){
  const t=$('coordList'); t.innerHTML=''; const items = sortByOrder(map);
  items.forEach(c=>{
    const div=document.createElement('div'); div.className='listItem'; div.dataset.id=c.id;
    div.draggable = !!(CURRENT_USER && CURRENT_USER.role==='ADMIN');
    const drag = CURRENT_USER && CURRENT_USER.role==='ADMIN' ? '<span class="drag-handle">≡</span>' : '';
    div.innerHTML = `<div><div style="font-weight:800">${drag}${esc(c.name||'')}</div><div class="meta">Callsign: ${esc(c.callsign||'')}</div></div><div>${CURRENT_USER&&CURRENT_USER.role==='ADMIN'?`<button class="small btn" data-id="${c.id}" data-act="edit-coord">Edit</button>`:''}</div>`;
    t.appendChild(div);
  });
  t.querySelectorAll('button[data-act="edit-coord"]').forEach(b=> b.addEventListener('click', ()=> editDoc('coordinators', b.dataset.id)));
  if(CURRENT_USER && CURRENT_USER.role==='ADMIN') enableDragReorder(t, persistFirestoreOrder('coordinators'));
}

// ... end of file
</script>
</body>
</html>
