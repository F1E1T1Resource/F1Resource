<!-- PART 1/6 -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>F1 Resource — Main App</title>
  <style>
    :root{
      --bg:#031026; --panel:#081727; --card:#0f1b2b;
      --accent:#0b5fff; --accent2:#7b5cff; --muted:#9aa6bd;
      --radius:12px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#021023,var(--bg));color:#e6eef9}
    .app{display:flex;min-height:100vh}
    .sidebar{width:240px;padding:18px;background:linear-gradient(180deg,var(--panel),#071323);flex-shrink:0;display:flex;flex-direction:column;gap:12px;border-right:1px solid rgba(255,255,255,0.03)}
    .logo{display:flex;gap:12px;align-items:center}
    .logo img{height:56px;border-radius:8px}
    .brand{font-weight:800}
    .nav{display:flex;flex-direction:column;gap:6px;margin-top:12px}
    .nav button{background:transparent;border:none;color:var(--muted);text-align:left;padding:10px 12px;border-radius:8px;cursor:pointer;font-weight:700}
    .nav button:hover,.nav button.active{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#001020;transform:translateX(6px)}
    .main{flex:1;padding:20px;display:flex;flex-direction:column;gap:16px}
    .topbar{display:flex;justify-content:space-between;align-items:center}
    .card{background:linear-gradient(180deg,#0b1624,#08121a);padding:16px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
    .view{display:none}
    .view.active{display:block}
    .list{display:flex;flex-direction:column;gap:10px;margin-top:12px}
    .listItem{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);border:1px solid rgba(255,255,255,0.02)}
    .meta{color:var(--muted);font-size:13px}
    .btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:700}
    .btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#001020}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.03);color:var(--muted)}
    input,textarea,select{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:#e6eef9;margin:6px 0}
    .muted-block{color:var(--muted);font-size:13px}
    .modal-backdrop{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:9999;background:rgba(0,0,0,0.6)}
    .modal-backdrop.show{display:flex}
    .modal{background:linear-gradient(180deg,#0b1624,#08121a);padding:18px;border-radius:12px;max-width:720px;width:96%;border:1px solid rgba(255,255,255,0.03)}
    .draggable-list [draggable="true"]{cursor:grab}
    @media (max-width:900px){
      .sidebar{display:none}
      .mobileHeader{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:linear-gradient(180deg,#041028,#051428);border-bottom:1px solid rgba(255,255,255,0.03)}
      .drawer{position:fixed;left:0;top:0;height:100%;width:260px;background:linear-gradient(180deg,var(--panel),#071323);box-shadow:8px 0 30px rgba(0,0,0,0.6);transform:translateX(-120%);transition:transform .22s;z-index:1000;padding:20px}
      .drawer.open{transform:translateX(0)}
    }
  </style>
</head>
<body>
  <!-- LOGIN SCREEN -->
  <div id="loginScreen" style="min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;">
    <div class="card" style="max-width:920px;width:100%;display:flex;gap:18px;align-items:center">
      <div style="flex:0 0 88px">
        <img src="https://c6ee69d755.cbaul-cdnwnd.com/af0c9920a8129f9bf9a0921ecfe9d264/200000017-17b1717b1a/700/F1Resource-removebg-preview.webp?ph=c6ee69d755" alt="logo" style="height:80px;border-radius:10px">
      </div>
      <div style="flex:1">
        <h2 style="margin:0 0 6px">F1 Resource — Login</h2>
        <div class="muted-block">Local login (stored in your browser). App data stored in Firestore. Default admin: <strong>ADMIN / ADMIN</strong>.</div>

        <div style="margin-top:12px;display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <input id="loginUser" placeholder="Username" autocomplete="off" />
          <input id="loginPass" placeholder="Password" type="password" autocomplete="off" />
        </div>

        <div style="display:flex;gap:8px;margin-top:12px">
          <button id="btnLogin" class="btn primary">Login</button>
          <button id="btnFill" class="btn ghost">Demo Fill</button>
          <button id="btnMobileApp" class="btn ghost" style="margin-left:auto">Apparatus Login</button>
        </div>

        <div id="loginMsg" style="color:#ff9b9b;margin-top:8px"></div>
      </div>
    </div>
  </div>
<!-- PART 2/6 -->
  <!-- SPA -->
  <div id="spa" class="app" style="display:none">
    <aside class="sidebar" role="navigation" aria-label="Main navigation">
      <div class="logo">
        <img src="https://c6ee69d755.cbaul-cdnwnd.com/af0c9920a8129f9bf9a0921ecfe9d264/200000017-17b1717b1a/700/F1Resource-removebg-preview.webp?ph=c6ee69d755" alt="logo"/>
        <div><div class="brand">F1 Resource</div><div class="muted-block">Oswego County</div></div>
      </div>

      <nav class="nav" aria-label="Pages">
        <button data-view="home" class="active">Home</button>
        <button data-view="departments">Fire Departments</button>
        <button data-view="ems">EMS Agencies</button>
        <button data-view="coordinators">County Coordinators</button>
        <button data-view="teams">County Teams</button>
        <button data-view="hazmat">HazMat Search</button>
        <button data-view="ev">EV Safety</button>
        <button data-view="risks">Fire & Driving Risk</button>
        <button data-view="weather">Weather</button>
        <button data-view="apparatus_control">Apparatus Control</button>
        <button data-view="admin">Admin</button>
        <button id="btnLogout" class="btn ghost" style="margin-top:12px">Logout</button>
      </nav>

      <div style="margin-top:auto;color:var(--muted)">&copy; F1 Resource</div>
    </aside>

    <main class="main">
      <div class="topbar">
        <div style="display:flex;gap:12px;align-items:center">
          <img src="https://c6ee69d755.cbaul-cdnwnd.com/af0c9920a8129f9bf9a0921ecfe9d264/200000017-17b1717b1a/700/F1Resource-removebg-preview.webp?ph=c6ee69d755" style="height:56px;border-radius:8px" />
          <div>
            <div style="font-weight:800">WELCOME</div>
            <div class="muted-block">F1 Resource — your all inclusive application for Oswego County.</div>
          </div>
        </div>
        <div id="userBadge" class="muted-block"></div>
      </div>

      <!-- Views -->
      <section id="home" class="view active card"><h3 style="margin:0">Home</h3><div class="muted-block" style="margin-top:8px">Use the navigation to access modules.</div></section>

      <section id="departments" class="view card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>Fire Departments</strong><div class="muted-block">Manage departments</div></div>
          <div><button id="addDept" class="btn primary">+ Add</button></div>
        </div>
        <div id="deptList" class="list"></div>
      </section>

      <section id="ems" class="view card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>EMS Agencies</strong></div>
          <div><button id="addEms" class="btn primary">+ Add</button></div>
        </div>
        <div id="emsList" class="list"></div>
      </section>

      <section id="coordinators" class="view card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>County Coordinators</strong></div>
          <div><button id="addCoord" class="btn primary">+ Add</button></div>
        </div>
        <div id="coordList" class="list"></div>
      </section>

      <section id="teams" class="view card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>County Teams</strong></div>
          <div><button id="addTeam" class="btn primary">+ Add Team</button></div>
        </div>
        <div id="teamList" class="list"></div>
      </section>
<!-- PART 3/6 -->
      <section id="hazmat" class="view card">
        <h3 style="margin:0 0 8px">HazMat Search</h3>
        <div style="display:flex;gap:8px;">
          <input id="hazQuery" placeholder="UN/NA number (e.g. 1203)" />
          <button id="btnHazSearch" class="btn primary">Search</button>
          <button id="btnHazAdmin" class="btn ghost">Add/Edit</button>
        </div>
        <div id="hazResult" style="margin-top:12px"></div>
      </section>

      <section id="ev" class="view card">
        <h3 style="margin:0 0 8px">EV Safety</h3>
        <div style="display:flex;gap:8px">
          <input id="evQuery" placeholder="Year,Make,Model or VIN" />
          <button id="btnEvSearch" class="btn primary">Find</button>
        </div>
        <div id="evResult" style="margin-top:12px"></div>
      </section>

      <section id="risks" class="view card">
        <h3>Fire & Driving Risk</h3>
        <div id="riskBody" class="muted-block" style="margin-top:8px"></div>
      </section>

      <section id="weather" class="view card">
        <h3>Weather</h3>
        <div class="muted-block" style="margin-top:8px">Active weather alerts for Oswego County</div>
        <pre id="weatherBlock" style="white-space:pre-wrap;margin-top:8px;color:var(--muted)"></pre>
      </section>

      <section id="apparatus_control" class="view card">
        <h3>Apparatus Control Center</h3>
        <div class="muted-block">Create apparatus, assign to departments, define apparatus display name.</div>
        <div style="display:flex;gap:8px;margin-top:12px">
          <button id="addApp" class="btn primary">+ Add Apparatus</button>
          <button id="refreshApp" class="btn ghost">Refresh List</button>
        </div>
        <div id="appList" class="list" style="margin-top:12px"></div>
      </section>

      <section id="admin" class="view card">
        <h3>Admin</h3>
        <div style="margin-top:12px;display:flex;gap:8px">
          <button id="manageUsers" class="btn primary">Manage Local Users</button>
          <button id="manageHaz" class="btn ghost">HazMat Import</button>
        </div>
      </section>

    </main>
  </div>

  <!-- Modal -->
  <div id="modalBackdrop" class="modal-backdrop"><div class="modal"><h3 id="modalTitle"></h3><div id="modalBody"></div><div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px"><button id="modalCancel" class="btn ghost">Cancel</button><button id="modalSave" class="btn primary">Save</button></div></div></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getFirestore, collection, doc, getDoc, getDocs, addDoc, setDoc, deleteDoc, onSnapshot, query } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBi0Xyljx7zzXTmyyRMAru11hZ2s5S3tsw",
      authDomain: "f1resource-8fedc.firebaseapp.com",
      projectId: "f1resource-8fedc",
      storageBucket: "f1resource-8fedc.firebasestorage.app",
      messagingSenderId: "182745701982",
      appId: "1:182745701982:web:9f4f3836b41b450987decf"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Helpers
    const $ = id => document.getElementById(id);
    const ROOT_COL='f1root', ROOT_DOC='f1resource';
    const subCol = (name) => collection(db, ROOT_COL, ROOT_DOC, name);
    const docRef = (col,id) => doc(db, ROOT_COL, ROOT_DOC, col, id);
    function esc(s){ return s? String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;') : ''; }

    // Local users stored in localStorage (local login)
    const LOCAL_USERS_KEY = 'f1_local_users_v1';
    function loadLocalUsers(){ try{ return JSON.parse(localStorage.getItem(LOCAL_USERS_KEY) || '{}'); }catch(e){ return {}; } }
    function saveLocalUsers(obj){ localStorage.setItem(LOCAL_USERS_KEY, JSON.stringify(obj)); }
    // ensure initial admin exists
    let localUsers = loadLocalUsers();
    if(!localUsers.ADMIN){ localUsers.ADMIN = { password:'ADMIN', role:'ADMIN', dept:'' }; saveLocalUsers(localUsers); }

    // App state
    let CURRENT_USER = null;
    function showLogin(){ $('loginScreen').style.display='flex'; $('spa').style.display='none'; }
    function showSpa(){ $('loginScreen').style.display='none'; $('spa').style.display='flex'; }
<!-- PART 4/6 -->
    // login handlers
    $('btnFill').addEventListener('click', ()=>{ $('loginUser').value='ADMIN'; $('loginPass').value='ADMIN'; });
    $('btnMobileApp').addEventListener('click', ()=>{ window.location.href = 'dispatch.html'; });

    $('btnLogin').addEventListener('click', ()=>{
      const u = ($('loginUser').value||'').trim().toUpperCase();
      const p = ($('loginPass').value||'').trim();
      if(!u||!p){ $('loginMsg').textContent = 'Enter username and password'; return; }
      localUsers = loadLocalUsers();
      const user = localUsers[u];
      if(!user || user.password !== p){ $('loginMsg').textContent='Invalid credentials'; return; }
      $('loginMsg').textContent='';
      CURRENT_USER = {username:u, role:user.role, dept:user.dept||''};
      $('userBadge').textContent = `${u} • ${user.role}`;
      showSpa();
      setupNav();
      startRealtime();
    });

    // logout
    $('btnLogout').addEventListener('click', ()=>{ location.reload(); });

    // navigation
    function setupNav(){
      document.querySelectorAll('.nav button[data-view]').forEach(b=>{
        b.addEventListener('click', ()=> setView(b.dataset.view));
      });
      setView('home');
      const btn = document.querySelector('button[data-view="apparatus_control"]');
      if(CURRENT_USER.role !== 'ADMIN' && CURRENT_USER.role !== 'DEPT_ADMIN'){ btn.style.display='none'; } else { btn.style.display='block'; }
    }
    function setView(id){
      document.querySelectorAll('.view').forEach(v=> v.classList.remove('active'));
      const el = document.getElementById(id); if(el) el.classList.add('active');
      document.querySelectorAll('.nav button[data-view]').forEach(b=> b.classList.toggle('active', b.dataset.view===id));
    }

    // modal helpers
    const modal = $('modalBackdrop'), modalTitle=$('modalTitle'), modalBody=$('modalBody'), modalSave=$('modalSave'), modalCancel=$('modalCancel');
    function showModal(title, buildFn, onSave){
      modalTitle.textContent = title; modalBody.innerHTML=''; buildFn(modalBody);
      modal.classList.add('show'); modal.style.display='flex';
      modalSave.onclick = async ()=>{ await onSave(); modal.style.display='none'; modalBody.innerHTML=''; modalSave.onclick=null; };
      modalCancel.onclick = ()=>{ modal.style.display='none'; modalBody.innerHTML=''; modalSave.onclick=null; };
    }

    // start realtime listeners
    function startRealtime(){
      // Firestore realtime snapshots; renderers will handle ordering
      onSnapshot(query(subCol('fire_departments')), snap => {
        const out = {}; snap.forEach(d=> out[d.id] = d.data()); renderDepartmentsOrdered(out);
      });
      onSnapshot(query(subCol('ems_agencies')), snap => {
        const out = {}; snap.forEach(d=> out[d.id] = d.data()); renderEMSOrdered(out);
      });
      onSnapshot(query(subCol('coordinators')), snap => {
        const out = {}; snap.forEach(d=> out[d.id] = d.data()); renderCoordinatorsOrdered(out);
      });
      onSnapshot(query(subCol('county_teams')), snap => {
        const out = {}; snap.forEach(d=> out[d.id] = d.data()); renderTeamsOrdered(out);
      });
      onSnapshot(query(subCol('apparatus')), snap => {
        const out = {}; snap.forEach(d=> out[d.id] = d.data()); renderApparatus(out);
      });
      // re-render local users ordered
      renderUsersOrdered(loadLocalUsers());
      // initial weather fetch
      fetchWeather();
    }

    // renderers (basic non-ordered placeholders kept for compatibility)
    function renderApparatus(data){
      const t=$('appList'); t.innerHTML='';
      Object.entries(data||{}).forEach(([id,a])=>{
        const div=document.createElement('div'); div.className='listItem';
        div.innerHTML = `<div><div style="font-weight:800">${esc(a.apparatusName||id)}</div><div class='meta'>${esc(a.department||'Unassigned')}</div></div><div style="display:flex;gap:8px"><button class='btn small' data-id="${id}" data-act="edit-app">Edit</button><button class='btn small' data-id="${id}" data-act="del-app">Delete</button></div>`;
        t.appendChild(div);
      });
      t.querySelectorAll('button[data-act="edit-app"]').forEach(b=> b.addEventListener('click', ()=> editApp(b.dataset.id)));
      t.querySelectorAll('button[data-act="del-app"]').forEach(b=> b.addEventListener('click', ()=> deleteApp(b.dataset.id)));
    }

    // legacy renderUsers() kept for compatibility
    function renderUsers(){ renderUsersOrdered(loadLocalUsers()); }
<!-- PART 5/6 -->
    /**********************
     Drag & Drop ordering
     - Persists order for Firestore collections by writing an `order` number to each document.
     - Persists order for local users in localStorage key: 'f1_local_users_order'
    **********************/
    const LOCAL_USERS_ORDER_KEY = 'f1_local_users_order';
    function loadLocalUsersOrder(){ try{ return JSON.parse(localStorage.getItem(LOCAL_USERS_ORDER_KEY) || '[]'); }catch(e){ return []; } }
    function saveLocalUsersOrder(arr){ localStorage.setItem(LOCAL_USERS_ORDER_KEY, JSON.stringify(arr)); }

    function enableDragReorder(containerEl, persistFn){
      if(!containerEl) return;
      containerEl.classList.add('draggable-list');
      let dragEl = null;
      containerEl.addEventListener('dragstart', (e)=>{
        const item = e.target.closest('[draggable="true"]');
        if(!item) return;
        dragEl = item;
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', item.dataset.id || '');
        item.style.opacity = '0.5';
      });
      containerEl.addEventListener('dragend', (e)=>{
        if(dragEl) dragEl.style.opacity = '';
        dragEl = null;
      });
      containerEl.addEventListener('dragover', (e)=>{
        e.preventDefault();
        const after = getDragAfterElement(containerEl, e.clientY);
        const dragging = dragEl;
        if(!dragging) return;
        if(after == null){
          containerEl.appendChild(dragging);
        } else {
          containerEl.insertBefore(dragging, after);
        }
      });
      containerEl.addEventListener('drop', async (e)=>{
        e.preventDefault();
        const ids = Array.from(containerEl.children).map(ch => ch.dataset && ch.dataset.id ? ch.dataset.id : null).filter(Boolean);
        try{ await persistFn(ids); containerEl.style.opacity='0.95'; setTimeout(()=> containerEl.style.opacity='',220); }catch(err){ console.error('persist order failed', err); alert('Save order failed: ' + (err.message || err)); }
      });
      function getDragAfterElement(container, y){
        const draggableElements = [...container.querySelectorAll('[draggable="true"]')].filter(el => el !== dragEl);
        let closest = null; let closestOffset = Number.NEGATIVE_INFINITY;
        for(const child of draggableElements){
          const box = child.getBoundingClientRect();
          const offset = y - box.top - box.height/2;
          if(offset > closestOffset){ closestOffset = offset; closest = child; }
        }
        return closest;
      }
    }

    function makeFirestorePersistFunc(collectionName){
      return async function(ids){
        for(let i=0;i<ids.length;i++){
          const id = ids[i];
          const ref = doc(db, ROOT_COL, ROOT_DOC, collectionName, id);
          try{ await setDoc(ref, { order: i }, { merge: true }); }catch(e){ console.error('setDoc order failed', e); throw e; }
        }
      };
    }

    async function persistLocalUsersOrder(ids){
      saveLocalUsersOrder(ids);
      renderUsersOrdered(loadLocalUsers());
    }

    function sortFirestoreMapByOrder(map){
      return Object.entries(map||{})
        .map(([id,data]) => ({ id, ...(data||{}) }))
        .sort((a,b) => {
          const ao = (typeof a.order === 'number') ? a.order : Number.MAX_SAFE_INTEGER;
          const bo = (typeof b.order === 'number') ? b.order : Number.MAX_SAFE_INTEGER;
          if(ao !== bo) return ao - bo;
          return (a.name||'').localeCompare(b.name||'');
        });
    }

    // Departments
    async function renderDepartmentsOrdered(fireDeptMap){
      const t=$('deptList'); t.innerHTML='';
      const items = sortFirestoreMapByOrder(fireDeptMap);
      items.forEach(d=>{
        const div=document.createElement('div'); div.className='listItem';
        div.draggable = (CURRENT_USER && CURRENT_USER.role === 'ADMIN') ? true : false;
        div.dataset.id = d.id;
        const dragHandle = (CURRENT_USER && CURRENT_USER.role === 'ADMIN') ? '<span style="margin-right:8px;cursor:grab">≡</span>' : '';
        div.innerHTML = `<div><div style="font-weight:800">${dragHandle}${esc(d.name||'')}</div><div class='meta'>${esc(d.battalion||'')} ${d.address? ' • '+esc(d.address):''}</div></div>
          <div style="display:flex;gap:8px"><button class="btn small" data-id="${d.id}" data-act="view-dept">View</button>${(CURRENT_USER && (CURRENT_USER.role==='ADMIN' || (CURRENT_USER.role==='DEPT_ADMIN' && CURRENT_USER.dept===d.name)))?`<button class="btn small" data-id="${d.id}" data-act="edit-dept">Edit</button>`:''}</div>`;
        t.appendChild(div);
      });
      t.querySelectorAll('button[data-act="view-dept"]').forEach(b=> b.addEventListener('click', ()=> viewDept(b.dataset.id)));
      t.querySelectorAll('button[data-act="edit-dept"]').forEach(b=> b.addEventListener('click', ()=> editDept(b.dataset.id)));
      if(CURRENT_USER && CURRENT_USER.role === 'ADMIN'){ enableDragReorder(t, makeFirestorePersistFunc('fire_departments')); }
    }

    // EMS
    async function renderEMSOrdered(emsMap){
      const t=$('emsList'); t.innerHTML='';
      const items = sortFirestoreMapByOrder(emsMap);
      items.forEach(e=>{
        const div=document.createElement('div'); div.className='listItem';
        div.draggable = (CURRENT_USER && CURRENT_USER.role === 'ADMIN') ? true : false;
        div.dataset.id = e.id;
        const dragHandle = (CURRENT_USER && CURRENT_USER.role === 'ADMIN') ? '<span style="margin-right:8px;cursor:grab">≡</span>' : '';
        div.innerHTML=`<div><div style="font-weight:800">${dragHandle}${esc(e.name||'')}</div><div class='meta'>${esc(e.address||'')}</div></div><div><button class='btn small' data-id="${e.id}" data-act="view-ems">View</button></div>`;
        t.appendChild(div);
      });
      t.querySelectorAll('button[data-act="view-ems"]').forEach(b=> b.addEventListener('click', ()=> viewEms(b.dataset.id)));
      if(CURRENT_USER && CURRENT_USER.role === 'ADMIN'){ enableDragReorder(t, makeFirestorePersistFunc('ems_agencies')); }
    }

    // Coordinators
    async function renderCoordinatorsOrdered(coordMap){
      const t=$('coordList'); t.innerHTML='';
      const items = sortFirestoreMapByOrder(coordMap);
      items.forEach(c=>{
        const div=document.createElement('div'); div.className='listItem';
        div.draggable = (CURRENT_USER && CURRENT_USER.role === 'ADMIN') ? true : false;
        div.dataset.id = c.id;
        const dragHandle = (CURRENT_USER && CURRENT_USER.role === 'ADMIN') ? '<span style="margin-right:8px;cursor:grab">≡</span>' : '';
        div.innerHTML=`<div><div style="font-weight:800">${dragHandle}${esc(c.name||'')}</div><div class='meta'>Callsign: ${esc(c.callsign||'')}</div></div><div style="display:flex;gap:8px">${(CURRENT_USER && CURRENT_USER.role==='ADMIN')?`<button class='btn small' data-id="${c.id}" data-act="edit-coord">Edit</button>`:''}</div>`;
        t.appendChild(div);
      });
      t.querySelectorAll('button[data-act="edit-coord"]').forEach(b=> b.addEventListener('click', ()=> editCoordinator(b.dataset.id)));
      if(CURRENT_USER && CURRENT_USER.role === 'ADMIN'){ enableDragReorder(t, makeFirestorePersistFunc('coordinators')); }
    }
<!-- PART 6/6 -->
    // Teams
    async function renderTeamsOrdered(teamMap){
      const t=$('teamList'); t.innerHTML='';
      const items = sortFirestoreMapByOrder(teamMap);
      items.forEach(tm=>{
        const div=document.createElement('div'); div.className='listItem';
        div.draggable = (CURRENT_USER && CURRENT_USER.role === 'ADMIN') ? true : false;
        div.dataset.id = tm.id;
        const dragHandle = (CURRENT_USER && CURRENT_USER.role === 'ADMIN') ? '<span style="margin-right:8px;cursor:grab">≡</span>' : '';
        div.innerHTML=`<div><div style="font-weight:800">${dragHandle}${esc(tm.name||'')}</div><div class="meta">${esc(tm.lead||'')}</div></div><div></div>`;
        t.appendChild(div);
      });
      if(CURRENT_USER && CURRENT_USER.role === 'ADMIN'){ enableDragReorder(t, makeFirestorePersistFunc('county_teams')); }
    }

    // Users (local)
    function renderUsersOrdered(localUsersObj){
      const target = $('userList');
      target.innerHTML = '';
      const order = loadLocalUsersOrder();
      let keys = Object.keys(localUsersObj || {});
      if(order && order.length){
        const ordered = order.filter(u => keys.includes(u));
        const missing = keys.filter(k=> !ordered.includes(k));
        keys = [...ordered, ...missing];
      } else { keys.sort(); }
      keys.forEach(u=>{
        const user = localUsersObj[u];
        const div = document.createElement('div'); div.className='listItem';
        div.draggable = (CURRENT_USER && CURRENT_USER.role === 'ADMIN') ? true : false;
        div.dataset.id = u;
        const dragHandle = (CURRENT_USER && CURRENT_USER.role === 'ADMIN') ? '<span style="margin-right:8px;cursor:grab">≡</span>' : '';
        div.innerHTML = `<div><strong>${dragHandle}${u}</strong><div class="muted">Role: ${user.role}</div></div><div style="display:flex;gap:8px"><button class='small btn' onclick="editUser('${u}')">Edit</button><button class='small btn' onclick="deleteUser('${u}')">Delete</button></div>`;
        target.appendChild(div);
      });
      if(CURRENT_USER && CURRENT_USER.role === 'ADMIN'){
        enableDragReorder(target, async (ids) => { await persistLocalUsersOrder(ids); });
      }
    }

    // Aliases & legacy compatibility
    function renderUsers(){ renderUsersOrdered(loadLocalUsers()); }

    // --------------------------
    // CRUD + Admin actions (kept similar to prior implementation)
    // For brevity, many of the existing add/edit/delete functions are similar
    // to the versions you already have. We'll include the core ones needed.
    // --------------------------

    // Add Department
    $('addDept').addEventListener('click', ()=> {
      if(!isAdmin()) return;
      showModal('Add Department', (root)=> {
        root.innerHTML = `<input id="md_name" placeholder="Name"/><input id="md_batt" placeholder="Battalion"/><input id="md_addr" placeholder="Address"/><input id="md_apps" placeholder="Apparatus (| separated)"/>`;
      }, async ()=> {
        const name=$('md_name').value.trim()||'Unnamed', batt=$('md_batt').value.trim(), addr=$('md_addr').value.trim(), apps=$('md_apps').value.trim();
        await addDoc(subCol('fire_departments'), { name, battalion: batt, address: addr, apparatus: apps });
      });
    });

    // Add EMS
    $('addEms').addEventListener('click', ()=> {
      if(!isAdmin()) return;
      showModal('Add EMS', (r)=> r.innerHTML=`<input id="me_name" placeholder="Name"/><input id="me_addr" placeholder="Address"/>`, async ()=> {
        const name=$('me_name').value.trim()||'Unnamed', addr=$('me_addr').value.trim(); await addDoc(subCol('ems_agencies'), { name, address: addr });
      });
    });

    // Add Coordinator
    $('addCoord').addEventListener('click', ()=> {
      if(!isAdmin()) return;
      showModal('Add Coordinator', (r)=> r.innerHTML=`<input id="mc_name" placeholder="Name"/><input id="mc_callsign" placeholder="Callsign"/>`, async ()=> {
        const name=$('mc_name').value.trim(); const calls=$('mc_callsign').value.trim(); if(!name) return alert('Name required'); await addDoc(subCol('coordinators'), { name, callsign: calls });
      });
    });

    // Add Team
    $('addTeam').addEventListener('click', ()=> {
      if(!isAdmin()) return;
      showModal('Add Team', (r)=> r.innerHTML=`<input id="mt_name" placeholder="Team Name"/><input id="mt_lead" placeholder="Lead"/><input id="mt_caps" placeholder="Capabilities (| separated)"/>`, async ()=> {
        const n=$('mt_name').value.trim()||'Unnamed', lead=$('mt_lead').value.trim(), caps=$('mt_caps').value.trim(); await addDoc(subCol('county_teams'), { name:n, lead, capabilities: caps });
      });
    });

    // Apparatus control add/edit/delete
    $('addApp').addEventListener('click', ()=> {
      if(!isAdmin()) return;
      showModal('Add Apparatus', (root)=> {
        root.innerHTML = `<input id="ap_username" placeholder="Login username (eg ENGINE511)"/><input id="ap_name" placeholder="Apparatus display name (eg Engine 511)"/><input id="ap_dept" placeholder="Assigned department (exact name)"/>`;
      }, async ()=> {
        const username = ($('ap_username').value.trim()||'').toUpperCase(); if(!username) return alert('Username required');
        const apron = $('ap_name').value.trim(); const dept = $('ap_dept').value.trim();
        await setDoc(docRef('apparatus', username), { username, apparatusName:apron, department:dept });
      });
    });

    async function editApp(id){
      if(!isAdmin()) return;
      const s = await getDoc(docRef('apparatus', id)); if(!s.exists()) return alert('Not found');
      const d = s.data();
      showModal('Edit Apparatus', (root)=> {
        root.innerHTML = `<input id="ea_name" value="${esc(d.apparatusName||'')}" /><input id="ea_dept" value="${esc(d.department||'')}" />`;
      }, async ()=> {
        const obj = { username:id, apparatusName:$('ea_name').value.trim(), department:$('ea_dept').value.trim() };
        await setDoc(docRef('apparatus', id), obj); alert('Saved');
      });
    }
    async function deleteApp(id){
      if(!confirm('Delete apparatus '+id+'?')) return;
      await deleteDoc(docRef('apparatus', id));
    }

    // HazMat search / admin (as before)
    $('btnHazSearch').addEventListener('click', async ()=> {
      const q = ($('hazQuery').value||'').trim(); if(!q) return alert('Enter UN number');
      const s = await getDoc(docRef('hazmat', q));
      if(s.exists()){
        const e = s.data();
        $('hazResult').innerHTML = `<div style="font-weight:800">${esc(e.name||'')}</div><div class="meta">Class: ${esc(e.hazard_class||'')}</div><div style="margin-top:8px"><strong>Flammability:</strong> ${esc(e.flammability||'—')}</div><div><strong>Water reactivity:</strong> ${esc(e.water_reactivity||'—')}</div><div style="margin-top:8px"><strong>Evacuation (small):</strong> ${esc(e.evac_small||e.evacuation_small||'—')}</div><div><strong>Evacuation (large):</strong> ${esc(e.evac_large||e.evacuation_large||'—')}</div><div style="margin-top:8px">${esc(e.notes||'')}</div>`;
      } else {
        $('hazResult').innerHTML = `<div class="meta">No record for UN ${esc(q)}. Admins can add entries.</div>`;
      }
    });

    $('btnHazAdmin').addEventListener('click', ()=> {
      if(!isAdmin()) return;
      showModal('Add/Edit HazMat', (root)=> {
        root.innerHTML = `<input id="hz_un" placeholder="UN number"/><input id="hz_name" placeholder="Common name"/><input id="hz_class" placeholder="Hazard class"/><input id="hz_flame" placeholder="Flammability"/><input id="hz_water" placeholder="Water reactivity"/><input id="hz_agent" placeholder="Extinguishing agent"/><textarea id="hz_notes" placeholder="Notes"></textarea>`;
      }, async ()=> {
        const un = $('hz_un').value.trim(); if(!un) return alert('UN required');
        const obj = { un, name:$('hz_name').value.trim(), hazard_class:$('hz_class').value.trim(), flammability:$('hz_flame').value.trim(), water_reactivity:$('hz_water').value.trim(), extinguishing_agent:$('hz_agent').value.trim(), notes:$('hz_notes').value.trim() };
        await setDoc(docRef('hazmat', un), obj); alert('Saved');
      });
    });

    // EV search
    $('btnEvSearch').addEventListener('click', async ()=> {
      const v = ($('evQuery').value||'').trim(); if(!v) return alert('Enter YMM or Make');
      const key = v.split(',')[1] ? v.split(',')[1].trim().toLowerCase().replace(/\s+/g,'_') : v.trim().toLowerCase().replace(/\s+/g,'_');
      const s = await getDoc(docRef('ev_guides', key));
      if(s.exists()){
        const d = s.data(); $('evResult').innerHTML = `<div style="font-weight:800">${esc(d.make||key)}</div><div style="margin-top:6px"><a href="${esc(d.url)}" target="_blank">${esc(d.url)}</a></div>`;
      } else $('evResult').innerHTML = `<div class="meta">No guide for "${esc(key)}". Admins can add guides.</div>`;
    });

    // Admin Manage Local Users (modal UI)
    $('manageUsers').addEventListener('click', ()=> {
      if(!isAdmin()) return;
      showModal('Manage Local Users', (root)=>{
        const users = loadLocalUsers();
        let html = `<div style="max-height:260px;overflow:auto">`;
        Object.keys(users).forEach(u => { html += `<div style="display:flex;justify-content:space-between;align-items:center;padding:6px;border-bottom:1px solid rgba(255,255,255,0.02)"><div><strong>${esc(u)}</strong><div class="meta">Role: ${esc(users[u].role||'')}</div></div><div><button class="btn small" data-user="${esc(u)}" data-act="editLocal">Edit</button> <button class="btn small" data-user="${esc(u)}" data-act="delLocal">Delete</button></div></div>`});
        html += `</div><div style="margin-top:8px"><button id="createLocal" class="btn primary">Create User</button></div>`;
        root.innerHTML = html;
        root.querySelectorAll('button[data-act="editLocal"]').forEach(btn=> btn.addEventListener('click', ()=> editLocalUser(btn.dataset.user)));
        root.querySelectorAll('button[data-act="delLocal"]').forEach(btn=> btn.addEventListener('click', ()=> { if(confirm('Delete '+btn.dataset.user+'?')){ const u=btn.dataset.user; const obj = loadLocalUsers(); delete obj[u]; saveLocalUsers(obj); alert('Deleted'); modal.style.display='none'; } }));
        root.querySelector('#createLocal').addEventListener('click', ()=> {
          showModal('Create Local User', (r)=> r.innerHTML=`<input id="lu_name" placeholder="Username"/><input id="lu_pass" placeholder="Password"/><select id="lu_role"><option>ADMIN</option><option>DEPT_ADMIN</option><option>DEPT_USER</option></select><input id="lu_dept" placeholder="Department (for DEPT_ADMIN/DEPT_USER)"/>`, async ()=> {
            const un = ($('lu_name').value||'').trim().toUpperCase(); if(!un) return alert('Username required'); const pw = $('lu_pass').value.trim(); const role = $('lu_role').value; const dept = $('lu_dept').value.trim();
            const obj = loadLocalUsers(); obj[un] = { password: pw||'changeme', role, dept }; saveLocalUsers(obj); alert('Saved');
          });
        });
      }, async ()=> {});
    });

    function editLocalUser(username){
      const users = loadLocalUsers();
      const u = users[username];
      showModal('Edit Local User', (r)=> r.innerHTML = `<div><strong>${esc(username)}</strong></div><input id="lu_pass" placeholder="Password" value="${esc(u.password||'')}" /><select id="lu_role"><option${u.role==='ADMIN'?' selected':''}>ADMIN</option><option${u.role==='DEPT_ADMIN'?' selected':''}>DEPT_ADMIN</option><option${u.role==='DEPT_USER'?' selected':''}>DEPT_USER</option></select><input id="lu_dept" placeholder="Department" value="${esc(u.dept||'')}" />`, async ()=> {
      const pw = $('lu_pass').value.trim(); const role = $('lu_role').value; const dept = $('lu_dept').value.trim();
      const obj = loadLocalUsers(); obj[username] = { password: pw||obj[username].password, role, dept }; saveLocalUsers(obj); alert('Saved');
    });

    // Utility & helpers
    function isAdmin(){ if(!CURRENT_USER){ alert('Please log in as admin'); return false; } if(CURRENT_USER.role!=='ADMIN'){ alert('Admin privileges required'); return false; } return true; }

    // Weather
    async function fetchWeather(){
      try{
        const r = await fetch('https://api.weather.gov/alerts/active?area=OSW');
        const j = await r.json();
        if(j && Array.isArray(j.features) && j.features.length) $('weatherBlock').textContent = j.features.map(f=> `${f.properties.event} — ${f.properties.areaDesc}`).join('\\n\\n');
        else $('weatherBlock').textContent = 'No active alerts';
      } catch(e){ $('weatherBlock').textContent = 'Weather service unavailable'; }
    }

    // initial show
    window.addEventListener('DOMContentLoaded', ()=> { showLogin(); });
  </script>
</body>
</html>
