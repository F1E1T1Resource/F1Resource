<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>F1 Resource — Oswego County</title>
  <style>
    /* Dark sidebar design (Design A) */
    :root{
      --bg:#071028;
      --panel:#0c1726;
      --accent:#0b5fff;
      --accent2:#7b5cff;
      --muted:#9aa6bd;
      --card:#0f1b2b;
      --radius:12px;
      --glass: rgba(255,255,255,0.03);
      --glass-border: rgba(255,255,255,0.04);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#031027,var(--bg));color:#e6eef9}
    a{color:inherit}
    /* Layout */
    .app{display:flex;min-height:100vh}
    .sidebar{width:260px;background:linear-gradient(180deg,var(--panel),#071323);padding:20px;flex-shrink:0;display:flex;flex-direction:column;gap:12px;border-right:1px solid rgba(255,255,255,0.03)}
    .logo{display:flex;gap:12px;align-items:center}
    .logo img{height:56px;border-radius:8px}
    .brand{font-weight:800;font-size:18px}
    .nav{display:flex;flex-direction:column;gap:6px;margin-top:12px}
    .nav button{background:transparent;border:none;color:var(--muted);text-align:left;padding:10px 12px;border-radius:10px;cursor:pointer;font-weight:700}
    .nav button:hover,.nav button.active{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#001020;transform:translateX(4px)}
    .main{flex:1;padding:20px;display:flex;flex-direction:column;gap:16px}
    .topbar{display:flex;justify-content:space-between;align-items:center}
    .site-title{font-size:20px;font-weight:800}
    .user-badge{color:var(--muted)}
    .card{background:var(--card);padding:16px;border-radius:var(--radius);border:1px solid var(--glass-border);box-shadow:0 8px 30px rgba(2,6,23,0.6)}
    .view{display:none}
    .view.active{display:block}
    .list{display:flex;flex-direction:column;gap:10px;margin-top:12px}
    .listItem{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);border:1px solid rgba(255,255,255,0.02)}
    .meta{color:var(--muted);font-size:13px}
    .btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:700}
    .btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#001020}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
    input,select,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:#e6eef9;margin:6px 0}
    .muted-block{color:var(--muted);font-size:13px}
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:9999}
    .modal-backdrop.show{display:flex}
    .modal{background:linear-gradient(180deg,#0b1624,#08121a);padding:18px;border-radius:12px;max-width:720px;width:96%;border:1px solid rgba(255,255,255,0.03)}
    /* Apparatus UI */
    .apparatus-root{max-width:980px;margin:18px auto}
    .incidentItem{padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:linear-gradient(180deg,#071428,transparent);margin-bottom:8px}
    .chatBox{min-height:120px;max-height:260px;overflow:auto;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent}
    /* Responsive */
    @media (max-width:900px){
      .sidebar{display:none}
      .mobileHeader{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:linear-gradient(180deg,#041028,#051428);border-bottom:1px solid rgba(255,255,255,0.03)}
      .drawer{position:fixed;left:0;top:0;height:100%;width:260px;background:linear-gradient(180deg,var(--panel),#071323);box-shadow:8px 0 30px rgba(0,0,0,0.6);transform:translateX(-120%);transition:transform .22s;z-index:1000;padding:20px}
      .drawer.open{transform:translateX(0)}
    }
  </style>
</head>
<body>
  <!-- LOGIN SCREEN -->
  <div id="loginScreen" style="min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;">
    <div class="card" style="max-width:880px;width:100%;display:flex;gap:18px;align-items:center">
      <div style="flex:0 0 88px"><img src="./logo.png" alt="logo" style="height:80px;border-radius:10px"></div>
      <div style="flex:1">
        <h2 style="margin:0 0 6px">F1 Resource — Login</h2>
        <div class="muted-block">Local login for testing. Use the demo accounts for now.</div>
        <div style="margin-top:12px;display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <input id="loginUser" placeholder="Username" />
          <input id="loginPass" placeholder="Password" type="password" />
        </div>
        <div style="display:flex;gap:8px;margin-top:12px">
          <button id="btnLogin" class="btn primary">Login</button>
          <button id="btnFill" class="btn ghost">Demo Fill</button>
        </div>
        <div id="loginMsg" style="color:#ff9b9b;margin-top:8px"></div>
        <div style="margin-top:12px;color:var(--muted)">Demo accounts: <strong>ADMIN/ADMIN</strong>, <strong>DEPTADMIN/DEPTADMIN</strong>, <strong>DEPTUSER/DEPTUSER</strong>, <strong>APPARATUS/APPARATUS</strong></div>
      </div>
    </div>
  </div>

  <!-- APP SPA (hidden until login) -->
  <div id="spa" class="app" style="display:none">
    <!-- Sidebar -->
    <aside class="sidebar" role="navigation" aria-label="Main navigation">
      <div class="logo">
        <img src="./logo.png" alt="logo"/>
        <div>
          <div class="brand">F1 Resource</div>
          <div class="meta" style="color:var(--muted);font-size:13px">Oswego County</div>
        </div>
      </div>

      <nav class="nav" aria-label="Pages">
        <button data-view="home" class="active">Home</button>
        <button data-view="departments">Fire Departments</button>
        <button data-view="ems">EMS Agencies</button>
        <button data-view="coordinators">County Coordinators</button>
        <button data-view="teams">County Teams</button>
        <button data-view="hazmat">HazMat Search</button>
        <button data-view="ev">EV Safety</button>
        <button data-view="risks">Fire & Driving Risk</button>
        <button data-view="weather">Weather</button>
        <button data-view="dispatch">Dispatch</button>
        <button data-view="admin">Admin</button>
        <button id="btnLogout" style="margin-top:8px" class="btn ghost">Logout</button>
      </nav>

      <div style="margin-top:auto;color:var(--muted)">&copy; F1 Resource</div>
    </aside>

    <!-- Main -->
    <main class="main">
      <div class="topbar">
        <div style="display:flex;gap:12px;align-items:center">
          <img src="./logo.png" style="height:56px;border-radius:8px" />
          <div>
            <div class="site-title">WELCOME</div>
            <div class="muted-block">This is F1 Resource — your all inclusive application for Oswego County.</div>
          </div>
        </div>
        <div id="userBadge" class="user-badge"></div>
      </div>

      <!-- Views -->
      <section id="home" class="view active card"><h3 style="margin:0">Home</h3><div class="muted-block" style="margin-top:8px">Home intentionally shows no sensitive lists.</div></section>

      <section id="departments" class="view card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>Fire Departments</strong><div class="muted-block">Manage fire departments</div></div>
          <div><button id="addDept" class="btn primary small">+ Add</button></div>
        </div>
        <div id="deptList" class="list"></div>
      </section>

      <section id="ems" class="view card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>EMS Agencies</strong></div>
          <div><button id="addEms" class="btn primary small">+ Add</button></div>
        </div>
        <div id="emsList" class="list"></div>
      </section>

      <section id="coordinators" class="view card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>County Coordinators</strong></div>
          <div><button id="addCoord" class="btn primary small">+ Add</button></div>
        </div>
        <div id="coordList" class="list"></div>
      </section>

      <section id="teams" class="view card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>County Teams</strong></div>
          <div><button id="addTeam" class="btn primary small">+ Add Team</button></div>
        </div>
        <div id="teamList" class="list"></div>
      </section>

      <section id="hazmat" class="view card">
        <h3 style="margin:0 0 8px">HazMat Search</h3>
        <div style="display:flex;gap:8px;">
          <input id="hazQuery" placeholder="UN/NA number (e.g. 1203)" />
          <button id="btnHazSearch" class="btn primary">Search</button>
          <button id="btnHazAdmin" class="btn ghost">Add/Edit</button>
        </div>
        <div id="hazResult" style="margin-top:12px"></div>
      </section>

      <section id="ev" class="view card">
        <h3 style="margin:0 0 8px">EV Safety</h3>
        <div style="display:flex;gap:8px">
          <input id="evQuery" placeholder="Year,Make,Model or VIN" />
          <button id="btnEvSearch" class="btn primary">Find</button>
        </div>
        <div id="evResult" style="margin-top:12px"></div>
      </section>

      <section id="risks" class="view card">
        <h3>Fire & Driving Risk</h3>
        <div id="riskBody" class="muted-block" style="margin-top:8px"></div>
      </section>

      <section id="weather" class="view card">
        <h3>Weather</h3>
        <div class="muted-block" style="margin-top:8px">Active weather alerts for Oswego County</div>
        <pre id="weatherBlock" style="white-space:pre-wrap;margin-top:8px;color:var(--muted)"></pre>
      </section>

      <section id="dispatch" class="view card">
        <h3>Dispatch (Admin View)</h3>
        <div class="muted-block" style="margin-top:8px">Admins & Dept Admins manage incidents here. Apparatus users get a dedicated dispatch UI after login (no nav).</div>
        <div style="display:flex;gap:8px;margin-top:12px">
          <button id="openDispatchAdmin" class="btn primary small">Open Dispatch Admin UI</button>
          <button id="quickCreate" class="btn ghost small">Quick Create</button>
        </div>
        <div id="dispatchAdminArea" style="margin-top:12px"></div>
      </section>

      <section id="admin" class="view card">
        <h3>Admin</h3>
        <div style="display:flex;gap:8px;margin-top:12px">
          <button id="manageUsers" class="btn primary">Manage Local Users</button>
          <button id="manageAlarms" class="btn ghost">Alarm Templates</button>
          <button id="manageHaz" class="btn ghost">Manage HazMat</button>
        </div>
      </section>

    </main>
  </div>

  <!-- APPARATUS MOBILE - separate interface -->
  <div id="apparatusUI" style="display:none;padding:12px;">
    <div class="apparatus-root card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><img src="./logo.png" style="height:48px;border-radius:8px"><div class="muted-block">APPARATUS MOBILE</div></div>
        <div><span id="appUser" class="muted-block"></span> <button id="appLogout" class="btn ghost">Logout</button></div>
      </div>

      <div style="margin-top:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>Incidents</strong></div>
          <div style="display:flex;gap:8px"><button id="appCreate" class="btn primary">Create Incident</button><button id="appArchiveView" class="btn ghost">Archive</button></div>
        </div>
        <div id="appActive" style="margin-top:12px"></div>
      </div>

      <div id="appCreatePanel" style="display:none;margin-top:12px">
        <div style="display:flex;flex-direction:column;gap:8px">
          <select id="appType"><option>FIRE</option><option>EMS</option><option>MISC</option></select>
          <input id="appAddr" placeholder="Address" />
          <input id="appNature" placeholder="Nature" />
          <textarea id="appDetails" placeholder="Details"></textarea>
          <div style="display:flex;gap:8px"><button id="appSubmit" class="btn primary">Submit</button><button id="appCancel" class="btn ghost">Cancel</button></div>
        </div>
      </div>

      <div id="appPanel" style="display:none;margin-top:12px">
        <div id="appIncidentTitle" style="font-weight:800"></div>
        <div id="appIncidentMeta" class="meta" style="margin-top:6px"></div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="appAttach" class="btn primary small">Attach</button>
          <button id="appDetach" class="btn ghost small" style="display:none">Detach</button>
          <button id="appAddAgency" class="btn ghost small">Add Agency</button>
          <div style="position:relative">
            <button id="appAlarmBtn" class="btn ghost small">Add Alarm ▾</button>
            <div id="appAlarmMenu" style="display:none;position:absolute;left:0;top:34px;background:var(--panel);padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03)">
              <div><button class="btn small alarmOpt" data-temp="first">1st Alarm</button></div>
              <div><button class="btn small alarmOpt" data-temp="second">2nd Alarm</button></div>
              <div><button class="btn small alarmOpt" data-temp="third">3rd Alarm</button></div>
            </div>
          </div>
          <button id="appAddDetail" class="btn ghost small">Add Detail</button>
        </div>

        <div style="margin-top:12px">
          <div><strong>Units & Status</strong></div>
          <div id="appUnits" style="margin-top:8px"></div>

          <div style="margin-top:12px"><strong>Update Status</strong>
            <div style="display:flex;gap:8px;margin-top:8px">
              <button class="btn ghost statusBtn" data-status="Acknowledged">Acknowledged</button>
              <button class="btn ghost statusBtn" data-status="Responding">Responding</button>
              <button class="btn ghost statusBtn" data-status="Staged">Staged</button>
              <button class="btn ghost statusBtn" data-status="Arrived">Arrived</button>
              <button class="btn ghost statusBtn" data-status="Returning">Returning</button>
              <button class="btn ghost statusBtn" data-status="Clear">Clear</button>
            </div>
          </div>

          <div style="margin-top:12px"><strong>Timeline</strong><div id="appTimeline" class="muted-block" style="margin-top:6px"></div></div>

          <div style="margin-top:12px"><strong>Chat</strong>
            <div id="appChat" class="chatBox" style="margin-top:8px"></div>
            <div style="display:flex;gap:8px;margin-top:8px">
              <input id="appChatInput" placeholder="Message..." />
              <button id="appSend" class="btn primary">Send</button>
            </div>
          </div>

        </div>
      </div>

    </div>
  </div>

  <!-- Modal -->
  <div id="modal" class="modal-backdrop"><div class="modal"><h3 id="modalTitle"></h3><div id="modalBody"></div><div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px"><button id="modalCancel" class="btn ghost">Cancel</button><button id="modalSave" class="btn primary">Save</button></div></div></div>

  <!-- SCRIPT: single clean module, no duplicate imports -->
  <script type="module">
  // ********** Firebase imports **********
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import {
    getFirestore, collection, doc, getDoc, getDocs, addDoc, setDoc, deleteDoc,
    onSnapshot, query, orderBy, where
  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  // ********** Firebase config (user-provided) **********
  const firebaseConfig = {
    apiKey: "AIzaSyBi0Xyljx7zzXTmyyRMAru11hZ2s5S3tsw",
    authDomain: "f1resource-8fedc.firebaseapp.com",
    projectId: "f1resource-8fedc",
    storageBucket: "f1resource-8fedc.firebasestorage.app",
    messagingSenderId: "182745701982",
    appId: "1:182745701982:web:9f4f3836b41b450987decf"
  };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // ********** Helpers **********
  const $ = id => document.getElementById(id);
  const now = () => new Date().toISOString();
  const esc = s => s ? String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;') : '';
  const ROOT_COL = 'f1root', ROOT_DOC = 'f1resource';
  const subCol = (name) => collection(db, ROOT_COL, ROOT_DOC, name);
  const docRef = (col,id) => doc(db, ROOT_COL, ROOT_DOC, col, id);

  // ********** Local login users (case-insensitive username) **********
  const LOCAL_USERS = {
    "ADMIN": { password: "ADMIN", role: "ADMIN" },
    "DEPTADMIN": { password: "DEPTADMIN", role: "DEPTADMIN", dept: "Central Sq FD" },
    "DEPTUSER": { password: "DEPTUSER", role: "DEPTUSER", dept: "Central Sq FD" },
    "APPARATUS": { password: "APPARATUS", role: "APPARATUS", dept: "Central Sq FD", apparatusName: "Engine 511" }
  };

  // ********** Session storage **********
  function saveSession(obj){ localStorage.setItem('f1_user', JSON.stringify(obj)); }
  function loadSession(){ try{ return JSON.parse(localStorage.getItem('f1_user')); }catch(e){return null} }
  function clearSession(){ localStorage.removeItem('f1_user'); }

  // ********** Modal helpers **********
  const modal = $('modal'), modalTitle = $('modalTitle'), modalBody = $('modalBody'), modalCancel = $('modalCancel'), modalSave = $('modalSave');
  function showModal(title, buildFn, onSave){
    modalTitle.textContent = title; modalBody.innerHTML = ''; buildFn(modalBody);
    modal.classList.add('show'); modal.style.display='flex';
    modalSave.onclick = async ()=>{ await onSave(); modal.style.display='none'; modalBody.innerHTML=''; modalSave.onclick=null; };
    modalCancel.onclick = ()=>{ modal.style.display='none'; modalBody.innerHTML=''; modalSave.onclick=null; };
  }

  // ********** Login handling **********
  $('btnFill').addEventListener('click', ()=>{ $('loginUser').value='ADMIN'; $('loginPass').value='ADMIN'; });
  $('btnLogin').addEventListener('click', ()=>{
    const usernameRaw = ($('loginUser').value||'').trim();
    const password = ($('loginPass').value||'').trim();
    if(!usernameRaw || !password){ $('loginMsg').textContent = 'Enter username and password'; return; }
    const username = usernameRaw.toUpperCase();
    const user = LOCAL_USERS[username];
    if(!user || user.password !== password){ $('loginMsg').textContent = 'Invalid credentials'; return; }
    $('loginMsg').textContent = '';
    const session = { username, role: user.role, dept: user.dept || null, apparatusName: user.apparatusName || null };
    saveSession(session);
    boot(session);
  });

  // app state
  let CURRENT_USER = null;

  // attempt restore
  const prev = loadSession();
  if(prev) boot(prev); else $('loginScreen').style.display='flex';

  // ********** Boot main app or apparatus UI **********
  function boot(session){
    CURRENT_USER = session;
    if(CURRENT_USER.role === 'APPARATUS'){
      // show apparatus UI only
      $('loginScreen').style.display='none';
      $('spa').style.display='none';
      $('apparatusUI').style.display='block';
      $('appUser').textContent = `${CURRENT_USER.username}${CURRENT_USER.apparatusName? ' • '+CURRENT_USER.apparatusName:''}`;
      initApparatus();
      return;
    }
    // show SPA
    $('loginScreen').style.display='none';
    $('apparatusUI').style.display='none';
    $('spa').style.display='flex';
    $('userBadge').textContent = `${CURRENT_USER.username} — ${CURRENT_USER.role}${CURRENT_USER.dept ? ' • '+CURRENT_USER.dept : ''}`;
    setupNavigation();
    setupRealtimeLists();
  }

  // Logout hooks
  $('btnLogout')?.addEventListener('click', ()=>{ clearSession(); location.reload(); });
  $('appLogout')?.addEventListener('click', ()=>{ clearSession(); location.reload(); });

  // ********** Navigation (SPA) **********
  function setupNavigation(){
    document.querySelectorAll('.nav button[data-view]').forEach(btn=>{
      btn.addEventListener('click', ()=> {
        const view = btn.dataset.view;
        setView(view);
      });
    });
    setView('home');
  }
  function setView(id){
    document.querySelectorAll('.view').forEach(v=> v.classList.remove('active'));
    const el = document.getElementById(id);
    if(el) el.classList.add('active');
    document.querySelectorAll('.nav button[data-view]').forEach(b=> b.classList.toggle('active', b.dataset.view === id));
  }

  // ********** Realtime lists (departments, ems, coordinators, teams) **********
  function setupRealtimeLists(){
    // fire_departments
    onSnapshot(query(subCol('fire_departments')), snap=>{
      const data = {}; snap.forEach(d=> data[d.id] = d.data()); renderDepartments(data);
    });
    onSnapshot(query(subCol('ems_agencies')), snap=>{
      const data = {}; snap.forEach(d=> data[d.id] = d.data()); renderEMS(data);
    });
    onSnapshot(query(subCol('coordinators')), snap=>{
      const data = {}; snap.forEach(d=> data[d.id] = d.data()); renderCoordinators(data);
    });
    onSnapshot(query(subCol('county_teams')), snap=>{
      const data = {}; snap.forEach(d=> data[d.id] = d.data()); renderTeams(data);
    });
    // incidents watched in apparatus admin area and dispatch admin
    // alarm_templates/hazmat/ev read on-demand
    // weather alerts
    fetchWeather();
  }

  // render functions
  function renderDepartments(map){
    const target = $('deptList'); target.innerHTML = '';
    Object.entries(map||{}).forEach(([id,d])=>{
      const div = document.createElement('div'); div.className='listItem';
      div.innerHTML = `<div><div style="font-weight:800">${esc(d.name||'Unnamed')}</div><div class="meta">${esc(d.battalion||'')} ${d.address? ' • '+esc(d.address):''}</div></div>
        <div style="display:flex;gap:8px"><button data-id="${id}" class="btn small viewDept">View</button>${isAdminish()? `<button data-id="${id}" class="btn small editDept">Edit</button>`:''}</div>`;
      target.appendChild(div);
    });
    // attach handlers
    target.querySelectorAll('.viewDept').forEach(b=> b.addEventListener('click', ()=> openDept(b.dataset.id)));
    target.querySelectorAll('.editDept').forEach(b=> b.addEventListener('click', ()=> editDept(b.dataset.id)));
  }
  function renderEMS(map){
    const target = $('emsList'); target.innerHTML='';
    Object.entries(map||{}).forEach(([id,e])=>{
      const div=document.createElement('div'); div.className='listItem';
      div.innerHTML = `<div><div style="font-weight:800">${esc(e.name||'Unnamed')}</div><div class="meta">${esc(e.address||'')}</div></div><div><button data-id="${id}" class="btn small viewEms">View</button></div>`;
      target.appendChild(div);
    });
    target.querySelectorAll('.viewEms').forEach(b=> b.addEventListener('click', ()=> openEms(b.dataset.id)));
  }
  function renderCoordinators(map){
    const target = $('coordList'); target.innerHTML='';
    Object.entries(map||{}).forEach(([id,c])=>{
      const div=document.createElement('div'); div.className='listItem';
      div.innerHTML = `<div><div style="font-weight:800">${esc(c.name||'')}</div><div class="meta">${esc(c.callsign||'')}</div></div>`;
      target.appendChild(div);
    });
  }
  function renderTeams(map){
    const target = $('teamList'); target.innerHTML='';
    Object.entries(map||{}).forEach(([id,t])=>{
      const div=document.createElement('div'); div.className='listItem';
      div.innerHTML = `<div><div style="font-weight:800">${esc(t.name||'')}</div><div class="meta">${esc(t.lead||'')}</div></div>`;
      target.appendChild(div);
    });
  }

  // ********** Simple CRUD actions (Admin) **********
  $('addDept').addEventListener('click', ()=> {
    if(!isAdminish()) return alert('Admin only');
    showModal('Add Department', (root)=> {
      root.innerHTML = `<input id="md_name" placeholder="Name"/><input id="md_batt" placeholder="Battalion"/><input id="md_addr" placeholder="Address"/><input id="md_apps" placeholder="Apparatus (use | to separate)"/>`;
    }, async ()=> {
      const name = $('md_name').value.trim()||'Unnamed';
      const batt = $('md_batt').value.trim();
      const addr = $('md_addr').value.trim();
      const apps = $('md_apps').value.trim();
      await addDoc(subCol('fire_departments'), { name, battalion: batt, address: addr, apparatus: apps });
    });
  });
  $('addEms').addEventListener('click', ()=> {
    if(!isAdminish()) return alert('Admin only');
    showModal('Add EMS Agency', (r)=> r.innerHTML = `<input id="me_name" placeholder="Name"/><input id="me_addr" placeholder="Address"/>`, async ()=> {
      const name = $('me_name').value.trim()||'Unnamed'; const addr = $('me_addr').value.trim();
      await addDoc(subCol('ems_agencies'), { name, address: addr });
    });
  });
  $('addCoord').addEventListener('click', ()=> {
    if(!isAdminish()) return alert('Admin only');
    showModal('Add Coordinator', (r)=> r.innerHTML = `<input id="mc_name" placeholder="Name"/><input id="mc_calls" placeholder="Callsign"/>`, async ()=> {
      const name = $('mc_name').value.trim(); if(!name) return alert('Name required'); const calls = $('mc_calls').value.trim();
      await addDoc(subCol('coordinators'), { name, callsign: calls });
    });
  });
  $('addTeam').addEventListener('click', ()=> {
    if(!isAdminish()) return alert('Admin only');
    showModal('Add Team', (r)=> r.innerHTML = `<input id="mt_name" placeholder="Name"/><input id="mt_lead" placeholder="Lead"/><input id="mt_caps" placeholder="Capabilities (| separated)"/>`, async ()=> {
      const n = $('mt_name').value.trim()||'Unnamed', lead = $('mt_lead').value.trim(), caps = $('mt_caps').value.trim();
      await addDoc(subCol('county_teams'), { name:n, lead, capabilities: caps });
    });
  });

  // view department - shows details (including apparatus as bullet list)
  async function openDept(id){
    const s = await getDoc(docRef('fire_departments', id));
    if(!s.exists()) return alert('Not found');
    const d = s.data();
    showModal(`Department: ${d.name||''}`, (root)=>{
      root.innerHTML = `<div><strong>${esc(d.name||'')}</strong><div class="meta">${esc(d.address||'')}</div><div style="margin-top:8px"><strong>Apparatus</strong><ul>${(d.apparatus||'').split('|').map(x=>`<li>${esc(x.trim())}</li>`).join('')}</ul></div></div>`;
    }, async ()=> {});
  }
  async function editDept(id){
    if(!isAdminish()) return alert('Admin only');
    const s = await getDoc(docRef('fire_departments', id));
    if(!s.exists()) return alert('Not found');
    const d = s.data();
    showModal('Edit Department', (root)=> {
      root.innerHTML = `<input id="ed_name" value="${esc(d.name||'')}" /><input id="ed_batt" value="${esc(d.battalion||'')}" /><input id="ed_addr" value="${esc(d.address||'')}" /><input id="ed_apps" value="${esc(d.apparatus||'')}" />`;
    }, async ()=> {
      const obj = { name: $('ed_name').value.trim(), battalion: $('ed_batt').value.trim(), address: $('ed_addr').value.trim(), apparatus: $('ed_apps').value.trim() };
      await setDoc(docRef('fire_departments', id), obj);
      alert('Saved');
    });
  }

  // wrappers for firestore getDoc with safety
  async function getDoc(ref){ try{ return await getDocRaw(ref); }catch(e){ console.error(e); return { exists:()=>false }; } }
  // to avoid collision with imported getDoc, use direct name alias
  import { getDoc as getDocRaw } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  // ********** HazMat search **********
  $('btnHazSearch').addEventListener('click', async ()=>{
    const q = ($('hazQuery').value||'').trim();
    if(!q) return alert('Enter UN number');
    const s = await getDoc(docRef('hazmat', q));
    if(s.exists()){
      const e = s.data();
      $('hazResult').innerHTML = `<div style="font-weight:800">${esc(e.name||'')}</div><div class="meta">Class: ${esc(e.hazard_class||'')}</div><div style="margin-top:8px"><strong>Flammability:</strong> ${esc(e.flammability||'—')}</div><div><strong>Water reactivity:</strong> ${esc(e.water_reactivity||'—')}</div><div style="margin-top:8px"><strong>Evacuation (small):</strong> ${esc(e.evac_small||e.evacuation_small||'—')}</div><div><strong>Evacuation (large):</strong> ${esc(e.evac_large||e.evacuation_large||'—')}</div><div style="margin-top:8px">${esc(e.notes||'')}</div>`;
    } else {
      $('hazResult').innerHTML = `<div class="meta">No record for UN ${esc(q)}. Admins can add entries.</div>`;
    }
  });
  $('btnHazAdmin').addEventListener('click', ()=> {
    if(!isAdminish()) return alert('Admin only');
    showModal('Add / Edit HazMat', (root)=> {
      root.innerHTML = `<input id="hz_un" placeholder="UN number"/><input id="hz_name" placeholder="Common name"/><input id="hz_class" placeholder="Hazard class"/><input id="hz_flame" placeholder="Flammability"/><input id="hz_water" placeholder="Water reactivity"/><input id="hz_agent" placeholder="Extinguishing agent"/><textarea id="hz_notes" placeholder="Notes"></textarea>`;
    }, async ()=> {
      const un = $('hz_un').value.trim(); if(!un) return alert('UN required');
      const obj = { un, name:$('hz_name').value.trim(), hazard_class:$('hz_class').value.trim(), flammability:$('hz_flame').value.trim(), water_reactivity:$('hz_water').value.trim(), extinguishing_agent:$('hz_agent').value.trim(), notes:$('hz_notes').value.trim() };
      await setDoc(docRef('hazmat', un), obj);
      alert('Saved');
    });
  });

  // ********** EV lookup admin **********
  $('btnEvSearch').addEventListener('click', async ()=>{
    const v = ($('evQuery').value||'').trim();
    if(!v) return alert('Enter YMM or VIN');
    // simple: search ev_guides by key guess (make)
    const key = v.split(',')[1] ? v.split(',')[1].trim().toLowerCase().replace(/\s+/g,'_') : v.trim().toLowerCase().replace(/\s+/g,'_');
    const s = await getDoc(docRef('ev_guides', key));
    if(s.exists()){
      const d = s.data();
      $('evResult').innerHTML = `<div style="font-weight:800">${esc(d.make||key)}</div><div style="margin-top:6px"><a href="${esc(d.url)}" target="_blank">${esc(d.url)}</a></div>`;
    } else {
      $('evResult').innerHTML = `<div class="meta">No manufacturer guide found for "${esc(key)}". Admins can add guides.</div>`;
    }
  });

  // admins can add EV guides via Manage Haz/Alarms flow if needed — omitted for brevity

  // ********** Dispatch system (incidents) - real-time **********
  // onSnapshot for incidents collection
  onSnapshot(query(subCol('incidents')), snap=>{
    // populate dispatch admin area and keep incidents cache
    const incidents = {};
    snap.forEach(d=> incidents[d.id] = d.data());
    renderDispatchAdmin(incidents);
    renderAppActive(incidents);
  });

  function renderDispatchAdmin(incidents){
    const area = $('dispatchAdminArea'); area.innerHTML = '';
    const keys = Object.keys(incidents).sort((a,b)=> (incidents[b].createdAt||'').localeCompare(incidents[a].createdAt||''));
    keys.forEach(id=>{
      const it = incidents[id];
      const div = document.createElement('div'); div.className='incidentItem';
      div.innerHTML = `<div style="display:flex;justify-content:space-between"><div><strong>${esc(it.type||'INC')}</strong><div class="meta">${esc(it.address||'')} • ${esc(it.nature||'')}</div></div><div><button class="btn small" data-id="${id}" data-act="open">Open</button></div></div>`;
      area.appendChild(div);
    });
    area.querySelectorAll('button[data-act="open"]').forEach(b=> b.addEventListener('click', ()=> openIncAdmin(b.dataset.id)));
  }
  async function openIncAdmin(id){
    setView('dispatch');
    $('dispatchAdminArea').innerHTML = `<div class="incidentItem">Open incident ${esc(id)} — use apparatus UI or admin tools.</div>`;
  }

  // Apparatus render (list & open)
  function renderAppActive(incidents){
    const target = $('appActive'); if(!target) return;
    target.innerHTML = '';
    const keys = Object.keys(incidents).sort((a,b)=> (incidents[b].createdAt||'').localeCompare(incidents[a].createdAt||''));
    keys.forEach(id=>{
      const it = incidents[id];
      if(it.archived) return;
      const div = document.createElement('div'); div.className='incidentItem';
      div.innerHTML = `<div style="display:flex;justify-content:space-between"><div><strong>${esc(it.type||'INCIDENT')}</strong><div class="meta">${esc(it.address||'')}</div></div><div><button data-id="${id}" class="btn small openApp">Open</button></div></div>`;
      target.appendChild(div);
    });
    target.querySelectorAll('.openApp').forEach(b=> b.addEventListener('click', ()=> openAppIncident(b.dataset.id)));
  }

  // store selected app incident id
  let APP_SELECTED = null;
  async function openAppIncident(id){
    APP_SELECTED = id;
    const s = await getDoc(docRef('incidents', id));
    if(!s.exists()) return alert('Incident not found');
    const inc = s.data();
    $('appPanel').style.display='block';
    $('appCreatePanel').style.display='none';
    $('appIncidentTitle').textContent = `${esc(inc.type||'INCIDENT')} — ${esc(inc.address||'')}`;
    $('appIncidentMeta').textContent = `Created: ${inc.createdAt||''} • By: ${esc(inc.createdBy||'')}${inc.creatorApparatus? ' • '+esc(inc.creatorApparatus):''}`;
    renderAppUnits(inc);
    renderAppTimeline(inc);
    renderAppChat(inc);
  }

  function renderAppUnits(inc){
    const out = $('appUnits'); out.innerHTML = '';
    (inc.unitsAttached||[]).forEach(u=>{
      const node = document.createElement('div'); node.style.marginBottom='6px';
      node.innerHTML = `<div style="font-weight:700">${esc(u.apparatus||u.unitId)}</div><div class="meta">${esc(u.agency||'')} • ${esc(u.status||'')}</div><div class="meta">${(u.statusHistory||[]).map(h=> `${esc(h.status)} @ ${esc(h.ts)}`).join(' | ')}</div>`;
      out.appendChild(node);
    });
  }
  function renderAppTimeline(inc){
    const t = $('appTimeline'); t.innerHTML = '';
    const timeline = [];
    (inc.statusUpdates||[]).forEach(s=> timeline.push({ts:s.ts, txt:`${s.unitId} → ${s.status}`}));
    (inc.details||[]).forEach(d=> timeline.push({ts:d.ts, txt:`Detail by ${d.by}: ${d.text}`}));
    (inc.messages||[]).forEach(m=> timeline.push({ts:m.ts, txt:`${m.sender}: ${m.text}`}));
    timeline.sort((a,b)=> (a.ts||'').localeCompare(b.ts||''));
    timeline.forEach(item=> { const div=document.createElement('div'); div.className='meta'; div.textContent = `${item.ts} — ${item.txt}`; t.appendChild(div); });
  }
  function renderAppChat(inc){
    const c = $('appChat'); c.innerHTML = '';
    (inc.messages||[]).forEach(m=> { const d=document.createElement('div'); d.innerHTML = `<div style="font-weight:700">${esc(m.sender)}</div><div class="meta">${esc(m.text)}</div><div class="meta">${esc(m.ts)}</div>`; c.appendChild(d); });
  }

  // apparatus actions (create, attach, status, add agency, alarm, chat, detail, archive)
  $('appCreate').addEventListener('click', ()=> { $('appCreatePanel').style.display='block'; $('appPanel').style.display='none'; });
  $('appCancel').addEventListener('click', ()=> { $('appCreatePanel').style.display='none'; });
  $('appSubmit').addEventListener('click', async ()=>{
    const obj = { createdAt: now(), createdBy: CURRENT_USER.username, creatorDept: CURRENT_USER.dept||'', creatorApparatus: CURRENT_USER.apparatusName||'', type: $('appType').value, address:$('appAddr').value.trim(), nature:$('appNature').value.trim(), details:$('appDetails').value.trim(), isClosed:false, archived:false, unitsAttached:[], statusUpdates:[], messages:[], details:[]};
    const ref = await addDoc(subCol('incidents'), obj);
    $('appCreatePanel').style.display='none';
    openAppIncident(ref.id);
  });

  $('appAttach').addEventListener('click', async ()=>{
    if(!APP_SELECTED) return alert('Select incident');
    const ref = docRef('incidents', APP_SELECTED);
    const s = await getDoc(ref); if(!s.exists()) return;
    const inc = s.data();
    inc.unitsAttached = inc.unitsAttached || [];
    const unitId = CURRENT_USER.username;
    if(inc.unitsAttached.some(u=> u.unitId === unitId)) { alert('Already attached'); return; }
    const newUnit = { unitId, agency: CURRENT_USER.dept||'', apparatus: CURRENT_USER.apparatusName||unitId, status:'Acknowledged', statusHistory:[{status:'Acknowledged', ts: now(), by: unitId}] };
    inc.unitsAttached.push(newUnit);
    inc.statusUpdates.push({ unitId, status:'Acknowledged', ts: now() });
    await setDoc(ref, inc);
    openAppIncident(APP_SELECTED);
  });
  $('appDetach').addEventListener('click', async ()=>{
    if(!APP_SELECTED) return;
    const ref = docRef('incidents', APP_SELECTED); const s = await getDoc(ref); if(!s.exists()) return;
    const inc = s.data(); inc.unitsAttached = (inc.unitsAttached||[]).filter(u=> u.unitId !== CURRENT_USER.username);
    await setDoc(ref, inc); openAppIncident(APP_SELECTED);
  });

  // status update buttons
  document.querySelectorAll('.statusBtn').forEach(b=> b.addEventListener('click', async (e)=>{
    if(!APP_SELECTED) return alert('Select incident');
    const status = e.currentTarget.dataset.status;
    const ref = docRef('incidents', APP_SELECTED); const s = await getDoc(ref); if(!s.exists()) return;
    const inc = s.data(); const u = (inc.unitsAttached||[]).find(x=> x.unitId === CURRENT_USER.username);
    if(!u) return alert('You are not attached to this incident');
    u.status = status; u.statusHistory = u.statusHistory || []; u.statusHistory.push({ status, ts: now(), by: CURRENT_USER.username });
    inc.statusUpdates = inc.statusUpdates || []; inc.statusUpdates.push({ unitId: CURRENT_USER.username, status, ts: now() });
    if(status === 'Clear'){
      const stillActive = (inc.unitsAttached||[]).some(x => x.status !== 'Clear');
      if(!stillActive){ inc.isClosed = true; inc.closedAt = now(); }
    }
    await setDoc(ref, inc);
    openAppIncident(APP_SELECTED);
  }));

  // add agency (choose from departments)
  $('appAddAgency').addEventListener('click', async ()=>{
    if(!APP_SELECTED) return alert('Select incident');
    const deptsSnap = await getDocs(subCol('fire_departments'));
    const options = [];
    deptsSnap.forEach(d=> options.push( d.data().name ));
    showModal('Add Agency', (root)=> {
      root.innerHTML = `<select id="selAgency"><option value="">--Select--</option>${options.map(o=>`<option>${esc(o)}</option>`).join('')}</select>`;
    }, async ()=> {
      const chosen = $('selAgency').value; if(!chosen) return alert('Pick one');
      const ref = docRef('incidents', APP_SELECTED); const s = await getDoc(ref); if(!s.exists()) return;
      const inc = s.data(); const uid = `${chosen.replace(/\s+/g,'_')}_${Math.random().toString(36).slice(2,5)}`;
      inc.unitsAttached = inc.unitsAttached || []; inc.unitsAttached.push({ unitId: uid, agency: chosen, apparatus: chosen, status:'Acknowledged', statusHistory:[{status:'Acknowledged', ts: now(), by:'SYSTEM'}] });
      inc.statusUpdates = inc.statusUpdates || []; inc.statusUpdates.push({ unitId: uid, status:'Acknowledged', ts: now() });
      await setDoc(ref, inc); openAppIncident(APP_SELECTED);
    });
  });

  // alarm templates menu
  $('appAlarmBtn').addEventListener('click', ()=> { $('appAlarmMenu').style.display = $('appAlarmMenu').style.display === 'block' ? 'none' : 'block'; });
  document.querySelectorAll('.alarmOpt').forEach(btn=> btn.addEventListener('click', async (e)=>{
    const key = e.currentTarget.dataset.temp; if(!APP_SELECTED) return alert('Select incident');
    const t = await getDoc(docRef('alarm_templates', key));
    if(!t.exists()) return alert('Template empty');
    const units = t.data().units || []; const ref = docRef('incidents', APP_SELECTED); const s = await getDoc(ref); if(!s.exists()) return;
    const inc = s.data();
    units.forEach(deptName => {
      const uid = `${deptName.replace(/\s+/g,'_')}_${Math.random().toString(36).slice(2,5)}`;
      inc.unitsAttached = inc.unitsAttached || []; inc.unitsAttached.push({ unitId: uid, agency: deptName, apparatus: deptName, status:'Acknowledged', statusHistory:[{status:'Acknowledged', ts: now(), by:'SYSTEM'}] });
      inc.statusUpdates = inc.statusUpdates || []; inc.statusUpdates.push({ unitId: uid, status:'Acknowledged', ts: now() });
    });
    await setDoc(ref, inc); openAppIncident(APP_SELECTED); $('appAlarmMenu').style.display='none';
  }));

  // add detail
  $('appAddDetail').addEventListener('click', async ()=> {
    if(!APP_SELECTED) return alert('Select incident');
    const text = prompt('Add a detail'); if(!text) return;
    const ref = docRef('incidents', APP_SELECTED); const s = await getDoc(ref); if(!s.exists()) return;
    const inc = s.data(); inc.details = inc.details || []; inc.details.push({ by: CURRENT_USER.username, text, ts: now() });
    await setDoc(ref, inc); openAppIncident(APP_SELECTED);
  });

  // chat
  $('appSend').addEventListener('click', async ()=>{
    if(!APP_SELECTED) return alert('Select incident');
    const txt = $('appChatInput').value.trim(); if(!txt) return;
    const ref = docRef('incidents', APP_SELECTED); const s = await getDoc(ref); if(!s.exists()) return;
    const inc = s.data(); inc.messages = inc.messages || []; inc.messages.push({ sender: CURRENT_USER.username, text: txt, ts: now() });
    await setDoc(ref, inc); $('appChatInput').value=''; openAppIncident(APP_SELECTED);
  });

  // archive view for apparatus (last 3 months)
  $('appArchiveView').addEventListener('click', async ()=> {
    const snap = await getDocs(subCol('incidents'));
    const arr = []; const three = Date.now() - 90*24*60*60*1000;
    snap.forEach(d=>{ const val = d.data(); if(val.archived && new Date(val.archivedAt || 0).getTime() >= three) arr.push({ id: d.id, ...val }); });
    $('appActive').innerHTML = ''; if(!arr.length) $('appActive').innerHTML = '<div class="meta">No archived incidents</div>';
    arr.forEach(it=>{ const div = document.createElement('div'); div.className='incidentItem'; div.innerHTML = `<div style="display:flex;justify-content:space-between"><div><strong>${esc(it.type)}</strong><div class="meta">${esc(it.address||'')}</div></div><div><button data-id="${it.id}" class="btn small openApp">Open</button></div></div>`; $('appActive').appendChild(div); });
    $('appActive').querySelectorAll('.openApp').forEach(b=> b.addEventListener('click', ()=> openAppIncident(b.dataset.id)));
  });

  // ********** Utility wrappers using the imported names **********
  async function getDocs(collRef){ return await getDocsModule(collRef); }
  // alias imported getDocs as getDocsModule
  import { getDocs as getDocsModule } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  // ********** Weather alerts (NWS) **********
  async function fetchWeather(){
    try{
      const r = await fetch('https://api.weather.gov/alerts/active?area=OSW');
      const j = await r.json();
      if(j && Array.isArray(j.features) && j.features.length) {
        $('weatherBlock').textContent = j.features.map(f=> `${f.properties.event} — ${f.properties.areaDesc}`).join('\\n\\n');
      } else $('weatherBlock').textContent = 'No active alerts';
    } catch(e){ $('weatherBlock').textContent = 'Weather service unavailable'; }
  }
  fetchWeather();

  // ********** Helpers **********
  function isAdminish(){ return CURRENT_USER && (CURRENT_USER.role === 'ADMIN' || CURRENT_USER.role === 'DEPTADMIN'); }

  // ********** Safe small getDoc wrapper for docRef ******
  // (we already used getDoc alias earlier)
  // END module
  </script>
</body>
</html>
