<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>F1 Resource — Dispatch (Apparatus Mobile)</title>
  <style>
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#021023,#04182b);color:#e6eef9}
    .wrap{max-width:980px;margin:18px auto;padding:12px}
    .card{background:linear-gradient(180deg,#0b1624,#08121a);padding:16px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
    input,textarea,select{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:#e6eef9;margin:6px 0}
    .btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:700}
    .btn.primary{background:linear-gradient(90deg,#0b5fff,#7b5cff);color:#001020}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:#9aa6bd}
    .incidentItem{padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);margin-bottom:8px}
    .chatBox{min-height:120px;max-height:260px;overflow:auto;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03)}
    .muted{color:#9aa6bd}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" id="loginCard">
      <div style="display:flex;align-items:center;gap:12px">
        <img src="logo.png" style="height:56px;border-radius:8px">
        <div>
          <h2 style="margin:0">Apparatus Mobile Login</h2>
          <div class="muted" style="margin-top:6px">Local apparatus accounts for field units.</div>
        </div>
      </div>

      <div style="margin-top:12px">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <input id="apUser" placeholder="Username"/>
          <input id="apPass" placeholder="Password" type="password"/>
        </div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="apLogin" class="btn primary">Login</button>
          <button id="apFill" class="btn ghost">Demo Fill</button>
          <button id="toMain" class="btn ghost" style="margin-left:auto">Back to Main App</button>
        </div>
        <div id="apMsg" style="color:#ff9b9b;margin-top:8px"></div>
      </div>
    </div>

    <!-- Apparatus UI -->
    <div id="appUI" style="display:none">
      <div class="card" style="margin-top:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><img src="logo.png" style="height:44px;border-radius:6px"><div class="muted" id="appUserLabel"></div></div>
          <div><button id="apLogout" class="btn ghost">Logout</button></div>
        </div>

        <div style="margin-top:12px;display:flex;justify-content:space-between;align-items:center">
          <div><strong>Incidents</strong><div class="muted">Create or attach to incidents</div></div>
          <div style="display:flex;gap:8px"><button id="createBtn" class="btn primary">Create Incident</button><button id="archiveBtn" class="btn ghost">Archived</button></div>
        </div>

        <div id="incidentList" style="margin-top:12px"></div>
      </div>

      <div id="createPanel" class="card" style="margin-top:12px;display:none">
        <h3 style="margin:0">Create Incident</h3>
        <select id="incType"><option>FIRE</option><option>EMS</option><option>MISC</option></select>
        <input id="incAddress" placeholder="Address"/>
        <input id="incNature" placeholder="Nature"/>
        <textarea id="incDetails" placeholder="Details"></textarea>
        <div style="display:flex;gap:8px;margin-top:8px"><button id="submitInc" class="btn primary">Submit</button><button id="cancelInc" class="btn ghost">Cancel</button></div>
      </div>

      <div id="incidentPanel" class="card" style="margin-top:12px;display:none">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><div id="incTitle" style="font-weight:800"></div><div id="incMeta" class="muted" style="margin-top:6px"></div></div>
          <div style="display:flex;gap:8px">
            <button id="attachBtn" class="btn primary">Attach</button>
            <button id="detachBtn" class="btn ghost" style="display:none">Detach</button>
            <button id="archiveIncBtn" class="btn ghost">Archive</button>
          </div>
        </div>

        <div style="margin-top:12px">
          <div><strong>Units & Status</strong><div id="unitsBlock" style="margin-top:8px"></div></div>

          <div style="margin-top:12px"><strong>Update Status</strong>
            <div style="display:flex;gap:8px;margin-top:8px">
              <button class="btn ghost statusBtn" data-status="Acknowledged">Acknowledged</button>
              <button class="btn ghost statusBtn" data-status="Responding">Responding</button>
              <button class="btn ghost statusBtn" data-status="Staged">Staged</button>
              <button class="btn ghost statusBtn" data-status="Arrived">Arrived</button>
              <button class="btn ghost statusBtn" data-status="Returning">Returning</button>
              <button class="btn ghost statusBtn" data-status="Clear">Clear</button>
            </div>
          </div>

          <div style="margin-top:12px;display:flex;gap:8px">
            <button id="addAgencyBtn" class="btn ghost">Add Agency</button>
            <div style="position:relative">
              <button id="alarmBtn" class="btn ghost">Add Alarm ▾</button>
              <div id="alarmMenu" style="display:none;position:absolute;left:0;top:36px;background:#081727;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03)">
                <div><button class="btn small alarmOpt" data-temp="first">1st Alarm</button></div>
                <div><button class="btn small alarmOpt" data-temp="second">2nd Alarm</button></div>
                <div><button class="btn small alarmOpt" data-temp="third">3rd Alarm</button></div>
              </div>
            </div>
            <button id="addDetailBtn" class="btn ghost">Add Detail</button>
          </div>

          <div style="margin-top:12px"><strong>Timeline</strong><div id="timelineBlock" class="muted" style="margin-top:6px"></div></div>

          <div style="margin-top:12px"><strong>Chat</strong>
            <div id="chatBox" class="chatBox" style="margin-top:8px"></div>
            <div style="display:flex;gap:8px;margin-top:8px"><input id="chatInput" placeholder="Message..."/><button id="sendChat" class="btn primary">Send</button></div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import {
      getFirestore, collection, doc, getDoc, getDocs,
      addDoc, setDoc, onSnapshot, query
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // firebase config (same as main)
    const firebaseConfig = {
      apiKey: "AIzaSyBi0Xyljx7zzXTmyyRMAru11hZ2s5S3tsw",
      authDomain: "f1resource-8fedc.firebaseapp.com",
      projectId: "f1resource-8fedc",
      storageBucket: "f1resource-8fedc.firebasestorage.app",
      messagingSenderId: "182745701982",
      appId: "1:182745701982:web:9f4f3836b41b450987decf"
    };
    const fb = initializeApp(firebaseConfig);
    const db = getFirestore(fb);
    const ROOT_COL='f1root', ROOT_DOC='f1resource';
    const subCol = (name) => collection(db, ROOT_COL, ROOT_DOC, name);
    const docRef = (col,id) => doc(db, ROOT_COL, ROOT_DOC, col, id);

    // Local apparatus accounts (Option A) - you can edit these later in the file if you want more
    const APP_USERS = {
      "ENGINE511": { password: "ENGINE511", dept: "Central Sq FD", apparatus: "Engine 511" },
      "ENGINE512": { password: "ENGINE512", dept: "Central Sq FD", apparatus: "Engine 512" },
      "LADDER701": { password: "LADDER701", dept: "West Oswego FD", apparatus: "Ladder 701" }
    };

    const $ = id => document.getElementById(id);
    function now(){ return new Date().toISOString(); }
    function esc(s){ return s? String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;') : ''; }

    // login
    $('apFill').addEventListener('click', ()=>{ $('apUser').value='ENGINE511'; $('apPass').value='ENGINE511'; });
    $('toMain').addEventListener('click', ()=>{ window.location.href='index.html'; });
    $('apLogin').addEventListener('click', ()=> {
      const u = ($('apUser').value||'').trim().toUpperCase();
      const p = ($('apPass').value||'').trim();
      if(!u||!p){ $('apMsg').textContent='Enter credentials'; return; }
      const user = APP_USERS[u];
      if(!user || user.password !== p){ $('apMsg').textContent='Invalid credentials'; return; }
      $('apMsg').textContent='';
      CURRENT = { username:u, dept:user.dept, apparatus:user.apparatus };
      bootApparatus();
    });

    $('apLogout').addEventListener('click', ()=> location.reload());

    let CURRENT = null;
    function bootApparatus(){
      $('loginCard').style.display='none';
      $('appUI').style.display='block';
      $('appUserLabel').textContent = `${CURRENT.username} • ${CURRENT.apparatus}`;
      // watch incidents
      onSnapshot(query(subCol('incidents')), snap=> {
        const data = {}; snap.forEach(d=> data[d.id] = d.data()); renderIncidentsList(data);
      });
    }

    function renderIncidentsList(data){
      const t = $('incidentList'); t.innerHTML='';
      const keys = Object.keys(data).sort((a,b)=> (data[b].createdAt||'').localeCompare(data[a].createdAt||''));
      if(!keys.length) t.innerHTML = '<div class="muted">No active incidents</div>';
      keys.forEach(id=>{
        const it = data[id]; if(it.archived) return;
        const div = document.createElement('div'); div.className='incidentItem';
        div.innerHTML = `<div style="display:flex;justify-content:space-between"><div><strong>${esc(it.type)}</strong><div class="muted">${esc(it.address||'')}</div></div><div><button class="btn small openBtn" data-id="${id}">Open</button></div></div>`;
        t.appendChild(div);
      });
      t.querySelectorAll('.openBtn').forEach(b=> b.addEventListener('click', ()=> openIncident(b.dataset.id)));
    }

    // create incident flow
    $('createBtn').addEventListener('click', ()=> { $('createPanel').style.display='block'; $('incidentPanel').style.display='none'; });
    $('cancelInc').addEventListener('click', ()=> { $('createPanel').style.display='none'; });
    $('submitInc').addEventListener('click', async ()=>{
      const obj = { createdAt: now(), createdBy: CURRENT.username, creatorDept: CURRENT.dept, creatorApparatus: CURRENT.apparatus, type: $('incType').value, address: $('incAddress').value.trim(), nature: $('incNature').value.trim(), details: $('incDetails').value.trim(), isClosed:false, archived:false, unitsAttached: [], statusUpdates: [], messages: [], details: [] };
      const ref = await addDoc(subCol('incidents'), obj);
      $('createPanel').style.display='none';
      openIncident(ref.id);
    });

    let SELECTED = null;
    async function openIncident(id){
      SELECTED = id;
      const snap = await getDoc(docRef('incidents', id));
      if(!snap.exists()) return alert('Not found');
      const it = snap.data();
      $('incidentPanel').style.display='block';
      $('createPanel').style.display='none';
      $('incTitle').textContent = `${it.type} — ${it.address || ''}`;
      $('incMeta').textContent = `Created: ${it.createdAt || ''} • By: ${it.createdBy || ''}`;
      renderUnits(it);
      renderTimeline(it);
      renderChat(it);
    }

    async function renderUnits(it){
      const out = $('unitsBlock'); out.innerHTML='';
      (it.unitsAttached||[]).forEach(u=>{
        const div = document.createElement('div'); div.style.marginBottom='6px';
        div.innerHTML = `<div style="font-weight:700">${esc(u.apparatus||u.unitId)}</div><div class="muted">${esc(u.agency||'')} • ${esc(u.status||'')}</div><div class="muted">${(u.statusHistory||[]).map(h=> `${esc(h.status)} @ ${esc(h.ts)}`).join(' | ')}</div>`;
        out.appendChild(div);
      });
    }
    function renderTimeline(it){
      const t = $('timelineBlock'); t.innerHTML='';
      const timeline = [];
      (it.statusUpdates||[]).forEach(s=> timeline.push({ts:s.ts,txt:`${s.unitId} → ${s.status}`}));
      (it.details||[]).forEach(d=> timeline.push({ts:d.ts,txt:`Detail by ${d.by}: ${d.text}`}));
      (it.messages||[]).forEach(m=> timeline.push({ts:m.ts,txt:`${m.sender}: ${m.text}`}));
      timeline.sort((a,b)=> (a.ts||'').localeCompare(b.ts||''));
      timeline.forEach(item=> { const div=document.createElement('div'); div.className='muted'; div.textContent = `${item.ts} — ${item.txt}`; t.appendChild(div); });
    }
    function renderChat(it){
      const c = $('chatBox'); c.innerHTML='';
      (it.messages||[]).forEach(m=> { const d=document.createElement('div'); d.innerHTML = `<div style="font-weight:700">${esc(m.sender)}</div><div class="muted">${esc(m.text)}</div><div class="muted" style="font-size:11px">${esc(m.ts)}</div>`; c.appendChild(d); });
      c.scrollTop = c.scrollHeight;
    }

    // attach/detach
    $('attachBtn').addEventListener('click', async ()=> {
      if(!SELECTED) return alert('Select incident');
      const ref = doc(db, ROOT_COL, ROOT_DOC, 'incidents', SELECTED);
      const snap = await getDoc(ref); if(!snap.exists()) return;
      const inc = snap.data();
      inc.unitsAttached = inc.unitsAttached || [];
      const unitId = CURRENT.username;
      if(inc.unitsAttached.some(u=> u.unitId === unitId)) { alert('Already attached'); return; }
      const newUnit = { unitId, agency: CURRENT.dept, apparatus: CURRENT.apparatus, status: 'Acknowledged', statusHistory: [{ status:'Acknowledged', ts: now(), by: unitId }] };
      inc.unitsAttached.push(newUnit);
      inc.statusUpdates.push({ unitId, status:'Acknowledged', ts: now() });
      await setDoc(ref, inc);
      openIncident(SELECTED);
    });

    // status update buttons
    document.querySelectorAll('.statusBtn').forEach(b=> b.addEventListener('click', async (e)=> {
      if(!SELECTED) return alert('Select incident');
      const status = e.currentTarget.dataset.status;
      const ref = doc(db, ROOT_COL, ROOT_DOC, 'incidents', SELECTED);
      const snap = await getDoc(ref); if(!snap.exists()) return;
      const inc = snap.data();
      const u = (inc.unitsAttached||[]).find(x=> x.unitId === CURRENT.username);
      if(!u) return alert('You are not attached');
      u.status = status; u.statusHistory = u.statusHistory || []; u.statusHistory.push({ status, ts: now(), by: CURRENT.username });
      inc.statusUpdates = inc.statusUpdates || []; inc.statusUpdates.push({ unitId: CURRENT.username, status, ts: now() });
      if(status === 'Clear'){
        const stillActive = (inc.unitsAttached||[]).some(x=> x.status !== 'Clear');
        if(!stillActive){ inc.isClosed = true; inc.closedAt = now(); }
      }
      await setDoc(ref, inc);
      openIncident(SELECTED);
    }));

    // add agency (from fire_departments names)
    $('addAgencyBtn').addEventListener('click', async ()=> {
      if(!SELECTED) return alert('Select incident');
      const snap = await getDocs(subCol('fire_departments'));
      const options = []; snap.forEach(d=> options.push(d.data().name));
      const choice = prompt('Enter agency name (choose from list):\\n' + options.join('\\n'));
      if(!choice) return;
      const ref = doc(db, ROOT_COL, ROOT_DOC, 'incidents', SELECTED);
      const s = await getDoc(ref); if(!s.exists()) return;
      const inc = s.data(); const uid = `${choice.replace(/\\s+/g,'_')}_${Math.random().toString(36).slice(2,5)}`;
      inc.unitsAttached = inc.unitsAttached || []; inc.unitsAttached.push({ unitId: uid, agency: choice, apparatus: choice, status: 'Acknowledged', statusHistory: [{ status:'Acknowledged', ts: now(), by:'SYSTEM' }] });
      inc.statusUpdates = inc.statusUpdates || []; inc.statusUpdates.push({ unitId: uid, status:'Acknowledged', ts: now() });
      await setDoc(ref, inc); openIncident(SELECTED);
    });

    // alarm templates
    $('alarmBtn').addEventListener('click', ()=> { $('alarmMenu').style.display = $('alarmMenu').style.display === 'block' ? 'none' : 'block'; });
    document.querySelectorAll('.alarmOpt').forEach(btn=> btn.addEventListener('click', async (e)=> {
      const key = e.currentTarget.dataset.temp;
      if(!SELECTED) return alert('Select incident');
      const tmpDoc = await getDoc(docRef('alarm_templates', key));
      if(!tmpDoc.exists()) return alert('Template empty');
      const units = tmpDoc.data().units || [];
      const ref = doc(db, ROOT_COL, ROOT_DOC, 'incidents', SELECTED);
      const s = await getDoc(ref); if(!s.exists()) return;
      const inc = s.data();
      units.forEach(deptName => {
        const uid = `${deptName.replace(/\\s+/g,'_')}_${Math.random().toString(36).slice(2,5)}`;
        inc.unitsAttached = inc.unitsAttached || []; inc.unitsAttached.push({ unitId:uid, agency:deptName, apparatus:deptName, status:'Acknowledged', statusHistory:[{status:'Acknowledged', ts: now(), by:'SYSTEM'}] });
        inc.statusUpdates = inc.statusUpdates || []; inc.statusUpdates.push({ unitId: uid, status:'Acknowledged', ts: now() });
      });
      await setDoc(ref, inc); openIncident(SELECTED); $('alarmMenu').style.display='none';
    }));

    // add detail
    $('addDetailBtn').addEventListener('click', async ()=> {
      if(!SELECTED) return alert('Select incident');
      const txt = prompt('Enter detail:'); if(!txt) return;
      const ref = doc(db, ROOT_COL, ROOT_DOC, 'incidents', SELECTED);
      const s = await getDoc(ref); if(!s.exists()) return;
      const inc = s.data(); inc.details = inc.details || []; inc.details.push({ by: CURRENT.username, text: txt, ts: now() });
      await setDoc(ref, inc); openIncident(SELECTED);
    });

    // send chat
    $('sendChat').addEventListener('click', async ()=> {
      if(!SELECTED) return alert('Select incident');
      const txt = $('chatInput').value.trim(); if(!txt) return;
      const ref = doc(db, ROOT_COL, ROOT_DOC, 'incidents', SELECTED);
      const s = await getDoc(ref); if(!s.exists()) return;
      const inc = s.data(); inc.messages = inc.messages || []; inc.messages.push({ sender: CURRENT.username, text: txt, ts: now() });
      await setDoc(ref, inc); $('chatInput').value=''; openIncident(SELECTED);
    });

    // archive
    $('archiveIncBtn').addEventListener('click', async ()=> {
      if(!SELECTED) return alert('Select incident');
      if(!confirm('Archive incident?')) return;
      const ref = doc(db, ROOT_COL, ROOT_DOC, 'incidents', SELECTED);
      const s = await getDoc(ref); if(!s.exists()) return;
      const inc = s.data(); inc.archived = true; inc.archivedAt = now();
      await setDoc(ref, inc); alert('Archived'); location.reload();
    });

    // archive view
    $('archiveBtn').addEventListener('click', async ()=> {
      const snap = await getDocs(subCol('incidents'));
      const arr = []; const three = Date.now() - 90*24*60*60*1000;
      snap.forEach(d=> { const val = d.data(); if(val.archived && new Date(val.archivedAt||0).getTime() >= three) arr.push({ id:d.id, ...val }); });
      $('incidentList').innerHTML=''; if(!arr.length) $('incidentList').innerHTML='<div class="muted">No archived incidents</div>';
      arr.forEach(it=> { const div=document.createElement('div'); div.className='incidentItem'; div.innerHTML = `<div style="display:flex;justify-content:space-between"><div><strong>${esc(it.type)}</strong><div class="muted">${esc(it.address||'')}</div></div><div><button class="btn small openBtn" data-id="${it.id}">Open</button></div></div>`; $('incidentList').appendChild(div); });
      $('incidentList').querySelectorAll('.openBtn').forEach(b=> b.addEventListener('click', ()=> openIncident(b.dataset.id)));
    });

    // helper wrappers to avoid name collisions
    import { getDoc as getDocRaw, getDocs as getDocsRaw } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
    async function getDoc(r){ return await getDocRaw(r); }
    async function getDocs(r){ return await getDocsRaw(r); }

  </script>
</body>
</html>
