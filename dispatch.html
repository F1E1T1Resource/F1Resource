<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>F1 Resource — Dispatch (Apparatus)</title>
<style>
:root{--bg:#041428;--accent:#0b5fff;--accent2:#7b5cff;--muted:#9aa6bd}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#021023,#041428);color:#eaf3ff;min-height:100vh}
.container{max-width:980px;margin:18px auto;padding:12px}
.card{background:linear-gradient(180deg,#0b1624,#08121a);padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
.header{display:flex;align-items:center;gap:12px}
.header img{height:48px;border-radius:8px}
.meta{color:var(--muted);font-size:13px}
.grid{display:grid;grid-template-columns:1fr 360px;gap:12px}
@media (max-width:900px){ .grid{grid-template-columns:1fr} .rightCol{order:2} .leftCol{order:1} }
.input,textarea,select{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;margin-top:8px}
.btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:700}
.btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#001020}
.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
.list{display:flex;flex-direction:column;gap:8px;margin-top:12px}
.listItem{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);border:1px solid rgba(255,255,255,0.02)}
.small{padding:6px 8px;font-size:13px}
.timeline{background:rgba(255,255,255,0.02);padding:8px;border-radius:8px;max-height:220px;overflow:auto}
.adminPanel{background:linear-gradient(180deg,#081623,#07121a);padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);margin-top:12px}
.hidden{display:none}
.badge{background:rgba(255,255,255,0.03);padding:6px 8px;border-radius:8px;font-weight:700}
.centerBox{max-width:420px;margin:80px auto;padding:18px;background:linear-gradient(180deg,#071723,#06121a);border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
</style>
</head>
<body>

<!-- Apparatus Login -->
<div id="loginView" class="centerBox">
  <div style="text-align:center">
    <img src="https://c6ee69d755.cbaul-cdnwnd.com/af0c9920a8129f9bf9a0921ecfe9d264/200000017-17b1717b1a/700/F1Resource-removebg-preview.webp?ph=c6ee69d755" style="height:84px;border-radius:10px">
    <h2 style="margin:8px 0 0">Apparatus Mobile Login</h2>
    <div class="meta" style="margin-top:6px">Login for units and apparatus users</div>
  </div>

  <input id="apUser" class="input" placeholder="Unit Username (e.g., ENGINE511)">
  <input id="apPass" class="input" placeholder="Password" type="password">
  <div style="display:flex;gap:8px;margin-top:12px">
    <button id="btnAppLogin" class="btn primary">Login</button>
    <button id="btnMainBack" class="btn ghost">Back to Main</button>
  </div>
  <div id="apMsg" style="color:#ff8a8a;margin-top:8px"></div>
</div>

<!-- Dispatch UI -->
<div id="dispatchApp" style="display:none" class="container card">
  <div class="header">
    <img src="https://c6ee69d755.cbaul-cdnwnd.com/af0c9920a8129f9bf9a0921ecfe9d264/200000017-17b1717b1a/700/F1Resource-removebg-preview.webp?ph=c6ee69d755" alt="logo">
    <div><h2 style="margin:0">Apparatus Dispatch</h2><div class="meta">Create incidents — attach units — status & timeline</div></div>
    <div style="margin-left:auto;text-align:right">
      <div id="who" class="meta"></div>
      <div style="margin-top:6px"><button id="btnLogout" class="btn ghost small">Logout</button></div>
    </div>
  </div>

  <div class="grid" style="margin-top:12px">
    <div class="leftCol">
      <div id="createCard" class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>Create Incident</strong><div class="meta">Fill the basics and submit — units can attach.</div></div>
          <div><span id="connectedBadge" class="badge">Offline</span></div>
        </div>

        <div style="margin-top:10px">
          <input id="inc_address" class="input" placeholder="Address / Location">
          <input id="inc_type" class="input" placeholder="Type / Nature (structure, mva, fire, etc.)">
          <textarea id="inc_notes" class="input" placeholder="Details / notes"></textarea>

          <div style="display:flex;gap:8px;margin-top:8px">
            <select id="alarmSelect" class="input" style="flex:1">
              <option value="">No Alarm</option>
              <option value="1st">1st Alarm Structure</option>
              <option value="2nd">2nd Alarm Structure</option>
              <option value="3rd">3rd Alarm Structure</option>
            </select>
            <button id="btnCreate" class="btn primary">Create</button>
          </div>
        </div>
      </div>

      <div id="activeIncCard" class="card" style="margin-top:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>Active Incidents</strong><div class="meta">Tap to open</div></div>
          <div><button id="btnRefreshList" class="btn ghost small">Refresh</button></div>
        </div>
        <div id="incList" class="list"></div>
      </div>

      <div id="openIncCard" class="card hidden" style="margin-top:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong id="openTitle"></strong><div id="openSub" class="meta"></div></div>
          <div><button id="btnCloseOpen" class="btn ghost small">Close</button></div>
        </div>

        <div style="margin-top:10px">
          <div><strong>Attached Units</strong></div>
          <div id="attachedUnits" class="timeline" style="margin-top:8px"></div>

          <div style="margin-top:10px"><strong>Status Update</strong>
            <div style="display:flex;gap:8px;margin-top:6px;flex-wrap:wrap">
              <button class="statusBtn btn small" data-status="Acknowledged">Acknowledged</button>
              <button class="statusBtn btn small" data-status="Responding">Responding</button>
              <button class="statusBtn btn small" data-status="Staged">Staged</button>
              <button class="statusBtn btn small" data-status="Arrived">Arrived</button>
              <button class="statusBtn btn small" data-status="Returning">Returning</button>
              <button class="statusBtn btn small" data-status="Clear">Clear</button>
            </div>
          </div>

          <div style="margin-top:10px"><strong>Incident Timeline & Chat</strong>
            <div id="timelineBox" class="timeline" style="margin-top:8px"></div>
            <div style="display:flex;gap:8px;margin-top:8px">
              <input id="chatIn" class="input" placeholder="Message" />
              <button id="sendMsg" class="btn primary">Send</button>
            </div>
          </div>

          <div style="margin-top:10px;display:flex;gap:8px">
            <button id="btnAttachSelf" class="btn ghost">Attach Myself</button>
            <button id="btnAddAgency" class="btn ghost">Add Agency</button>
            <button id="btnClearArchive" class="btn ghost">Archive Incident</button>
          </div>
        </div>
      </div>

    </div>

    <div class="rightCol">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>Units</strong><div class="meta">Available apparatus</div></div>
          <div><button id="btnShowAdmin" class="btn ghost small">Admin Tools</button></div>
        </div>
        <div id="unitsList" class="list" style="margin-top:12px"></div>
      </div>

      <div id="adminPanel" class="adminPanel hidden">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>Admin Tools</strong><div class="meta">Visible to ADMIN only</div></div>
          <div><button id="btnCloseAdmin" class="btn ghost small">Close</button></div>
        </div>

        <div style="margin-top:10px">
          <div style="display:flex;gap:8px">
            <button id="btnAddDept" class="btn primary small">+ Department</button>
            <button id="btnAddUnit" class="btn ghost small">+ Apparatus</button>
          </div>

          <div style="margin-top:10px">
            <div><strong>Departments</strong></div>
            <div id="deptListAdmin" class="list" style="margin-top:8px"></div>
          </div>

          <div style="margin-top:10px">
            <div><strong>Apparatus</strong></div>
            <div id="unitListAdmin" class="list" style="margin-top:8px"></div>
          </div>

          <div style="margin-top:10px">
            <div><strong>Alarm presets</strong></div>
            <div id="alarmPresets" style="margin-top:8px"></div>
            <div style="margin-top:8px"><button id="btnEditAlarms" class="btn ghost small">Edit Alarms</button></div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- small modal -->
<div id="modal" style="display:none;position:fixed;inset:0;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:9999">
  <div style="background:linear-gradient(180deg,#0b1624,#07121a);padding:12px;border-radius:12px;width:92%;max-width:560px;border:1px solid rgba(255,255,255,0.03)">
    <div id="modalTitle" style="font-weight:800"></div>
    <div id="modalBody" style="margin-top:8px"></div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px"><button id="modalCancel" class="btn ghost">Cancel</button><button id="modalOk" class="btn primary">Save</button></div>
  </div>
</div>

<script type="module">
/* Firebase setup */
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, doc, addDoc, setDoc, getDoc, getDocs, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBi0Xyljx7zzXTmyyRMAru11hZ2s5S3tsw",
  authDomain: "f1resource-8fedc.firebaseapp.com",
  projectId: "f1resource-8fedc",
  storageBucket: "f1resource-8fedc.firebasestorage.app",
  messagingSenderId: "182745701982",
  appId: "1:182745701982:web:9f4f3836b41b450987decf"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* Collections */
const ROOT_COL='dispatch_root', ROOT_DOC='dispatch';
const departmentsCol = () => collection(db, ROOT_COL, ROOT_DOC, 'departments');
const apparatusCol = () => collection(db, ROOT_COL, ROOT_DOC, 'dispatch_apparatus');
const incidentsCol = () => collection(db, ROOT_COL, ROOT_DOC, 'incidents');
const subApp = (incId) => collection(db, ROOT_COL, ROOT_DOC, 'incidents', incId, 'apparatus');
const subTL = (incId) => collection(db, ROOT_COL, ROOT_DOC, 'incidents', incId, 'timeline');

/* Local apparatus login mapping stored in localStorage key f1_apparatus_local_v1 */
const APP_USERS_KEY = 'f1_apparatus_local_v1';
function loadAppUsers(){ try{ return JSON.parse(localStorage.getItem(APP_USERS_KEY)||'{}'); }catch(e){ return {}; } }
function saveAppUsers(o){ localStorage.setItem(APP_USERS_KEY, JSON.stringify(o)); }
let appUsers = loadAppUsers();
if(!Object.keys(appUsers).length){
  appUsers['ENGINE511'] = { password:'ENGINE511', label:'Engine 511', department:'' };
  appUsers['ENGINE512'] = { password:'ENGINE512', label:'Engine 512', department:'' };
  saveAppUsers(appUsers);
}

/* Session */
let dispatchUser = null;
let dispatchRole = null;

/* Node refs */
const loginView = document.getElementById('loginView');
const dispatchApp = document.getElementById('dispatchApp');
const who = document.getElementById('who');
const apMsg = document.getElementById('apMsg');

/* Login handlers */
document.getElementById('btnAppLogin').addEventListener('click', ()=>{
  const u = (document.getElementById('apUser').value||'').trim().toUpperCase();
  const p = (document.getElementById('apPass').value||'').trim();
  if(!u||!p){ apMsg.textContent='Enter username and password'; return; }
  appUsers = loadAppUsers();
  const user = appUsers[u];
  if(!user || user.password !== p){ apMsg.textContent='Invalid credentials'; return; }
  dispatchUser = u; dispatchRole = user.role || 'apparatus';
  localStorage.setItem('dispatchUser', dispatchUser); localStorage.setItem('dispatchRole', dispatchRole);
  startDispatchApp();
});
document.getElementById('btnMainBack').addEventListener('click', ()=> window.open('index.html','_blank'));

/* Auto-login */
(function(){
  const u = localStorage.getItem('dispatchUser'); const r = localStorage.getItem('dispatchRole');
  if(u){ appUsers = loadAppUsers(); if(appUsers[u]){ dispatchUser = u; dispatchRole = r||appUsers[u].role||'apparatus'; startDispatchApp(); } else { localStorage.removeItem('dispatchUser'); localStorage.removeItem('dispatchRole'); } }
})();

document.getElementById('btnLogout').addEventListener('click', ()=>{ localStorage.removeItem('dispatchUser'); localStorage.removeItem('dispatchRole'); location.reload(); });

/* UI state */
let DEPARTMENTS={}, APPARATUS={}, INCIDENTS={};
let OPEN_INCIDENT_ID = null;

/* Firestore realtime */
onSnapshot(departmentsCol(), snap=>{ const out={}; snap.forEach(d=> out[d.id]=d.data()); DEPARTMENTS=out; renderAdminLists(); });
onSnapshot(apparatusCol(), snap=>{ const out={}; snap.forEach(d=> out[d.id]=d.data()); APPARATUS=out; renderUnits(); renderAdminLists(); });
onSnapshot(incidentsCol(), snap=>{ const out={}; snap.forEach(d=> out[d.id]=d.data()); INCIDENTS=out; renderIncidentList(); });

function startDispatchApp(){
  loginView.style.display='none'; dispatchApp.style.display='block';
  who.textContent = `${dispatchUser} • ${dispatchRole.toUpperCase()}`;
  document.getElementById('connectedBadge').textContent = 'Connected';
  if(dispatchRole==='admin') document.getElementById('adminPanel').classList.remove('hidden');
  else document.getElementById('adminPanel').classList.add('hidden');
}

/* Render units */
function renderUnits(){
  const el = document.getElementById('unitsList'); el.innerHTML=''; const arr = Object.entries(APPARATUS).sort((a,b)=> (a[1].apparatusName||a[0]).localeCompare(b[1].apparatusName||b[0]));
  if(!arr.length) el.innerHTML = '<div class="meta">No units defined</div>';
  arr.forEach(([id,u])=>{ const div=document.createElement('div'); div.className='listItem'; div.innerHTML = `<div><strong>${u.apparatusName||id}</strong><div class="meta">${u.department||''}</div></div><div><button class="small btn" data-id="${id}" data-act="open">Open</button></div>`; el.appendChild(div); div.querySelector('button[data-act="open"]').addEventListener('click', ()=> showAppDetails(id)); });
}

/* Render incidents list */
function renderIncidentList(){
  const el = document.getElementById('incList'); el.innerHTML=''; const arr = Object.entries(INCIDENTS).filter(([id,i])=> !i.archived).sort((a,b)=> (b[1].createdAt||'').localeCompare(a[1].createdAt||''));
  if(!arr.length) el.innerHTML = '<div class="meta">No active incidents</div>';
  arr.forEach(([id,i])=>{ const div=document.createElement('div'); div.className='listItem'; div.innerHTML = `<div><strong>${i.type||'No Type'}</strong><div class="meta">${i.address||''} • ${i.createdAt||''}</div></div><div><button class="small btn" data-id="${id}" data-act="open">Open</button></div>`; el.appendChild(div); div.querySelector('button[data-act="open"]').addEventListener('click', ()=> openIncident(id)); });
}

/* Open incident */
async function openIncident(id){
  OPEN_INCIDENT_ID = id;
  const snap = await getDoc(doc(incidentsCol(), id));
  if(!snap.exists()){ alert('Missing'); return; }
  const data = snap.data();
  document.getElementById('openTitle').textContent = `${data.type||'Incident'} • ${data.address||''}`;
  document.getElementById('openSub').textContent = `Created: ${data.createdAt||''} • By: ${data.createdBy||''}`;
  // load apparatus & timeline subcollections
  const appSnap = await getDocs(subApp(id)); const attached = []; appSnap.forEach(s=> attached.push(s.data()));
  const tlSnap = await getDocs(subTL(id)); const tl = []; tlSnap.forEach(s=> tl.push(s.data()));
  const attachedEl = document.getElementById('attachedUnits'); attachedEl.innerHTML=''; attached.forEach(a=>{ const d=document.createElement('div'); d.innerHTML=`<div style="font-weight:700">${a.apparatusName||a.unitId}</div><div class="meta">${a.status||''} • ${a.agency||''}</div>`; attachedEl.appendChild(d); });
  const tlEl = document.getElementById('timelineBox'); tlEl.innerHTML=''; tl.forEach(t=>{ const e=document.createElement('div'); e.innerHTML=`<div style="font-weight:700">${t.title||t.sender||'Event'}</div><div class="meta">${t.text||''}</div><div class="meta" style="font-size:12px">${t.ts||''}</div>`; tlEl.appendChild(e); });
  document.getElementById('openIncCard').classList.remove('hidden');
}

/* Attach self */
document.getElementById('btnAttachSelf').addEventListener('click', async ()=>{
  if(!OPEN_INCIDENT_ID) return alert('Open an incident');
  const uid = dispatchUser;
  // prevent duplicate attach
  const existing = await getDocs(subApp(OPEN_INCIDENT_ID));
  let already=false;
  existing.forEach(s=> { const o=s.data(); if((o.unitId||'')===uid) already=true; });
  if(already) return alert('Already attached');
  await addDoc(subApp(OPEN_INCIDENT_ID), { unitId:uid, apparatusName: (APPARATUS[uid] && APPARATUS[uid].apparatusName) || uid, agency: (APPARATUS[uid]&&APPARATUS[uid].department)||'', status:'Acknowledged', statusHistory:[{status:'Acknowledged', ts:new Date().toISOString(), by:uid}] });
  await addDoc(subTL(OPEN_INCIDENT_ID), { title:'Attach', text:`${uid} attached`, sender:uid, ts:new Date().toISOString() });
  openIncident(OPEN_INCIDENT_ID);
});

/* Status buttons (delegated) */
document.querySelectorAll('.statusBtn').forEach(b=> b.addEventListener('click', async (ev)=>{
  if(!OPEN_INCIDENT_ID) return alert('Open an incident');
  const status = ev.currentTarget.dataset.status;
  const uid = dispatchUser;
  // find apparatus doc
  const appSnap = await getDocs(subApp(OPEN_INCIDENT_ID));
  let foundDoc = null; let foundId=null;
  appSnap.forEach(d=>{ const o=d.data(); if((o.unitId||'')===uid){ foundDoc=o; foundId=d.id; }});
  if(!foundDoc) return alert('Attach before updating status');
  const ref = doc(db, ROOT_COL, ROOT_DOC, 'incidents', OPEN_INCIDENT_ID, 'apparatus', foundId);
  const newHistory = (foundDoc.statusHistory||[]).concat([{ status, ts:new Date().toISOString(), by:uid }]);
  await setDoc(ref, { status, statusHistory:newHistory }, { merge:true });
  await addDoc(subTL(OPEN_INCIDENT_ID), { title:'Status', text:`${uid}: ${status}`, sender:uid, ts:new Date().toISOString() });
  openIncident(OPEN_INCIDENT_ID);
}));

/* Create incident */
document.getElementById('btnCreate').addEventListener('click', async ()=>{
  const address = document.getElementById('inc_address').value.trim();
  const type = document.getElementById('inc_type').value.trim();
  const notes = document.getElementById('inc_notes').value.trim();
  const alarm = document.getElementById('alarmSelect').value || '';
  if(!address && !type) return alert('Enter address or type');
  const ref = await addDoc(incidentsCol(), { address, type, notes, alarm, createdBy: dispatchUser, createdAt:new Date().toISOString(), archived:false });
  document.getElementById('inc_address').value=''; document.getElementById('inc_type').value=''; document.getElementById('inc_notes').value='';
  alert('Incident created');
});

/* Chat send */
document.getElementById('sendMsg').addEventListener('click', async ()=>{
  if(!OPEN_INCIDENT_ID) return alert('Open an incident');
  const txt = document.getElementById('chatIn').value.trim(); if(!txt) return;
  await addDoc(subTL(OPEN_INCIDENT_ID), { title:'Msg', text:txt, sender:dispatchUser, ts:new Date().toISOString() });
  document.getElementById('chatIn').value=''; openIncident(OPEN_INCIDENT_ID);
});

/* Archive */
document.getElementById('btnClearArchive').addEventListener('click', async ()=>{
  if(!OPEN_INCIDENT_ID) return alert('Open an incident');
  if(!confirm('Archive incident?')) return;
  await setDoc(doc(incidentsCol(), OPEN_INCIDENT_ID), { archived:true }, { merge:true });
  document.getElementById('openIncCard').classList.add('hidden'); OPEN_INCIDENT_ID=null;
});

/* Refresh list */
document.getElementById('btnRefreshList').addEventListener('click', ()=> renderIncidentList());

/* Admin tools view */
document.getElementById('btnShowAdmin').addEventListener('click', ()=> {
  if(dispatchRole!=='admin') return alert('Admin only');
  document.getElementById('adminPanel').classList.toggle('hidden');
});
document.getElementById('btnCloseAdmin').addEventListener('click', ()=> document.getElementById('adminPanel').classList.add('hidden'));

/* Admin add dept/unit */
document.getElementById('btnAddDept').addEventListener('click', async ()=>{
  const name = prompt('Department name'); if(!name) return;
  await addDoc(departmentsCol(), { name, notes:'', alarms:[] });
});
document.getElementById('btnAddUnit').addEventListener('click', async ()=>{
  const id = prompt('Unit ID (ENGINE511)').trim().toUpperCase(); if(!id) return;
  const name = prompt('Display name', id) || id;
  const dept = prompt('Department (optional)', '') || '';
  await setDoc(doc(apparatusCol(), id), { apparatusName:name, department:dept, notes:'' });
  // update local mapping for login
  const store = loadAppUsers(); store[id] = { password: id, label: name, department: dept }; saveAppUsers(store);
  alert('Added unit and set local login password to username (change later in Local Storage mapping)');
});

/* Admin list render */
function renderAdminLists(){
  const dl = document.getElementById('deptListAdmin'); dl.innerHTML=''; Object.entries(DEPARTMENTS||{}).forEach(([id,d])=>{ const div=document.createElement('div'); div.className='listItem'; div.innerHTML = `<div><strong>${d.name||id}</strong><div class="meta">${d.notes||''}</div></div><div style="display:flex;gap:6px"><button class="small btn" data-id="${id}" data-act="edit-dept">Edit</button><button class="small btn" data-id="${id}" data-act="del-dept">Delete</button></div>`; dl.appendChild(div); div.querySelector('[data-act="edit-dept"]').addEventListener('click', async ()=>{ const nn = prompt('Name', d.name||''); if(!nn) return; await setDoc(doc(departmentsCol(), id), { name: nn }, { merge:true }); }); div.querySelector('[data-act="del-dept"]').addEventListener('click', async ()=>{ if(confirm('Delete?')) await deleteDoc(doc(departmentsCol(), id)); }); });
  const ul = document.getElementById('unitListAdmin'); ul.innerHTML=''; Object.entries(APPARATUS||{}).forEach(([id,u])=>{ const div=document.createElement('div'); div.className='listItem'; div.innerHTML = `<div><strong>${u.apparatusName||id}</strong><div class="meta">${u.department||''}</div></div><div style="display:flex;gap:6px"><button class="small btn" data-id="${id}" data-act="edit-unit">Edit</button><button class="small btn" data-id="${id}" data-act="del-unit">Delete</button></div>`; ul.appendChild(div); div.querySelector('[data-act="edit-unit"]').addEventListener('click', async ()=>{ const nn = prompt('Display name', u.apparatusName||id); const dep = prompt('Department', u.department||''); if(!nn) return; await setDoc(doc(apparatusCol(), id), { apparatusName: nn, department: dep }, { merge:true }); }); div.querySelector('[data-act="del-unit"]').addEventListener('click', async ()=>{ if(confirm('Delete unit?')) await deleteDoc(doc(apparatusCol(), id)); }); });
}

/* show apparatus details modal */
function showAppDetails(id){ const a = APPARATUS[id] || { apparatusName:id }; alert(`${a.apparatusName||id}\nDept: ${a.department||'Unassigned'}\nNotes: ${a.notes||''}`); }

/* helper local storage mapping */
function loadAppUsers(){ try{ return JSON.parse(localStorage.getItem(APP_USERS_KEY)||'{}'); }catch(e){return{};} }
function saveAppUsers(o){ localStorage.setItem(APP_USERS_KEY, JSON.stringify(o)); }

/* show modal helper */
const modal = document.getElementById('modal'), modalTitle = document.getElementById('modalTitle'), modalBody = document.getElementById('modalBody'), modalOk = document.getElementById('modalOk'), modalCancel = document.getElementById('modalCancel');
function showModal(title, buildFn, onSave){
  modalTitle.textContent = title; modalBody.innerHTML=''; buildFn(modalBody); modal.style.display='flex';
  return new Promise((res,rej)=>{ modalOk.onclick = async ()=>{ try{ await onSave(); modal.style.display='none'; res(true); }catch(e){ rej(e); } }; modalCancel.onclick = ()=>{ modal.style.display='none'; res(false); }; });
}

/* Utility: getDoc/getDocs functions imported earlier - need to import them through module top; using addDoc/setDoc/getDoc/getDocs above */

/* END */
</script>
</body>
</html>



