<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>F1 Resource — Oswego County</title>
<link rel="preconnect" href="https://fonts.gstatic.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#100426;
    --panel:#1b0830;
    --card:#23093f;
    --accent:#9b5cff;
    --accent-2:#ff6f91;
    --muted:#cdbfe6;
    --pill:#2b0f51;
    --white:#f6f7fb;
  }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;color:var(--white);background:linear-gradient(180deg,#0b0622 0%, #1b0830 100%);}
  /* layout */
  .app { display:flex; min-height:100vh; }
  .sidebar {
    width:88px;
    background:linear-gradient(180deg,#150623,#230a39);
    padding:18px 10px;
    display:flex;flex-direction:column;align-items:center;gap:18px;
    box-shadow:6px 0 24px rgba(0,0,0,.4);
  }
  .logo { width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent-2)); display:flex;align-items:center;justify-content:center;font-weight:800; font-size:18px; color:#fff;box-shadow:0 6px 18px rgba(0,0,0,.45);}
  .nav { display:flex;flex-direction:column;gap:8px;width:100%; }
  .nav .btn { width:100%; background:transparent;border:none;color:var(--muted);padding:8px;border-radius:10px;cursor:pointer;font-weight:600;text-align:center;font-size:12px; }
  .nav .btn.active, .nav .btn:hover { background:rgba(155,92,255,0.12); color:var(--white); box-shadow:inset 0 0 20px rgba(155,92,255,0.06); }
  .nav .label{font-size:10px;color:#8e78a8;margin-top:6px;text-align:center}
  .contentWrap { flex:1; display:flex; flex-direction:column; padding:22px; gap:18px; }
  .topbar { display:flex; align-items:center; gap:18px; justify-content:space-between; }
  .welcome { display:flex; gap:18px; align-items:center; }
  .welcome h1 { font-size:44px; margin:0;color:rgba(255,255,255,.92); letter-spacing:1px; font-weight:800; text-transform:uppercase; }
  .welcome p { margin:0;color:var(--muted); max-width:720px; }
  .card { background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:12px; padding:16px; box-shadow:0 6px 20px rgba(0,0,0,0.45); border:1px solid rgba(255,255,255,0.02); }
  .gridCols { display:grid; grid-template-columns: 1fr 360px; gap:18px; align-items:start; }
  /* lists */
  .sectionTitle { color:var(--muted); font-weight:700; font-size:13px; margin-bottom:8px; letter-spacing:1px; text-transform:uppercase; }
  .listItem { background:var(--pill); padding:10px 14px; margin-bottom:10px; border-radius:12px; display:flex; justify-content:space-between; align-items:center; gap:8px; border:1px solid rgba(255,255,255,0.03); }
  .listItem h4{ margin:0; font-size:14px; color:var(--white); font-weight:700; }
  .listItem .meta{ color:var(--muted); font-size:12px; }
  .pillBtn { background:linear-gradient(90deg,var(--accent),var(--accent-2)); border:none; color:white; padding:6px 10px; border-radius:999px; cursor:pointer; font-weight:700; font-size:12px; box-shadow:0 8px 20px rgba(155,92,255,0.12);}
  .muted { color:var(--muted); font-size:13px; }
  .apparatusList { margin:8px 0 0 0; padding-left:18px; color:var(--muted); }
  /* forms and inputs */
  input[type="text"], input[type="search"], textarea, select {
    width:100%; padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,0.04); background:rgba(0,0,0,0.2); color:var(--white);
    outline:none; box-sizing:border-box;
  }
  .small { font-size:13px; padding:6px 10px; border-radius:8px; }
  .topAlert { background:linear-gradient(90deg,#ff5f6d,#ffc371); color:#111; padding:8px 12px; border-radius:8px; font-weight:800; display:inline-block;}
  /* login page */
  #loginWrap{min-height:100vh; display:flex; align-items:center; justify-content:center; gap:40px; padding:30px;}
  .loginPanel{width:920px; display:flex; gap:42px; align-items:center;}
  .loginLeft{flex:0 0 220px; text-align:center;}
  .loginLogo{width:160px;height:160px;border-radius:18px;background:linear-gradient(135deg,var(--accent),var(--accent-2)); display:flex; align-items:center; justify-content:center; font-weight:900; font-size:40px; color:white; box-shadow:0 12px 40px rgba(0,0,0,0.45)}
  .loginPanelRight{flex:1;}
  .loginCard{background:var(--panel); padding:22px; border-radius:12px;}
  .loginFields{display:flex; flex-direction:column; gap:12px; margin-top:10px;}
  .loginFields input{padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04); background:transparent; color:var(--white); font-size:16px;}
  .loginFields button{padding:12px;border-radius:10px;background:linear-gradient(90deg,var(--accent),var(--accent-2)); border:none; font-weight:800; color:white; cursor:pointer;}
  /* responsive small */
  @media (max-width:1000px){
    .loginPanel{flex-direction:column; width:100%;}
    .gridCols{ grid-template-columns:1fr; }
    .welcome h1{font-size:34px;}
    .sidebar{display:none}
  }
  @media (max-width:520px){
    .loginCard{padding:16px;}
    .loginLogo{width:120px;height:120px;font-size:28px;}
  }
</style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div id="loginWrap">
  <div class="loginPanel">
    <div class="loginLeft">
      <div class="loginLogo">F1</div>
      <div style="margin-top:16px;color:var(--muted);font-weight:700">WELCOME<br>OSWEGO COUNTY!</div>
    </div>

    <div class="loginPanelRight">
      <div class="loginCard">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div style="font-weight:800;font-size:18px">F1 Resource</div>
            <div class="muted">All county resources — one place</div>
          </div>
          <div class="topAlert" id="loginBadge">Local Login</div>
        </div>

        <div style="margin-top:18px">
          <div class="muted">Enter your username and password to continue</div>
          <div class="loginFields" style="margin-top:12px">
            <input id="loginUser" type="text" placeholder="Username" autocomplete="username" />
            <input id="loginPass" type="password" placeholder="Password" autocomplete="current-password" />
            <button id="loginBtn">Login</button>
            <div id="loginMsg" style="color:#ffb3c6;font-weight:700"></div>
          </div>
        </div>

        <div style="margin-top:12px;color:var(--muted);font-size:13px">
          Admin user is hidden. Contact your county admin for other accounts.
        </div>
      </div>
      <div style="margin-top:18px;color:var(--muted);font-size:12px">
        Tip: apparatus input example: <span style="color:var(--accent)">'Chief 101 | Asst. Chief 102'</span> will render list items.
      </div>
    </div>
  </div>
</div>

<!-- APP -->
<div id="appRoot" class="app" style="display:none">
  <aside class="sidebar">
    <div class="logo">F1</div>

    <nav class="nav" id="mainNav">
      <button class="btn active" data-page="home">Home</button>
      <button class="btn" data-page="departments">Fire Departments</button>
      <button class="btn" data-page="ems">EMS Agencies</button>
      <button class="btn" data-page="coordinators">Coordinators</button>
      <button class="btn" data-page="countyTeams">County Teams</button>
      <button class="btn" data-page="hazmat">HazMat Search</button>
      <button class="btn" data-page="ev">EV Safety</button>
      <button class="btn" data-page="risks">Fire / Driving Risk</button>
      <button class="btn" data-page="weather">Weather</button>
      <button class="btn" data-page="admin">Admin</button>
    </nav>

    <div class="nav mt" style="margin-top:8px">
      <div class="label" style="text-align:center;color:var(--muted);font-size:10px">Oswego County • F1 Resource</div>
    </div>
  </aside>

  <main class="contentWrap">
    <!-- top area -->
    <div class="topbar">
      <div class="welcome">
        <div style="width:90px; height:90px; border-radius:12px; background:linear-gradient(90deg,var(--accent),var(--accent-2)); display:flex;align-items:center;justify-content:center;font-weight:900;font-size:28px">F1</div>
        <div>
          <h1>Welcome<br/><span style="color:rgba(155,92,255,0.4);font-weight:700">Oswego County</span></h1>
          <p class="muted">This is F1Resource. All of the information and resources you could need in one place.</p>
        </div>
      </div>
      <div style="text-align:right">
        <div id="userInfo" class="muted">Not logged in</div>
        <div style="margin-top:8px"><button id="logoutBtn" class="small" style="background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);padding:6px 10px;border-radius:8px;cursor:pointer">Logout</button></div>
      </div>
    </div>

    <!-- global weather alert -->
    <div id="globalWeather" class="card" style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <div class="sectionTitle">Active Weather Alerts</div>
        <div id="weatherAlerts" class="muted">Loading alerts...</div>
      </div>
      <div style="text-align:right">
        <div class="muted">Oswego County</div>
        <div style="margin-top:6px"><button id="refreshWeather" class="pillBtn small">Refresh</button></div>
      </div>
    </div>

    <!-- pages area -->
    <div class="gridCols">
      <div>
        <!-- HOME -->
        <section id="page-home" class="page card active">
          <div style="font-weight:800;font-size:20px;margin-bottom:6px">Welcome to F1 Resource</div>
          <div class="muted">This dashboard provides a quick view of departments, EMS agencies, county teams, and safety resources.</div>
        </section>

        <!-- Departments -->
        <section id="page-departments" class="page card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><div class="sectionTitle">Oswego County — Fire Departments</div></div>
            <div><button id="addDept" class="pillBtn">+ Add Department</button></div>
          </div>
          <div id="departmentsList" style="margin-top:12px"></div>
        </section>

        <!-- EMS -->
        <section id="page-ems" class="page card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><div class="sectionTitle">Oswego County — EMS Agencies</div></div>
            <div><button id="addEms" class="pillBtn">+ Add EMS</button></div>
          </div>
          <div id="emsList" style="margin-top:12px"></div>
        </section>

        <!-- Coordinators -->
        <section id="page-coordinators" class="page card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><div class="sectionTitle">County Coordinators</div></div>
            <div><button id="addCoord" class="pillBtn">+ Add Coordinator</button></div>
          </div>
          <div id="coordList" style="margin-top:12px"></div>
        </section>

        <!-- County Teams -->
        <section id="page-countyTeams" class="page card">
          <div style="display:flex;justify-content:space-between">
            <div><div class="sectionTitle">County Teams & Special Ops</div></div>
            <div><button id="addTeam" class="pillBtn">+ Add Team</button></div>
          </div>
          <div id="teamsList" style="margin-top:12px"></div>
        </section>

        <!-- HazMat -->
        <section id="page-hazmat" class="page card">
          <div class="sectionTitle">Hazardous Materials Search</div>
          <div style="display:flex;gap:8px;align-items:center;margin-top:10px">
            <input id="hazmatInput" placeholder="Identification number (UN/NA) e.g. 1203" />
            <button id="hazmatSearchBtn" class="pillBtn">Search</button>
          </div>
          <div id="hazmatResult" style="margin-top:12px" class="muted">Search results will appear here.</div>
        </section>

        <!-- EV Safety -->
        <section id="page-ev" class="page card">
          <div class="sectionTitle">Electric Vehicle Safety</div>
          <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
            <input id="evMake" placeholder="Make" style="max-width:180px" />
            <input id="evModel" placeholder="Model" style="max-width:180px" />
            <input id="evYear" placeholder="Year" style="max-width:120px" />
            <button id="evSearchBtn" class="pillBtn">Search</button>
          </div>
          <div id="evResult" style="margin-top:12px" class="muted">EV rescue info will appear here.</div>
        </section>

        <!-- Risks -->
        <section id="page-risks" class="page card">
          <div class="sectionTitle">Fire & Driving Risk</div>
          <div class="muted">Resources and checklists for fire and driving risk management (editable).</div>
        </section>

        <!-- Weather page -->
        <section id="page-weather" class="page card">
          <div class="sectionTitle">Weather Forecast</div>
          <div id="weatherForecast" style="margin-top:10px" class="muted">Forecast & details will appear here.</div>
        </section>
      </div>

      <!-- right column: admin/summary panel -->
      <aside>
        <div id="page-admin" class="card page" style="min-width:320px;display:none">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div class="sectionTitle">Admin</div>
            <div><button id="importCsv" class="small pillBtn">Import CSV</button></div>
          </div>

          <div style="margin-top:10px">
            <div style="font-weight:700;margin-bottom:8px">Manage HazMat DB</div>
            <div style="display:flex;gap:8px">
              <input id="adminHazUN" placeholder="UN number" />
              <input id="adminHazName" placeholder="Name" />
            </div>
            <div style="display:flex;gap:8px;margin-top:8px">
              <button id="addHazBtn" class="pillBtn">Add/Update HazMat</button>
              <button id="exportHazBtn" class="small" style="border:1px solid rgba(255,255,255,0.06)">Export</button>
            </div>
          </div>

          <hr style="border:none;border-top:1px solid rgba(255,255,255,0.03);margin:12px 0">

          <div style="font-weight:700;margin-bottom:8px">EV Links</div>
          <div class="muted">Add manufacturer rescue links (URL)</div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <input id="adminEvMake" placeholder="Make" />
            <input id="adminEvUrl" placeholder="Rescue guide URL" />
          </div>
          <div style="margin-top:8px">
            <button id="addEvLink" class="pillBtn">Add Link</button>
          </div>
        </div>

        <div class="card">
          <div class="sectionTitle">Quick Stats</div>
          <div style="display:flex;flex-direction:column;gap:10px">
            <div class="muted">Departments: <span id="statDepts">0</span></div>
            <div class="muted">EMS Agencies: <span id="statEms">0</span></div>
            <div class="muted">County Teams: <span id="statTeams">0</span></div>
            <div class="muted">Coordinators: <span id="statCoords">0</span></div>
          </div>
        </div>

        <div class="card">
          <div class="sectionTitle">Shortcuts</div>
          <div style="display:flex;flex-direction:column;gap:8px">
            <button class="small pillBtn" onclick="showPage('departments')">View Departments</button>
            <button class="small pillBtn" onclick="showPage('hazmat')">HazMat Search</button>
            <button class="small pillBtn" onclick="showPage('weather')">Weather</button>
          </div>
        </div>
      </aside>
    </div>
  </main>
</div>

<!-- Firebase + App Logic -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getDatabase, ref, push, set, onValue, remove, update, get } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

  // ---------- Firebase config (use your provided config) ----------
  const firebaseConfig = {
    apiKey: "AIzaSyBi0Xyljx7zzXTmyyRMAru11hZ2s5S3tsw",
    authDomain: "f1resource-8fedc.firebaseapp.com",
    databaseURL: "https://f1resource-8fedc-default-rtdb.firebaseio.com",
    projectId: "f1resource-8fedc",
    storageBucket: "f1resource-8fedc.firebasestorage.app",
    messagingSenderId: "182745701982",
    appId: "1:182745701982:web:9f4f3836b41b450987decf"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // ---------- Local login accounts ----------
  const USERS = {
    "ADMIN": { password:"ADMIN", role:"ADMIN" },
    "DEPTADMIN": { password:"DEPTADMIN", role:"DEPTADMIN", dept:"Central Fire Dept" },
    "DEPTUSER": { password:"DEPTUSER", role:"DEPTUSER" }
  };
  let CURRENT_USER = null;

  // DOM refs
  const loginWrap = document.getElementById('loginWrap');
  const loginBtn = document.getElementById('loginBtn');
  const loginUser = document.getElementById('loginUser');
  const loginPass = document.getElementById('loginPass');
  const loginMsg = document.getElementById('loginMsg');
  const appRoot = document.getElementById('appRoot');
  const userInfo = document.getElementById('userInfo');
  const logoutBtn = document.getElementById('logoutBtn');

  // navigation
  document.querySelectorAll('.nav .btn').forEach(btn=>{
    btn.addEventListener('click', ()=> {
      document.querySelectorAll('.nav .btn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const pageId = 'page-' + btn.getAttribute('data-page');
      // hide admin or show if admin
      if(btn.getAttribute('data-page') === 'admin'){
         document.getElementById('page-admin').style.display = (CURRENT_USER && CURRENT_USER.role === 'ADMIN')? 'block':'none';
      }
      showPage(btn.getAttribute('data-page'));
    });
  });

  function showPage(name){
    // hide all pages then show the one matching id page-<name>
    document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
    const el = document.getElementById('page-' + name);
    if(el) el.classList.add('active');
    // some stats update
    updateStats();
  }

  // login handler
  loginBtn.addEventListener('click', doLogin);
  loginPass.addEventListener('keydown', (e)=>{ if(e.key==='Enter') doLogin(); });

  function doLogin(){
    const u = loginUser.value.trim();
    const p = loginPass.value.trim();
    if(!u || !p){ loginMsg.textContent = "Enter credentials"; return; }
    const usr = USERS[u];
    if(!usr || usr.password !== p){ loginMsg.textContent = "Invalid credentials"; return; }
    CURRENT_USER = { username: u, role: usr.role, dept: usr.dept || null };
    loginMsg.textContent = "";
    loginWrap.style.display = 'none';
    appRoot.style.display = 'flex';
    userInfo.textContent = `${CURRENT_USER.username} — ${CURRENT_USER.role}`;
    // init realtime listeners
    initRealtime();
    // show default page
    showPage('home');
    // show admin panel only for admin
    document.getElementById('page-admin').style.display = (CURRENT_USER.role === 'ADMIN') ? 'block' : 'none';
  }

  logoutBtn.addEventListener('click', ()=>{
    // simple logout: reload to clear state
    location.reload();
  });

  // ---------- realtime listeners: global state ----------
  let state = { departments:{}, ems:{}, coordinators:{}, countyTeams:{}, hazmatDB:{}, evLinks:{} };

  function initRealtime(){
    watchPath('departments', 'departments');
    watchPath('ems', 'ems');
    watchPath('coordinators', 'coordinators');
    watchPath('countyTeams', 'countyTeams');
    watchPath('hazmatDB', 'hazmatDB');
    watchPath('evLinks', 'evLinks');
  }

  function watchPath(node, key){
    const r = ref(db, node);
    onValue(r, snap => {
      state[key] = snap.val() || {};
      renderSection(key);
      updateStats();
    });
  }

  // ---------- renderers ----------
  function renderSection(key){
    if(key === 'departments') renderDepartments();
    if(key === 'ems') renderEms();
    if(key === 'coordinators') renderCoordinators();
    if(key === 'countyTeams') renderTeams();
    if(key === 'hazmatDB') {/* no UI list except admin area */}
    if(key === 'evLinks') {/* admin area */}
  }

  function renderDepartments(){
    const container = document.getElementById('departmentsList');
    container.innerHTML = '';
    const items = state.departments || {};
    Object.entries(items).forEach(([id,item])=>{
      const el = document.createElement('div'); el.className = 'listItem';
      const left = document.createElement('div');
      const title = document.createElement('h4'); title.textContent = item.name || 'Unnamed Dept';
      const meta = document.createElement('div'); meta.className='meta muted'; meta.textContent = `${item.battalion ? 'Battalion: '+item.battalion : ''} ${item.address? ' • '+item.address:''}`;
      left.appendChild(title); left.appendChild(meta);
      const right = document.createElement('div');
      // apparatus parse '|' into list
      if(item.apparatus){
        const ul = document.createElement('ul'); ul.className='apparatusList';
        item.apparatus.split('|').map(s=>s.trim()).filter(Boolean).forEach(a=>{
          const li = document.createElement('li'); li.textContent = a; ul.appendChild(li);
        });
        left.appendChild(ul);
      }
      // action buttons depending on role
      if(CURRENT_USER.role === 'ADMIN' || (CURRENT_USER.role === 'DEPTADMIN' && CURRENT_USER.dept === item.name)){
        const editBtn = document.createElement('button'); editBtn.className='pillBtn small'; editBtn.textContent='Edit';
        editBtn.onclick = ()=> promptEdit('departments', id, item);
        const delBtn = document.createElement('button'); delBtn.className='small'; delBtn.style.marginLeft='8px'; delBtn.textContent='Delete';
        delBtn.onclick = ()=> doDelete('departments', id);
        right.appendChild(editBtn); right.appendChild(delBtn);
      } else {
        const viewBtn = document.createElement('button'); viewBtn.className='small'; viewBtn.textContent='View'; viewBtn.onclick=()=> showDetails('departments', id);
        right.appendChild(viewBtn);
      }
      el.appendChild(left); el.appendChild(right);
      container.appendChild(el);
    });
  }

  function renderEms(){
    const container = document.getElementById('emsList'); container.innerHTML='';
    const items = state.ems || {};
    Object.entries(items).forEach(([id,item])=>{
      const el = document.createElement('div'); el.className='listItem';
      const left = document.createElement('div'); const title = document.createElement('h4'); title.textContent=item.name||'Unnamed EMS'; left.appendChild(title);
      const meta = document.createElement('div'); meta.className='meta muted'; meta.textContent = item.address || '';
      left.appendChild(meta);
      if(item.apparatus){
        const ul=document.createElement('ul'); ul.className='apparatusList';
        item.apparatus.split('|').map(s=>s.trim()).filter(Boolean).forEach(a=>{const li=document.createElement('li'); li.textContent=a; ul.appendChild(li);});
        left.appendChild(ul);
      }
      const right=document.createElement('div');
      if(CURRENT_USER.role === 'ADMIN' || CURRENT_USER.role === 'DEPTADMIN'){
        const edit=document.createElement('button'); edit.className='pillBtn small'; edit.textContent='Edit'; edit.onclick=()=>promptEdit('ems',id,item);
        const del=document.createElement('button'); del.className='small'; del.textContent='Delete'; del.onclick=()=>doDelete('ems',id);
        right.appendChild(edit); right.appendChild(del);
      } else { const view=document.createElement('button'); view.className='small'; view.textContent='View'; right.appendChild(view); }
      el.appendChild(left); el.appendChild(right); container.appendChild(el);
    });
  }

  function renderCoordinators(){
    const container = document.getElementById('coordList'); container.innerHTML='';
    const items = state.coordinators || {};
    Object.entries(items).forEach(([id,item])=>{
      const el=document.createElement('div'); el.className='listItem';
      const left=document.createElement('div'); const title=document.createElement('h4'); title.textContent=item.name || 'No name';
      const meta=document.createElement('div'); meta.className='meta muted'; meta.textContent = item.callsign ? item.callsign : (item.department?item.department:'');
      left.appendChild(title); left.appendChild(meta);
      const right=document.createElement('div');
      if(CURRENT_USER.role==='ADMIN'){ const edit=document.createElement('button'); edit.className='pillBtn small'; edit.textContent='Edit'; edit.onclick=()=>promptEdit('coordinators',id,item); const del=document.createElement('button'); del.className='small'; del.textContent='Delete'; del.onclick=()=>doDelete('coordinators',id); right.appendChild(edit); right.appendChild(del); } 
      el.appendChild(left); el.appendChild(right); container.appendChild(el);
    });
  }

  function renderTeams(){
    const container = document.getElementById('teamsList'); container.innerHTML='';
    const items = state.countyTeams || {};
    Object.entries(items).forEach(([id,item])=>{
      const el=document.createElement('div'); el.className='listItem';
      const left=document.createElement('div'); const title=document.createElement('h4'); title.textContent=item.name || 'Team';
      const meta=document.createElement('div'); meta.className='meta muted'; meta.textContent = item.lead || '';
      left.appendChild(title); left.appendChild(meta);
      const right=document.createElement('div');
      if(CURRENT_USER.role === 'ADMIN' || CURRENT_USER.role === 'DEPTADMIN'){ const edit=document.createElement('button'); edit.className='pillBtn small'; edit.textContent='Edit'; edit.onclick=()=>promptEdit('countyTeams',id,item); const del=document.createElement('button'); del.className='small'; del.textContent='Delete'; del.onclick=()=>doDelete('countyTeams',id); right.appendChild(edit); right.appendChild(del); }
      el.appendChild(left); el.appendChild(right); container.appendChild(el);
    });
  }

  // ---------- CRUD helpers ----------
  function doDelete(path, key){
    if(!confirm('Delete item?')) return;
    remove(ref(db, `${path}/${key}`)).catch(err=>alert('Delete failed: '+err.message));
  }

  function promptEdit(path, key, item){
    // item argument may be undefined; fetch current
    get(ref(db, `${path}/${key}`)).then(snap=>{
      const data = snap.val() || item || {};
      // a simple edit flow: name/title, apparatus
      const currentName = data.name || data.title || '';
      const newName = prompt('Name / Title', currentName) || currentName;
      let newApp = data.apparatus || '';
      if('apparatus' in data){
        newApp = prompt('Apparatus (use | to separate)', newApp) || newApp;
        const updateObj = {...data, name:newName, apparatus:newApp};
        set(ref(db, `${path}/${key}`), updateObj);
      } else {
        // title-only
        const updateObj = {...data}; if(data.title) updateObj.title=newName; else updateObj.name=newName;
        set(ref(db, `${path}/${key}`), updateObj);
      }
    }).catch(err=>console.error(err));
  }

  // ---------- add functions ----------
  document.getElementById('addDept').addEventListener('click', ()=>{
    if(!canEdit()) return alert('Insufficient permissions');
    const name = prompt('Department name');
    if(!name) return;
    const battalion = prompt('Battalion (optional)') || '';
    const address = prompt('Address (optional)') || '';
    const apparatus = prompt('Apparatus (use | to separate, optional)') || '';
    push(ref(db,'departments')).then(n=>{
      set(ref(db, `departments/${n.key}`), { name, battalion, address, apparatus });
    });
  });

  document.getElementById('addEms').addEventListener('click', ()=>{
    if(!canEdit()) return alert('Insufficient permissions');
    const name = prompt('EMS name'); if(!name) return;
    const addr = prompt('Address') || '';
    const apparatus = prompt('Apparatus (use |)') || '';
    push(ref(db,'ems')).then(n=> set(ref(db, `ems/${n.key}`), { name, address:addr, apparatus }));
  });

  document.getElementById('addCoord').addEventListener('click', ()=>{
    if(!canEdit()) return alert('Insufficient permissions');
    const name = prompt('Coordinator name'); if(!name) return;
    const callsign = prompt('Callsign (optional)')||'';
    push(ref(db,'coordinators')).then(n=> set(ref(db, `coordinators/${n.key}`), { name, callsign }));
  });

  document.getElementById('addTeam').addEventListener('click', ()=>{
    if(!canEdit()) return alert('Insufficient permissions');
    const name = prompt('Team name'); if(!name) return;
    const lead = prompt('Team lead (optional)')||'';
    push(ref(db,'countyTeams')).then(n=> set(ref(db, `countyTeams/${n.key}`), { name, lead }));
  });

  // Admin page controls
  document.getElementById('addHazBtn').addEventListener('click', ()=>{
    if(!CURRENT_USER || CURRENT_USER.role !== 'ADMIN') return alert('Admin only');
    const un = document.getElementById('adminHazUN').value.trim();
    const name = document.getElementById('adminHazName').value.trim();
    if(!un || !name) return alert('Enter UN and name');
    set(ref(db, `hazmatDB/${un}`), { un, name });
    document.getElementById('adminHazUN').value=''; document.getElementById('adminHazName').value='';
    alert('HazMat entry added/updated');
  });

  document.getElementById('addEvLink').addEventListener('click', ()=>{
    if(!CURRENT_USER || CURRENT_USER.role !== 'ADMIN') return alert('Admin only');
    const make = document.getElementById('adminEvMake').value.trim();
    const url = document.getElementById('adminEvUrl').value.trim();
    if(!make || !url) return alert('Enter make and URL');
    const key = make.toLowerCase().replace(/\s+/g,'_');
    set(ref(db, `evLinks/${key}`), { make, url });
    document.getElementById('adminEvMake').value=''; document.getElementById('adminEvUrl').value='';
    alert('EV link added');
  });

  // HazMat search
  document.getElementById('hazmatSearchBtn').addEventListener('click', async ()=>{
    const q = document.getElementById('hazmatInput').value.trim();
    if(!q) return alert('Enter UN/NA number');
    // try db lookup
    const snap = await get(ref(db, `hazmatDB/${q}`));
    const doc = snap.val();
    if(doc){
      document.getElementById('hazmatResult').innerHTML = `<div style="font-weight:800">${doc.name} (UN ${q})</div><div class="muted">${doc.notes||''}</div>`;
    } else {
      document.getElementById('hazmatResult').innerHTML = `<div class="muted">No entry found for UN ${q}. Admins can add entries in Admin page.</div>`;
    }
  });

  // EV search
  document.getElementById('evSearchBtn')?.addEventListener('click', ()=>{ /* optional */ });

  document.getElementById('evSearchBtn')?.addEventListener('click', async ()=>{
    const make = document.getElementById('evMake').value.trim().toLowerCase();
    const model = document.getElementById('evModel').value.trim().toLowerCase();
    const year = document.getElementById('evYear').value.trim();
    if(!make && !model && !year) return alert('Enter search criteria');
    // check db evLinks for make
    const key = make.replace(/\s+/g,'_');
    const snap = await get(ref(db, `evLinks/${key}`));
    const hit = snap.val();
    if(hit && hit.url){
      document.getElementById('evResult').innerHTML = `<div style="font-weight:800">${make.toUpperCase()} ${model} ${year}</div><div style="margin-top:8px"><a href="${hit.url}" target="_blank" style="color:var(--accent)">${hit.url}</a></div>`;
    } else {
      document.getElementById('evResult').innerHTML = `<div class="muted">Manufacturer guide not found. Admins can add links in Admin page.</div>`;
    }
  });

  // weather alerts (NWS)
  async function fetchWeatherAlerts(){
    try{
      // Using NWS API: find alerts for Oswego county (Oswego county uses NY county code OSW maybe)
      // We'll query by county=OSW (Oswego) — if this fails, it will show no alerts.
      const res = await fetch('https://api.weather.gov/alerts/active?area=OSW');
      const data = await res.json();
      if(data && data.features && data.features.length>0){
        const titles = data.features.map(f=> f.properties.event );
        document.getElementById('weatherAlerts').textContent = titles.join(' • ');
      } else {
        document.getElementById('weatherAlerts').textContent = 'No active weather alerts';
      }
    } catch(err){
      console.error(err);
      document.getElementById('weatherAlerts').textContent = 'Weather alerts unavailable';
    }
  }

  document.getElementById('refreshWeather').addEventListener('click', fetchWeatherAlerts);

  // utility
  function canEdit(){ return CURRENT_USER && (CURRENT_USER.role === 'ADMIN' || CURRENT_USER.role === 'DEPTADMIN'); }

  function updateStats(){
    document.getElementById('statDepts').textContent = Object.keys(state.departments || {}).length;
    document.getElementById('statEms').textContent = Object.keys(state.ems || {}).length;
    document.getElementById('statTeams').textContent = Object.keys(state.countyTeams || {}).length;
    document.getElementById('statCoords').textContent = Object.keys(state.coordinators || {}).length;
  }

  // initial event listeners for admin nav
  document.getElementById('hazmatSearchBtn').addEventListener('click', ()=>{ document.getElementById('hazmatSearchBtn').classList.add('active') });
  // initial fetch
  // Note: do not call fetchWeatherAlerts until logged in & app initialized — login triggers fetch.
</script>
</body>
</html>
