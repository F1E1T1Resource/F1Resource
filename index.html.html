<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>F1 Resource — Oswego County</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
<style>
  :root{
    --accent:#9b5cff; --accent2:#ff6f91;
    --muted-dark:#cdbfe6; --white-dark:#f7f7fb;
    --muted-light:#4b5563; --black-light:#0b1220;
    --glass-dark:rgba(255,255,255,0.04); --glass-light:rgba(0,0,0,0.04);
  }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--text);background:linear-gradient(180deg,var(--bg-1),var(--bg-2));-webkit-font-smoothing:antialiased}
  /* theme switching */
  :root{color-scheme:dark}
  @media (prefers-color-scheme: dark){
    :root{--bg-1:#0b0622;--bg-2:#19062b;--card-bg:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));--muted:var(--muted-dark);--text:var(--white-dark);--glass:var(--glass-dark)}
  }
  @media (prefers-color-scheme: light){
    :root{--bg-1:#f5f7fb;--bg-2:#eef2f7;--card-bg:linear-gradient(180deg, rgba(0,0,0,0.02), rgba(0,0,0,0.01));--muted:var(--muted-light);--text:var(--black-light);--glass:var(--glass-light)}
  }

  /* layout */
  .app{display:flex;min-height:100vh}
  .sidebar{width:220px;padding:20px;background:transparent;border-right:1px solid rgba(0,0,0,0.06);display:flex;flex-direction:column;gap:18px}
  .sidebar .logo { display:flex;align-items:center;gap:12px }
  .sidebar .logo img{height:44px;width:auto;display:block}
  .navList{display:flex;flex-direction:column;gap:6px}
  .navBtn{background:transparent;border:none;text-align:left;padding:10px 12px;border-radius:10px;color:var(--muted);font-weight:700;cursor:pointer}
  .navBtn.active{background:linear-gradient(90deg, rgba(155,92,255,0.12), rgba(255,111,145,0.04));color:var(--text)}
  .main{flex:1;padding:20px;display:flex;flex-direction:column;gap:18px}
  .topBar{display:flex;justify-content:space-between;align-items:center}
  .logoSmall{height:36px}
  .card{background:var(--card-bg);padding:16px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,0.12);border:1px solid rgba(0,0,0,0.04)}
  .muted{color:var(--muted);font-size:13px}
  .sectionTitle{font-size:12px;letter-spacing:1px;text-transform:uppercase;color:var(--muted);margin-bottom:8px}

  /* lists */
  .listItem{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;background:var(--glass);margin-bottom:10px}
  .listLeft{display:flex;flex-direction:column}
  .listTitle{font-weight:800}
  .listMeta{font-size:13px;color:var(--muted)}

  /* inputs & buttons */
  input,textarea,select{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);background:transparent;color:var(--text);outline:none}
  .pill{padding:8px 12px;border-radius:999px;border:none;background:linear-gradient(90deg,var(--accent),var(--accent2));color:white;cursor:pointer;font-weight:800}
  .ghost{padding:8px 12px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);background:transparent;color:var(--muted);cursor:pointer}

  /* modal */
  .modalBack{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center;z-index:2000;backdrop-filter:blur(6px);opacity:0;pointer-events:none;transition:opacity .12s}
  .modalBack.show{opacity:1;pointer-events:auto}
  .modalCard{width:720px;max-width:96%;max-height:86vh;background:var(--card-bg);border-radius:14px;padding:18px;overflow:auto;border:1px solid rgba(0,0,0,0.06)}
  .modalHeader{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
  .modalActions{display:flex;justify-content:flex-end;gap:8px;margin-top:12px}

  /* responsiveness */
  @media(max-width:900px){
    .sidebar{display:none}
    .mobileTop{display:flex;align-items:center;gap:12px}
    .main{padding:12px}
  }
</style>
</head>
<body>

<!-- LOGIN VIEW -->
<div id="loginView" style="min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px">
  <div style="max-width:920px;width:100%;display:flex;gap:20px;align-items:stretch">
    <div style="width:320px;display:flex;flex-direction:column;align-items:center;gap:12px">
      <img src="/mnt/data/F1Resource-removebg-preview.png" alt="F1 Resource logo" style="max-width:260px;height:auto">
      <div class="muted">Oswego County — Fire Resource</div>
    </div>

    <div style="flex:1" class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <h2 style="margin:0">WELCOME</h2>
          <div class="muted">Please sign in to access the F1 Resource system.</div>
        </div>
        <div>
          <div style="font-weight:800;padding:6px 10px;border-radius:8px;background:linear-gradient(90deg,#ff5f6d,#ffc371);color:#111">Local Login</div>
        </div>
      </div>

      <div style="margin-top:16px;max-width:520px">
        <div style="margin-bottom:8px" class="muted">Username</div>
        <input id="login_username" placeholder="Username (e.g. ADMIN)" />
        <div style="margin-top:12px" class="muted">Password</div>
        <input id="login_password" type="password" placeholder="Password" />
        <div style="margin-top:14px;display:flex;gap:10px">
          <button id="btnLogin" class="pill">Login</button>
          <button id="btnDemoFill" class="ghost">Fill demo</button>
        </div>
        <div id="loginError" class="muted" style="margin-top:8px;color:#ffb3c6"></div>
      </div>

      <div style="margin-top:16px" class="muted">Tip: Admin credentials are local (not stored in Firebase). Use them for initial setup.</div>
    </div>
  </div>
</div>

<!-- APP (SPA) -->
<div id="app" style="display:none" class="app">
  <aside class="sidebar">
    <div class="logo">
      <img src="/mnt/data/F1Resource-removebg-preview.png" alt="F1 Resource logo">
    </div>

    <nav class="navList" aria-label="Main navigation">
      <button class="navBtn active" data-page="home">HOME</button>
      <button class="navBtn" data-page="fireDepartments">FIRE DEPARTMENTS</button>
      <button class="navBtn" data-page="emsAgencies">EMS AGENCIES</button>
      <button class="navBtn" data-page="coordinators">COUNTY COORDINATORS</button>
      <button class="navBtn" data-page="countyTeams">COUNTY TEAMS & SPECIAL OPS</button>
      <button class="navBtn" data-page="hazmat">HAZMAT SEARCH</button>
      <button class="navBtn" data-page="ev">EV SAFETY</button>
      <button class="navBtn" data-page="risks">FIRE & DRIVING RISK</button>
      <button class="navBtn" data-page="weather">WEATHER</button>
      <button class="navBtn" data-page="admin">ADMIN</button>
      <button class="navBtn" id="btnLogoutNav">LOGOUT</button>
    </nav>
  </aside>

  <main class="main">
    <div class="topBar">
      <div style="display:flex;gap:12px;align-items:center">
        <img src="/mnt/data/F1Resource-removebg-preview.png" alt="logo" class="logoSmall">
        <div>
          <h1 style="margin:0">F1 Resource — Oswego County</h1>
          <div class="muted">A realtime directory of departments, teams and safety references.</div>
        </div>
      </div>
      <div style="text-align:right">
        <div id="currentUser" class="muted">Not signed in</div>
      </div>
    </div>

    <!-- HOME: minimal -->
    <section id="page-home" class="card page active">
      <div class="sectionTitle">Welcome</div>
      <h2 style="margin:6px 0 12px">WELCOME</h2>
      <p class="muted">This is F1Resource — your all-inclusive application for resources in Oswego County.</p>
      <p class="muted">Use the left navigation to access Fire Departments, EMS Agencies, County Coordinators, County Teams, HazMat search, EV Safety, Risk guides, Weather, and Admin functions.</p>
    </section>

    <!-- FIRE DEPARTMENTS PAGE -->
    <section id="page-fireDepartments" class="card page" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><div class="sectionTitle">Fire Departments</div><h3 style="margin:6px 0">Oswego County Fire Departments</h3></div>
        <div><button id="openAddDept" class="pill">+ Add Department</button></div>
      </div>
      <div id="fireList" style="margin-top:12px"></div>
    </section>

    <!-- EMS AGENCIES PAGE -->
    <section id="page-emsAgencies" class="card page" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><div class="sectionTitle">EMS Agencies</div><h3 style="margin:6px 0">EMS Agencies</h3></div>
        <div><button id="openAddEms" class="pill">+ Add EMS Agency</button></div>
      </div>
      <div id="emsList" style="margin-top:12px"></div>
    </section>

    <!-- COORDINATORS PAGE -->
    <section id="page-coordinators" class="card page" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><div class="sectionTitle">County Coordinators</div><h3 style="margin:6px 0">Coordinators</h3></div>
        <div><button id="openAddCoord" class="pill">+ Add Coordinator</button></div>
      </div>
      <div id="coordList" style="margin-top:12px"></div>
    </section>

    <!-- COUNTY TEAMS PAGE -->
    <section id="page-countyTeams" class="card page" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><div class="sectionTitle">County Teams & Special Ops</div><h3 style="margin:6px 0">Teams</h3></div>
        <div><button id="openAddTeam" class="pill">+ Add Team</button></div>
      </div>
      <div id="teamList" style="margin-top:12px"></div>
    </section>

    <!-- HAZMAT SEARCH PAGE -->
    <section id="page-hazmat" class="card page" style="display:none">
      <div class="sectionTitle">HazMat Search</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <input id="hazInput" placeholder="UN / NA number" style="max-width:260px">
        <button id="btnHazSearch" class="pill">Search</button>
        <button id="btnHazExample" class="ghost">Example</button>
      </div>
      <div id="hazResult" style="margin-top:12px" class="muted">Search for a UN/NA number to view details.</div>
    </section>

    <!-- EV SAFETY PAGE -->
    <section id="page-ev" class="card page" style="display:none">
      <div class="sectionTitle">EV Safety</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <input id="evYear" placeholder="Year" style="max-width:110px">
        <input id="evMake" placeholder="Make" style="max-width:160px">
        <input id="evModel" placeholder="Model" style="max-width:160px">
        <button id="btnEvSearch" class="pill">Search</button>
      </div>
      <div id="evResult" style="margin-top:12px" class="muted">Manufacturer rescue links will appear here.</div>
    </section>

    <!-- RISKS PAGE -->
    <section id="page-risks" class="card page" style="display:none">
      <div class="sectionTitle">Fire & Driving Risk</div>
      <div class="muted">Guides and checklists — editable by Admin.</div>
    </section>

    <!-- WEATHER PAGE -->
    <section id="page-weather" class="card page" style="display:none">
      <div class="sectionTitle">Weather</div>
      <div id="weatherInfo" class="muted">Weather alerts & forecast.</div>
    </section>

    <!-- ADMIN PAGE -->
    <section id="page-admin" class="card page" style="display:none">
      <div class="sectionTitle">Admin</div>
      <div style="display:flex;gap:12px;flex-wrap:wrap">
        <button id="openHazAdmin" class="pill">Add HazMat Entry</button>
        <button id="openEvAdmin" class="pill">Add EV Link</button>
      </div>

      <div style="margin-top:12px" class="muted">Admin-only tasks: manage HazMat DB, EV links, import CSVs, manage users (local login table).</div>
    </section>

  </main>
</div>

<!-- MODAL (glass) -->
<div id="modal" class="modalBack" aria-hidden>
  <div class="modalCard">
    <div class="modalHeader">
      <div>
        <div id="modalTitle">Modal Title</div>
        <div id="modalSub" class="muted">Subtitle</div>
      </div>
      <div><button id="modalClose" class="ghost">Close</button></div>
    </div>
    <div id="modalBody"></div>
    <div id="modalActions" class="modalActions"></div>
  </div>
</div>

<!-- Firebase + App logic -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getDatabase, ref, push, set, onValue, remove, get } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

  // ---------- Firebase config (use provided config) ----------
  const firebaseConfig = {
    apiKey: "AIzaSyBi0Xyljx7zzXTmyyRMAru11hZ2s5S3tsw",
    authDomain: "f1resource-8fedc.firebaseapp.com",
    databaseURL: "https://f1resource-8fedc-default-rtdb.firebaseio.com",
    projectId: "f1resource-8fedc",
    storageBucket: "f1resource-8fedc.firebasestorage.app",
    messagingSenderId: "182745701982",
    appId: "1:182745701982:web:9f4f3836b41b450987decf"
  };
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // ---------- Local Users (kept local per your request) ----------
  const LOCAL_USERS = {
    "ADMIN": { password:"ADMIN", role: "ADMIN" },
    "DEPTADMIN": { password:"DEPTADMIN", role: "DEPTADMIN", dept: "Central Fire Dept" },
    "DEPTUSER": { password:"DEPTUSER", role: "DEPTUSER" }
  };
  let CURRENT_USER = null;

  // DOM refs
  const loginView = document.getElementById('loginView');
  const appView = document.getElementById('app');
  const btnLogin = document.getElementById('btnLogin');
  const btnDemoFill = document.getElementById('btnDemoFill');
  const loginErr = document.getElementById('loginError');
  const currentUserEl = document.getElementById('currentUser');
  const navButtons = document.querySelectorAll('.navBtn');
  const logoutNav = document.getElementById('btnLogoutNav');

  // modal refs
  const modalBack = document.getElementById('modal');
  const modalTitle = document.getElementById('modalTitle');
  const modalSub = document.getElementById('modalSub');
  const modalBody = document.getElementById('modalBody');
  const modalActions = document.getElementById('modalActions');
  const modalClose = document.getElementById('modalClose');

  // SPA pages mapping
  function showPage(page){
    document.querySelectorAll('.page').forEach(p=>p.style.display='none');
    const el = document.getElementById('page-' + page);
    if(el) el.style.display = 'block';
    // update nav active
    navButtons.forEach(b=> b.classList.toggle('active', b.getAttribute('data-page')===page));
    // admin page visibility
    document.getElementById('page-admin').style.display = (CURRENT_USER && CURRENT_USER.role === 'ADMIN') ? 'block' : 'none';
  }

  // wire nav buttons
  navButtons.forEach(b=> b.addEventListener('click', ()=> showPage(b.getAttribute('data-page'))));
  logoutNav.addEventListener('click', ()=> location.reload());

  // login
  btnDemoFill.addEventListener('click', ()=> {
    document.getElementById('login_username').value = 'ADMIN';
    document.getElementById('login_password').value = 'ADMIN';
  });

  btnLogin.addEventListener('click', ()=> {
    const u = document.getElementById('login_username').value.trim();
    const p = document.getElementById('login_password').value.trim();
    if(!u||!p){ loginErr.textContent = "Enter username & password"; return; }
    const user = LOCAL_USERS[u];
    if(!user || user.password !== p){ loginErr.textContent = "Invalid credentials"; return; }
    CURRENT_USER = { username: u, role: user.role, dept: user.dept || null };
    loginErr.textContent = '';
    loginView.style.display = 'none';
    appView.style.display = 'flex';
    currentUserEl.textContent = `${CURRENT_USER.username} — ${CURRENT_USER.role}`;
    initRealtime();
    fetchWeather();
  });

  // modal utilities
  function openModal(title, subtitle, bodyHtml, actionsHtml){
    modalTitle.textContent = title;
    modalSub.textContent = subtitle || '';
    modalBody.innerHTML = ''; modalActions.innerHTML = '';
    if(typeof bodyHtml === 'string') modalBody.innerHTML = bodyHtml; else if(bodyHtml instanceof Node) modalBody.appendChild(bodyHtml);
    if(Array.isArray(actionsHtml)){
      actionsHtml.forEach(a => modalActions.appendChild(a));
    }
    modalBack.classList.add('show'); modalBack.setAttribute('aria-hidden','false');
  }
  function closeModal(){ modalBack.classList.remove('show'); modalBack.setAttribute('aria-hidden','true'); modalBody.innerHTML=''; modalActions.innerHTML=''; }

  modalClose.addEventListener('click', closeModal);
  modalBack.addEventListener('click', (e)=> { if(e.target===modalBack) closeModal(); });

  // Realtime state & watchers
  const state = { departments:{}, ems:{}, coordinators:{}, countyTeams:{}, hazmatDB:{}, evLinks:{} };

  function initRealtime(){
    watchPath('departments'); watchPath('ems'); watchPath('coordinators'); watchPath('countyTeams'); watchPath('hazmatDB'); watchPath('evLinks');
  }

  function watchPath(path){
    onValue(ref(db, path), snap => {
      state[ path === 'countyTeams' ? 'countyTeams' : path ] = snap.val() || {};
      renderAll();
    });
  }

  // render functions
  function renderAll(){
    renderDepartments(); renderEms(); renderCoordinators(); renderTeams();
    // counts (optional)
  }

  function renderDepartments(){
    const container = document.getElementById('fireList');
    container.innerHTML = '';
    Object.entries(state.departments || {}).forEach(([key, item])=>{
      const row = document.createElement('div'); row.className='listItem';
      const left = document.createElement('div'); left.className='listLeft';
      const title = document.createElement('div'); title.className='listTitle'; title.textContent = item.name || 'Unnamed';
      const meta = document.createElement('div'); meta.className='listMeta'; meta.textContent = `${item.battalion? ('Battalion: '+item.battalion) : ''} ${item.address? ' • '+item.address : ''}`;
      left.appendChild(title); left.appendChild(meta);
      if(item.apparatus){
        const ul = document.createElement('ul'); ul.className='apparatusList';
        item.apparatus.split('|').map(s=>s.trim()).filter(Boolean).forEach(a=>{ const li=document.createElement('li'); li.textContent = a; ul.appendChild(li); });
        left.appendChild(ul);
      }
      const actions = document.createElement('div');
      if(CURRENT_USER.role === 'ADMIN' || (CURRENT_USER.role === 'DEPTADMIN' && CURRENT_USER.dept === item.name)){
        const edit = document.createElement('button'); edit.className='pill'; edit.textContent='Edit'; edit.onclick = ()=> openEditDepartment(key, item);
        const del = document.createElement('button'); del.className='ghost'; del.textContent='Delete'; del.onclick = ()=> { if(confirm('Delete?')) remove(ref(db, 'departments/'+key)); };
        actions.appendChild(edit); actions.appendChild(del);
      } else {
        const view = document.createElement('button'); view.className='ghost'; view.textContent='View'; view.onclick = ()=> showDepartmentDetails(key);
        actions.appendChild(view);
      }
      row.appendChild(left); row.appendChild(actions); container.appendChild(row);
    });
  }

  function renderEms(){
    const container = document.getElementById('emsList'); container.innerHTML='';
    Object.entries(state.ems || {}).forEach(([key, item])=>{
      const row = document.createElement('div'); row.className='listItem';
      const left = document.createElement('div'); left.className='listLeft';
      const title = document.createElement('div'); title.className='listTitle'; title.textContent = item.name || 'Unnamed EMS';
      const meta = document.createElement('div'); meta.className='listMeta'; meta.textContent = item.address || '';
      left.appendChild(title); left.appendChild(meta);
      if(item.apparatus){
        const ul = document.createElement('ul'); ul.className='apparatusList';
        item.apparatus.split('|').map(s=>s.trim()).filter(Boolean).forEach(a=>{ const li=document.createElement('li'); li.textContent=a; ul.appendChild(li); });
        left.appendChild(ul);
      }
      const actions = document.createElement('div');
      if(CURRENT_USER.role === 'ADMIN' || CURRENT_USER.role === 'DEPTADMIN'){
        const edit = document.createElement('button'); edit.className='pill'; edit.textContent='Edit'; edit.onclick = ()=> openEditEms(key, item);
        const del = document.createElement('button'); del.className='ghost'; del.textContent='Delete'; del.onclick = ()=> { if(confirm('Delete?')) remove(ref(db, 'ems/'+key)); };
        actions.appendChild(edit); actions.appendChild(del);
      } else {
        const view = document.createElement('button'); view.className='ghost'; view.textContent='View'; actions.appendChild(view);
      }
      row.appendChild(left); row.appendChild(actions); container.appendChild(row);
    });
  }

  function renderCoordinators(){
    const container = document.getElementById('coordList'); container.innerHTML='';
    Object.entries(state.coordinators || {}).forEach(([key, item])=>{
      const row = document.createElement('div'); row.className='listItem';
      const left = document.createElement('div'); left.className='listLeft';
      const title = document.createElement('div'); title.className='listTitle'; title.textContent = item.name || 'Unnamed';
      const meta = document.createElement('div'); meta.className='listMeta'; meta.textContent = item.callsign || '';
      left.appendChild(title); left.appendChild(meta);
      const actions = document.createElement('div');
      if(CURRENT_USER.role === 'ADMIN'){
        const edit = document.createElement('button'); edit.className='pill'; edit.textContent='Edit'; edit.onclick = ()=> openEditCoordinator(key, item);
        const del = document.createElement('button'); del.className='ghost'; del.textContent='Delete'; del.onclick = ()=> { if(confirm('Delete?')) remove(ref(db, 'coordinators/'+key)); };
        actions.appendChild(edit); actions.appendChild(del);
      }
      row.appendChild(left); row.appendChild(actions); container.appendChild(row);
    });
  }

  function renderTeams(){
    const container = document.getElementById('teamList'); container.innerHTML='';
    Object.entries(state.countyTeams || {}).forEach(([key, item])=>{
      const row = document.createElement('div'); row.className='listItem';
      const left = document.createElement('div'); left.className='listLeft';
      const title = document.createElement('div'); title.className='listTitle'; title.textContent = item.name || 'Team';
      const meta = document.createElement('div'); meta.className='listMeta'; meta.textContent = item.lead || '';
      left.appendChild(title); left.appendChild(meta);
      const actions = document.createElement('div');
      if(CURRENT_USER.role === 'ADMIN' || CURRENT_USER.role === 'DEPTADMIN'){
        const edit = document.createElement('button'); edit.className='pill'; edit.textContent='Edit'; edit.onclick = ()=> openEditTeam(key, item);
        const del = document.createElement('button'); del.className='ghost'; del.textContent='Delete'; del.onclick = ()=> { if(confirm('Delete?')) remove(ref(db, 'countyTeams/'+key)); };
        actions.appendChild(edit); actions.appendChild(del);
      }
      row.appendChild(left); row.appendChild(actions); container.appendChild(row);
    });
  }

  // ---------- open modal editors ----------
  function inputRow(label, value=''){
    const wrap = document.createElement('div'); wrap.style.marginTop='8px';
    const lab = document.createElement('div'); lab.style.fontWeight='700'; lab.style.marginBottom='6px'; lab.textContent = label;
    const inp = document.createElement('input'); inp.type='text'; inp.value = value || '';
    wrap.appendChild(lab); wrap.appendChild(inp);
    return { wrap, inp };
  }
  function textareaRow(label, value=''){
    const wrap = document.createElement('div'); wrap.style.marginTop='8px';
    const lab = document.createElement('div'); lab.style.fontWeight='700'; lab.style.marginBottom='6px'; lab.textContent = label;
    const ta = document.createElement('textarea'); ta.rows=5; ta.value = value || '';
    wrap.appendChild(lab); wrap.appendChild(ta);
    return { wrap, ta };
  }

  // departments
  function openAddDepartment(){
    if(!canModify()) return alert('Permission denied');
    modalTitle.textContent='Add Department'; modalSub.textContent='Enter department details';
    modalBody.innerHTML=''; modalActions.innerHTML='';
    const nameRow = inputRow('Department Name','');
    const battRow = inputRow('Battalion','');
    const addrRow = inputRow('Address','');
    const appRow = inputRow('Apparatus (use | to separate)','');
    const preview = document.createElement('div'); preview.className='muted'; preview.style.marginTop='8px'; preview.textContent='Preview: —';
    appRow.inp.addEventListener('input', ()=> preview.textContent = 'Preview: ' + (appRow.inp.value.split('|').map(s=>s.trim()).filter(Boolean).join(' • ')||'—'));
    modalBody.appendChild(nameRow.wrap); modalBody.appendChild(battRow.wrap); modalBody.appendChild(addrRow.wrap); modalBody.appendChild(appRow.wrap); modalBody.appendChild(preview);

    const saveBtn = document.createElement('button'); saveBtn.className='pill'; saveBtn.textContent='Create';
    saveBtn.onclick = async ()=>{
      const val = { name: nameRow.inp.value.trim() || 'Unnamed', battalion: battRow.inp.value.trim()||'', address: addrRow.inp.value.trim()||'', apparatus: appRow.inp.value.trim()||'' };
      const p = await push(ref(db, 'departments')); await set(ref(db, `departments/${p.key}`), val);
      closeModal();
    };
    const cancel = document.createElement('button'); cancel.className='ghost'; cancel.textContent='Cancel'; cancel.onclick = closeModal;
    modalActions.appendChild(saveBtn); modalActions.appendChild(cancel);
    modalBack.classList.add('show'); modalBack.setAttribute('aria-hidden','false');
  }

  async function openEditDepartment(key, data){
    if(!canModify()) return alert('Permission denied');
    modalTitle.textContent='Edit Department'; modalSub.textContent='';
    modalBody.innerHTML=''; modalActions.innerHTML='';
    const nameRow = inputRow('Department Name', data.name||'');
    const battRow = inputRow('Battalion', data.battalion||'');
    const addrRow = inputRow('Address', data.address||'');
    const appRow = inputRow('Apparatus (use | to separate)', data.apparatus||'');
    const preview = document.createElement('div'); preview.className='muted'; preview.style.marginTop='8px';
    preview.textContent = 'Preview: ' + (appRow.inp.value.split('|').map(s=>s.trim()).filter(Boolean).join(' • ')||'—');
    appRow.inp.addEventListener('input', ()=> preview.textContent = 'Preview: ' + (appRow.inp.value.split('|').map(s=>s.trim()).filter(Boolean).join(' • ')||'—'));
    modalBody.appendChild(nameRow.wrap); modalBody.appendChild(battRow.wrap); modalBody.appendChild(addrRow.wrap); modalBody.appendChild(appRow.wrap); modalBody.appendChild(preview);

    const saveBtn = document.createElement('button'); saveBtn.className='pill'; saveBtn.textContent='Save';
    saveBtn.onclick = async ()=>{
      const val = { name: nameRow.inp.value.trim() || 'Unnamed', battalion: battRow.inp.value.trim()||'', address: addrRow.inp.value.trim()||'', apparatus: appRow.inp.value.trim()||'' };
      await set(ref(db, `departments/${key}`), val);
      closeModal();
    };
    modalActions.appendChild(saveBtn); modalActions.appendChild(Object.assign(document.createElement('button'),{className:'ghost',textContent:'Cancel',onclick:closeModal}));
    modalBack.classList.add('show'); modalBack.setAttribute('aria-hidden','false');
  }

  // EMS add/edit
  function openAddEms(){
    if(!canModify()) return alert('Permission denied');
    modalTitle.textContent='Add EMS Agency'; modalSub.textContent='';
    modalBody.innerHTML=''; modalActions.innerHTML='';
    const name = inputRow('Agency name',''); const addr = inputRow('Address',''); const app = inputRow('Apparatus (use |)','');
    const preview = document.createElement('div'); preview.className='muted'; preview.style.marginTop='8px';
    app.inp.addEventListener('input', ()=> preview.textContent = 'Preview: ' + (app.inp.value.split('|').map(s=>s.trim()).filter(Boolean).join(' • ')||'—'));
    modalBody.appendChild(name.wrap); modalBody.appendChild(addr.wrap); modalBody.appendChild(app.wrap); modalBody.appendChild(preview);
    const save = document.createElement('button'); save.className='pill'; save.textContent='Create';
    save.onclick = async ()=> { const val={name:name.inp.value.trim()||'Unnamed',address:addr.inp.value.trim()||'',apparatus:app.inp.value.trim()||''}; const p = await push(ref(db,'ems')); await set(ref(db, 'ems/'+p.key), val); closeModal(); };
    modalActions.appendChild(save); modalActions.appendChild(Object.assign(document.createElement('button'),{className:'ghost',textContent:'Cancel',onclick:closeModal}));
    modalBack.classList.add('show'); modalBack.setAttribute('aria-hidden','false');
  }

  async function openEditEms(key,data){
    if(!canModify()) return alert('Permission denied');
    modalTitle.textContent='Edit EMS Agency'; modalBody.innerHTML=''; modalActions.innerHTML='';
    const name = inputRow('Agency name', data.name||''); const addr = inputRow('Address', data.address||''); const app = inputRow('Apparatus (use |)', data.apparatus||'');
    const preview = document.createElement('div'); preview.className='muted'; preview.style.marginTop='8px'; preview.textContent='Preview: ' + (app.inp.value.split('|').map(s=>s.trim()).filter(Boolean).join(' • ')||'—');
    app.inp.addEventListener('input', ()=> preview.textContent = 'Preview: ' + (app.inp.value.split('|').map(s=>s.trim()).filter(Boolean).join(' • ')||'—'));
    modalBody.appendChild(name.wrap); modalBody.appendChild(addr.wrap); modalBody.appendChild(app.wrap); modalBody.appendChild(preview);
    const save = document.createElement('button'); save.className='pill'; save.textContent='Save';
    save.onclick = async ()=> { const val={name:name.inp.value.trim()||'Unnamed',address:addr.inp.value.trim()||'',apparatus:app.inp.value.trim()||''}; await set(ref(db, `ems/${key}`), val); closeModal(); };
    modalActions.appendChild(save); modalActions.appendChild(Object.assign(document.createElement('button'),{className:'ghost',textContent:'Cancel',onclick:closeModal}));
    modalBack.classList.add('show'); modalBack.setAttribute('aria-hidden','false');
  }

  // coordinators
  function openAddCoordinator(){
    if(!canModify()) return alert('Permission denied');
    modalTitle.textContent='Add Coordinator'; modalBody.innerHTML=''; modalActions.innerHTML='';
    const name = inputRow('Name',''); const callsign = inputRow('Callsign','');
    modalBody.appendChild(name.wrap); modalBody.appendChild(callsign.wrap);
    const save = document.createElement('button'); save.className='pill'; save.textContent='Create';
    save.onclick = async ()=> { const val={name:name.inp.value.trim()||'',callsign:callsign.inp.value.trim()||''}; const p = await push(ref(db,'coordinators')); await set(ref(db, `coordinators/${p.key}`), val); closeModal(); };
    modalActions.appendChild(save); modalActions.appendChild(Object.assign(document.createElement('button'),{className:'ghost',textContent:'Cancel',onclick:closeModal}));
    modalBack.classList.add('show'); modalBack.setAttribute('aria-hidden','false');
  }

  async function openEditCoordinator(key, data){
    if(!canModify()) return alert('Permission denied');
    modalTitle.textContent='Edit Coordinator'; modalBody.innerHTML=''; modalActions.innerHTML='';
    const name = inputRow('Name', data.name||''); const callsign = inputRow('Callsign', data.callsign||'');
    modalBody.appendChild(name.wrap); modalBody.appendChild(callsign.wrap);
    const save = document.createElement('button'); save.className='pill'; save.textContent='Save';
    save.onclick = async ()=> { const val={name:name.inp.value.trim(),callsign:callsign.inp.value.trim()}; await set(ref(db, `coordinators/${key}`), val); closeModal(); };
    modalActions.appendChild(save); modalActions.appendChild(Object.assign(document.createElement('button'),{className:'ghost',textContent:'Cancel',onclick:closeModal}));
    modalBack.classList.add('show'); modalBack.setAttribute('aria-hidden','false');
  }

  // teams
  function openAddTeam(){
    if(!canModify()) return alert('Permission denied');
    modalTitle.textContent='Add Team'; modalBody.innerHTML=''; modalActions.innerHTML='';
    const name = inputRow('Team Name',''); const lead = inputRow('Team Lead','');
    modalBody.appendChild(name.wrap); modalBody.appendChild(lead.wrap);
    const save = document.createElement('button'); save.className='pill'; save.textContent='Create';
    save.onclick = async ()=> { const val={name:name.inp.value.trim()||'',lead:lead.inp.value.trim()||''}; const p = await push(ref(db,'countyTeams')); await set(ref(db, `countyTeams/${p.key}`), val); closeModal(); };
    modalActions.appendChild(save); modalActions.appendChild(Object.assign(document.createElement('button'),{className:'ghost',textContent:'Cancel',onclick:closeModal}));
    modalBack.classList.add('show'); modalBack.setAttribute('aria-hidden','false');
  }

  async function openEditTeam(key, data){
    if(!canModify()) return alert('Permission denied');
    modalTitle.textContent='Edit Team'; modalBody.innerHTML=''; modalActions.innerHTML='';
    const name = inputRow('Team Name', data.name||''); const lead = inputRow('Team Lead', data.lead||'');
    modalBody.appendChild(name.wrap); modalBody.appendChild(lead.wrap);
    const save = document.createElement('button'); save.className='pill'; save.textContent='Save';
    save.onclick = async ()=> { const val={name:name.inp.value.trim(),lead:lead.inp.value.trim()}; await set(ref(db, `countyTeams/${key}`), val); closeModal(); };
    modalActions.appendChild(save); modalActions.appendChild(Object.assign(document.createElement('button'),{className:'ghost',textContent:'Cancel',onclick:closeModal}));
    modalBack.classList.add('show'); modalBack.setAttribute('aria-hidden','false');
  }

  // hazmat search & admin add/edit
  async function doHazmatSearch(){
    const q = document.getElementById('hazInput').value.trim();
    if(!q) return alert('Enter UN number');
    const snap = await get(ref(db, `hazmatDB/${q}`));
    const val = snap.val();
    const out = document.getElementById('hazResult');
    if(val) out.innerHTML = `<div style="font-weight:800">${val.name} (UN ${q})</div><div class="muted">${val.notes||''}</div>`;
    else out.innerHTML = `<div class="muted">No entry for UN ${q}. Admin can add via Admin page.</div>`;
  }

  function openAddHazmat(){
    if(!CURRENT_USER || CURRENT_USER.role !== 'ADMIN') return alert('Admin only');
    modalTitle.textContent='Add HazMat Entry'; modalBody.innerHTML=''; modalActions.innerHTML='';
    const un = inputRow('UN / NA Number',''); const name = inputRow('Name',''); const notes = textareaRow('Notes','');
    modalBody.appendChild(un.wrap); modalBody.appendChild(name.wrap); modalBody.appendChild(notes.wrap);
    const save = document.createElement('button'); save.className='pill'; save.textContent='Save';
    save.onclick = async ()=> { const u = un.inp.value.trim(); if(!u) return alert('Enter UN'); const obj={un:u,name:name.inp.value.trim()||'',notes:notes.ta.value.trim()||''}; await set(ref(db, `hazmatDB/${u}`), obj); closeModal(); };
    modalActions.appendChild(save); modalActions.appendChild(Object.assign(document.createElement('button'),{className:'ghost',textContent:'Cancel',onclick:closeModal}));
    modalBack.classList.add('show'); modalBack.setAttribute('aria-hidden','false');
  }

  // EV admin add
  function openAddEvLink(){
    if(!CURRENT_USER || CURRENT_USER.role !== 'ADMIN') return alert('Admin only');
    modalTitle.textContent='Add EV Link'; modalBody.innerHTML=''; modalActions.innerHTML='';
    const make = inputRow('Make',''); const url = inputRow('Rescue URL','');
    modalBody.appendChild(make.wrap); modalBody.appendChild(url.wrap);
    const save = document.createElement('button'); save.className='pill'; save.textContent='Save';
    save.onclick = async ()=> { const m = make.inp.value.trim(); const u = url.inp.value.trim(); if(!m||!u) return alert('Enter make and url'); const key = m.toLowerCase().replace(/\s+/g,'_'); await set(ref(db, `evLinks/${key}`), { make: m, url: u }); closeModal(); };
    modalActions.appendChild(save); modalActions.appendChild(Object.assign(document.createElement('button'),{className:'ghost',textContent:'Cancel',onclick:closeModal}));
    modalBack.classList.add('show'); modalBack.setAttribute('aria-hidden','false');
  }

  // EV search
  async function doEvSearch(){
    const makeRaw = (document.getElementById('evMake').value||'').trim().toLowerCase();
    if(!makeRaw) return alert('Enter Make');
    const key = makeRaw.replace(/\s+/g,'_');
    const snap = await get(ref(db, `evLinks/${key}`));
    const val = snap.val();
    if(val) document.getElementById('evResult').innerHTML = `<div style="font-weight:800">${val.make}</div><div class="muted"><a href="${val.url}" target="_blank">${val.url}</a></div>`;
    else document.getElementById('evResult').innerHTML = `<div class="muted">No guide found for that make. Admin can add link.</div>`;
  }

  // small helpers
  function canModify(){ return CURRENT_USER && (CURRENT_USER.role === 'ADMIN' || CURRENT_USER.role === 'DEPTADMIN'); }
  function textareaRow(label, value=''){ const w=document.createElement('div'); w.style.marginTop='8px'; const l=document.createElement('div'); l.style.fontWeight='700'; l.style.marginBottom='6px'; l.textContent=label; const ta=document.createElement('textarea'); ta.rows=5; ta.value=value||''; w.appendChild(l); w.appendChild(ta); return { wrap:w, ta }; }

  // hooks: wire UI buttons to functions
  document.getElementById('openAddDept').addEventListener('click', openAddDepartment);
  document.getElementById('openAddEms').addEventListener('click', openAddEms);
  document.getElementById('openAddCoord').addEventListener('click', openAddCoordinator);
  document.getElementById('openAddTeam').addEventListener('click', openAddTeam);
  document.getElementById('btnHazSearch').addEventListener('click', doHazmatSearch);
  document.getElementById('btnHazExample').addEventListener('click', ()=> { document.getElementById('hazInput').value='1203'; doHazmatSearch(); });
  document.getElementById('openHazAdmin').addEventListener('click', openAddHazmat);
  document.getElementById('openEvAdmin').addEventListener('click', openAddEvLink);
  document.getElementById('btnEvSearch').addEventListener('click', doEvSearch);

  // department detail placeholder
  function showDepartmentDetails(key){
    // for now open a modal with full record
    const rec = state.departments[key];
    if(!rec) return alert('Not found');
    modalTitle.textContent = rec.name; modalSub.textContent = rec.battalion || '';
    modalBody.innerHTML = `<div class="muted">Address: ${rec.address || '—'}</div><div style="margin-top:8px"><strong>Apparatus:</strong><ul>${(rec.apparatus||'').split('|').map(s=>`<li>${s.trim()}</li>`).join('')}</ul></div>`;
    modalActions.innerHTML = '';
    const close = Object.assign(document.createElement('button'),{className:'ghost',textContent:'Close',onclick:closeModal});
    modalActions.appendChild(close);
    modalBack.classList.add('show'); modalBack.setAttribute('aria-hidden','false');
  }

  // Weather (NWS) — active alerts for Oswego County (OSW)
  async function fetchWeather(){
    try{
      const res = await fetch('https://api.weather.gov/alerts/active?area=OSW');
      const data = await res.json();
      if(data && data.features && data.features.length){
        const titles = data.features.map(f => f.properties.event);
        document.getElementById('weatherInfo').textContent = data.features.map(f => `${f.properties.event} — ${f.properties.areaDesc}`).join('\n\n');
        // small alert
        const alerts = titles.join(' • ');
        // show in top bar maybe as muted text
        // (we keep it simple: update the Home area maybe)
      } else {
        document.getElementById('weatherInfo').textContent = 'No active alerts';
      }
    } catch(e){
      console.error(e);
      document.getElementById('weatherInfo').textContent = 'Weather service unavailable';
    }
  }

  // Initialize: nothing until login
  // (All data will start syncing after local login triggers initRealtime())

</script>
</body>
</html>
