<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>F1 Resource ‚Äî Oswego County</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg-1: #0b0622;
    --bg-2: #19062b;
    --panel: #1f0833;
    --card: rgba(255,255,255,0.03);
    --accent: #9b5cff;
    --accent-2: #ff6f91;
    --muted: #cdbfe6;
    --white: #f7f7fb;
    --glass: rgba(255,255,255,0.03);
    --success: #28a745;
  }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--white);background:linear-gradient(180deg,var(--bg-1),var(--bg-2));-webkit-font-smoothing:antialiased}
  /* Layout */
  .app{display:flex;min-height:100vh;gap:18px}
  .sidebar {
    width:88px; padding:18px 10px; display:flex;flex-direction:column;align-items:center; gap:14px;
    background:linear-gradient(180deg,#150623,#230a39); box-shadow:6px 0 24px rgba(0,0,0,0.45);
    border-right:1px solid rgba(255,255,255,0.02);
  }
  .brand {
    width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent-2));
    display:flex;align-items:center;justify-content:center;font-weight:900;font-size:18px;color:#fff;box-shadow:0 8px 28px rgba(155,92,255,0.15);
  }
  nav.main { display:flex;flex-direction:column; gap:8px; width:100%; align-items:center; margin-top:6px;}
  nav button.navBtn { width:64px; padding:10px;border-radius:12px;border:none;background:transparent;color:var(--muted); cursor:pointer; font-weight:700; font-size:11px; transition:all .18s; text-align:center; }
  nav button.navBtn.active, nav button.navBtn:hover { background:rgba(155,92,255,0.12); color:var(--white); box-shadow:inset 0 0 18px rgba(155,92,255,0.06); transform:translateY(-2px); }
  .navLabel { font-size:10px;color:rgba(255,255,255,0.15); margin-top:6px; text-align:center; }

  .mainWrap { flex:1; display:flex; flex-direction:column; gap:18px; padding:22px; }
  .topBar { display:flex; justify-content:space-between; align-items:center; gap:12px; }
  .leftTop { display:flex; gap:12px; align-items:center; }
  .hero { display:flex; gap:14px; align-items:center; }
  .logoBig { width:84px;height:84px;border-radius:14px;background:linear-gradient(90deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:900;font-size:28px}
  h1.title { margin:0; font-size:28px; letter-spacing:1px; font-weight:800; color:var(--white); }
  .subtitle { margin:0; color:var(--muted); font-size:13px; }

  .card { background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:12px; padding:16px; box-shadow:0 8px 24px rgba(0,0,0,0.45); border:1px solid rgba(255,255,255,0.02) }
  .grid { display:grid; grid-template-columns: 1fr 360px; gap:18px; align-items:start; }
  .sectionTitle { color:var(--muted); font-weight:800; font-size:12px; letter-spacing:1px; text-transform:uppercase; margin-bottom:8px; }

  /* List items */
  .listItem { background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02)); padding:12px; border-radius:10px; border:1px solid rgba(255,255,255,0.02); display:flex; justify-content:space-between; gap:12px; align-items:center; margin-bottom:10px; }
  .listLeft { display:flex; flex-direction:column; gap:6px; max-width:66%; }
  .listTitle { margin:0; font-weight:800; font-size:15px; color:var(--white) }
  .listMeta { margin:0; color:var(--muted); font-size:13px }
  .apparatusList { margin:8px 0 0 16px; color:var(--muted) }
  .actions { display:flex; gap:8px; align-items:center; }

  /* inputs & buttons */
  input[type="text"], input[type="search"], select, textarea {
    width:100%; padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,0.04); background:transparent; color:var(--white); outline:none;
  }
  .pill { padding:8px 12px; border-radius:999px; border:none; cursor:pointer; font-weight:800; color:white; background:linear-gradient(90deg,var(--accent),var(--accent-2)); box-shadow:0 8px 22px rgba(155,92,255,0.12) }
  .ghost { background:transparent; border:1px solid rgba(255,255,255,0.04); color:var(--muted); padding:8px 10px; border-radius:8px; cursor:pointer; }

  .muted { color:var(--muted); font-size:13px; }

  /* admin column */
  aside.rightCol { min-width:320px; display:flex; flex-direction:column; gap:12px; }
  .stats { display:flex; gap:10px; flex-direction:column; }

  /* login screen */
  .loginRoot { min-height:100vh; display:flex; align-items:center; justify-content:center; padding:28px; }
  .loginCard { width:900px; display:flex; gap:28px; border-radius:14px; padding:18px; background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.03)); border:1px solid rgba(255,255,255,0.03); box-shadow:0 12px 48px rgba(0,0,0,0.55);}
  .loginLeft { display:flex; flex-direction:column; align-items:center; gap:12px; width:240px; }
  .loginTitle { font-weight:800; font-size:20px; color:var(--white) }

  /* small screen */
  @media(max-width:1000px){
    .grid { grid-template-columns: 1fr; }
    .sidebar { display:none; }
    .loginCard { width:100%; }
    .mainWrap { padding:14px; }
    .logoBig { width:68px;height:68px;font-size:22px }
  }
  @media(max-width:520px){ h1.title{font-size:20px} .logoBig{width:56px;height:56px} }
</style>
</head>
<body>

<!-- LOGIN ROOT -->
<div id="loginRoot" class="loginRoot">
  <div class="loginCard">
    <div class="loginLeft">
      <div style="width:160px;height:160px;border-radius:14px;background:linear-gradient(90deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:900;font-size:40px">F1</div>
      <div class="muted">Oswego County Fire Resource</div>
    </div>

    <div style="flex:1">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div class="loginTitle">F1 Resource</div>
          <div class="muted">All county resources ‚Äî one unified app</div>
        </div>
        <div style="text-align:right">
          <div style="background:linear-gradient(90deg,#ff5f6d,#ffc371);padding:8px 12px;border-radius:8px;color:#111;font-weight:800">Local Login</div>
        </div>
      </div>

      <div style="margin-top:18px">
        <div class="muted">Enter username & password</div>
        <div style="margin-top:12px;display:flex;flex-direction:column;gap:10px;max-width:420px">
          <input id="login_username" placeholder="Username (e.g. ADMIN)" />
          <input id="login_password" placeholder="Password" type="password" />
          <div style="display:flex;gap:10px">
            <button id="btnLogin" class="pill">Login</button>
            <button id="btnFill" class="ghost">Fill demo</button>
          </div>
          <div id="loginError" class="muted" style="margin-top:6px;color:#ffb3c6"></div>
        </div>
      </div>

      <div style="margin-top:16px" class="muted">Tip: Admin user is hidden. Example accounts (for testing): ADMIN/ADMIN, DEPTADMIN/DEPTADMIN, DEPTUSER/DEPTUSER</div>
    </div>
  </div>
</div>

<!-- APP ROOT -->
<div id="appRoot" class="app" style="display:none">
  <aside class="sidebar" aria-hidden>
    <div class="brand">F1</div>
    <nav class="main" role="navigation">
      <button class="navBtn active" data-page="home" title="Home">üè†</button>
      <button class="navBtn" data-page="departments" title="Fire Departments">üöí</button>
      <button class="navBtn" data-page="ems" title="EMS Agencies">üöë</button>
      <button class="navBtn" data-page="coordinators" title="Coordinators">üìã</button>
      <button class="navBtn" data-page="countyTeams" title="County Teams">üß∞</button>
      <button class="navBtn" data-page="hazmat" title="HazMat">‚ö†Ô∏è</button>
      <button class="navBtn" data-page="ev" title="EV Safety">üîå</button>
      <button class="navBtn" data-page="risks" title="Risks">üìà</button>
      <button class="navBtn" data-page="weather" title="Weather">‚òÄÔ∏è</button>
      <button class="navBtn" data-page="admin" title="Admin">‚öôÔ∏è</button>
      <div class="navLabel">Oswego County</div>
    </nav>
  </aside>

  <main class="mainWrap" role="main">
    <div class="topBar">
      <div class="leftTop">
        <div class="hero">
          <div class="logoBig">F1</div>
          <div>
            <h1 class="title">F1 Resource ‚Äî Oswego County</h1>
            <p class="subtitle">A realtime directory of departments, agencies, teams and safety information.</p>
          </div>
        </div>
      </div>
      <div style="text-align:right">
        <div id="userInfo" class="muted">Not logged in</div>
        <div style="margin-top:8px">
          <button id="btnLogout" class="ghost">Logout</button>
        </div>
      </div>
    </div>

    <!-- Weather alert -->
    <div id="weatherAlert" class="card" style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <div class="sectionTitle">Active Weather Alerts</div>
        <div id="alertsText" class="muted">Loading alerts‚Ä¶</div>
      </div>
      <div style="text-align:right">
        <div class="muted">Oswego County</div>
        <div style="margin-top:8px"><button id="btnRefreshWeather" class="pill small">Refresh</button></div>
      </div>
    </div>

    <div class="grid">
      <div>
        <!-- HOME PAGE -->
        <section id="page-home" class="card page active">
          <div class="sectionTitle">Dashboard</div>
          <div style="display:flex;gap:12px;flex-wrap:wrap">
            <div class="card" style="flex:1;min-width:240px">
              <div style="font-weight:800">Quick Actions</div>
              <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
                <button class="pill" id="quickAddDept">Add Dept</button>
                <button class="pill" id="quickAddEms">Add EMS</button>
                <button class="pill" id="quickHaz">Search HazMat</button>
              </div>
            </div>

            <div class="card" style="width:300px">
              <div style="font-weight:800">Statistics</div>
              <div style="margin-top:10px" class="muted">
                Departments: <strong id="statDept">0</strong><br/>
                EMS Agencies: <strong id="statEms">0</strong><br/>
                County Teams: <strong id="statTeams">0</strong><br/>
                Coordinators: <strong id="statCoords">0</strong>
              </div>
            </div>
          </div>
        </section>

        <!-- DEPARTMENTS -->
        <section id="page-departments" class="card page">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><div class="sectionTitle">Fire Departments</div></div>
            <div><button id="addDeptBtn" class="pill">+ Add Department</button></div>
          </div>
          <div id="departmentsContainer" style="margin-top:12px"></div>
        </section>

        <!-- EMS -->
        <section id="page-ems" class="card page">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><div class="sectionTitle">EMS Agencies</div></div>
            <div><button id="addEmsBtn" class="pill">+ Add EMS</button></div>
          </div>
          <div id="emsContainer" style="margin-top:12px"></div>
        </section>

        <!-- COORDINATORS -->
        <section id="page-coordinators" class="card page">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><div class="sectionTitle">County Coordinators</div></div>
            <div><button id="addCoordBtn" class="pill">+ Add Coordinator</button></div>
          </div>
          <div id="coordContainer" style="margin-top:12px"></div>
        </section>

        <!-- COUNTY TEAMS -->
        <section id="page-countyTeams" class="card page">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><div class="sectionTitle">County Teams & Special Ops</div></div>
            <div><button id="addTeamBtn" class="pill">+ Add Team</button></div>
          </div>
          <div id="teamsContainer" style="margin-top:12px"></div>
        </section>

        <!-- HAZMAT SEARCH -->
        <section id="page-hazmat" class="card page">
          <div class="sectionTitle">HazMat Search</div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
            <input id="hazInput" placeholder="UN / NA number (e.g. 1203)" style="max-width:300px" />
            <button id="hazSearchBtn" class="pill">Search</button>
            <button id="hazExample" class="ghost">Example: 1203</button>
          </div>
          <div id="hazResults" style="margin-top:12px" class="muted">Results will appear here.</div>
        </section>

        <!-- EV -->
        <section id="page-ev" class="card page">
          <div class="sectionTitle">Electric Vehicle Safety</div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
            <input id="evYear" placeholder="Year" style="max-width:120px" />
            <input id="evMake" placeholder="Make" style="max-width:160px" />
            <input id="evModel" placeholder="Model" style="max-width:160px" />
            <button id="evSearchBtn" class="pill">Search</button>
          </div>
          <div id="evResults" style="margin-top:12px" class="muted">Manufacturer rescue links will appear here.</div>
        </section>

        <!-- RISKS -->
        <section id="page-risks" class="card page">
          <div class="sectionTitle">Fire & Driving Risk</div>
          <div class="muted">Checklists and risk guides (editable by Admin).</div>
        </section>

        <!-- WEATHER -->
        <section id="page-weather" class="card page">
          <div class="sectionTitle">Weather (Full)</div>
          <div id="weatherFull" class="muted" style="margin-top:8px">Forecast and details will appear here.</div>
        </section>
      </div>

      <!-- RIGHT COLUMN -->
      <aside class="rightCol">
        <div id="page-admin" class="card page" style="display:none">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div class="sectionTitle">Admin</div>
            <div><button id="importCsvBtn" class="ghost">Import CSV</button></div>
          </div>

          <div style="margin-top:12px">
            <div style="font-weight:800;margin-bottom:6px">HazMat DB</div>
            <input id="adminHazUn" placeholder="UN number (e.g. 1203)" />
            <input id="adminHazName" placeholder="Proper name" style="margin-top:8px" />
            <div style="margin-top:8px;display:flex;gap:8px">
              <button id="adminAddHaz" class="pill">Add / Update HazMat</button>
              <button id="adminExportHaz" class="ghost">Export</button>
            </div>
          </div>

          <hr style="border:none;border-top:1px solid rgba(255,255,255,0.03);margin:12px 0" />

          <div style="font-weight:800;margin-bottom:6px">EV Links</div>
          <input id="adminEvMake" placeholder="Make (e.g. Tesla)" />
          <input id="adminEvUrl" placeholder="Rescue guide URL" style="margin-top:8px" />
          <div style="margin-top:8px"><button id="adminAddEv" class="pill">Add EV Link</button></div>
        </div>

        <div class="card">
          <div class="sectionTitle">At a glance</div>
          <div style="margin-top:8px" class="muted">
            Departments: <strong id="countDept">0</strong><br/>
            EMS Agencies: <strong id="countEms">0</strong><br/>
            County Teams: <strong id="countTeams">0</strong><br/>
            Coordinators: <strong id="countCoords">0</strong>
          </div>
        </div>

        <div class="card">
          <div class="sectionTitle">Shortcuts</div>
          <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
            <button class="ghost" onclick="navigate('departments')">Departments</button>
            <button class="ghost" onclick="navigate('hazmat')">HazMat</button>
            <button class="ghost" onclick="navigate('weather')">Weather</button>
          </div>
        </div>
      </aside>
    </div>
  </main>
</div>

<!-- Firebase + App logic -->
<script type="module">
  // Firebase imports
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getDatabase, ref, push, set, onValue, remove, get } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

  // ---------- Firebase configuration (use provided config) ----------
  const firebaseConfig = {
    apiKey: "AIzaSyBi0Xyljx7zzXTmyyRMAru11hZ2s5S3tsw",
    authDomain: "f1resource-8fedc.firebaseapp.com",
    databaseURL: "https://f1resource-8fedc-default-rtdb.firebaseio.com",
    projectId: "f1resource-8fedc",
    storageBucket: "f1resource-8fedc.firebasestorage.app",
    messagingSenderId: "182745701982",
    appId: "1:182745701982:web:9f4f3836b41b450987decf"
  };
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // ---------- Local Login Users ----------
  // Local login (kept in code); not stored in Firebase per your request.
  const USERS = {
    "ADMIN": { password:"ADMIN", role:"ADMIN" },
    "DEPTADMIN": { password:"DEPTADMIN", role:"DEPTADMIN", dept: "Central Fire Dept" },
    "DEPTUSER": { password:"DEPTUSER", role:"DEPTUSER" }
  };
  let CURRENT_USER = null;

  // DOM shortcuts
  const loginRoot = document.getElementById('loginRoot');
  const appRoot = document.getElementById('appRoot');
  const btnLogin = document.getElementById('btnLogin');
  const btnFill = document.getElementById('btnFill');
  const loginError = document.getElementById('loginError');
  const userInfo = document.getElementById('userInfo');
  const btnLogout = document.getElementById('btnLogout');

  // page / nav handlers
  const navButtons = document.querySelectorAll('nav.main .navBtn');
  navButtons.forEach(b => b.addEventListener('click', ()=>{
    navButtons.forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    const page = b.getAttribute('data-page');
    showPage(page);
  }));

  function navigate(name){ document.querySelector(`nav.main .navBtn[data-page="${name}"]`)?.click(); }

  function showPage(name){
    document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
    const el = document.getElementById('page-' + name);
    if(el) el.classList.add('active');
    // admin page show/hide
    document.getElementById('page-admin').style.display = (CURRENT_USER && CURRENT_USER.role === 'ADMIN') ? 'block' : 'none';
  }

  // login flow
  btnLogin.addEventListener('click', doLogin);
  btnFill.addEventListener('click', ()=>{ document.getElementById('login_username').value='ADMIN'; document.getElementById('login_password').value='ADMIN'; });

  function doLogin(){
    const u = document.getElementById('login_username').value.trim();
    const p = document.getElementById('login_password').value.trim();
    if(!u || !p){ loginError.textContent = "Please enter username & password"; return; }
    const user = USERS[u];
    if(!user || user.password !== p){ loginError.textContent = "Invalid credentials"; return; }
    CURRENT_USER = { username: u, role: user.role, dept: user.dept || null };
    loginError.textContent = '';
    loginRoot.style.display = 'none';
    appRoot.style.display = 'flex';
    userInfo.textContent = `${CURRENT_USER.username} ‚Äî ${CURRENT_USER.role}`;
    initRealtime();
    fetchWeatherAlerts();
  }

  btnLogout.addEventListener('click', ()=> location.reload());

  // ---------- Realtime state and listeners ----------
  const state = { departments:{}, ems:{}, coordinators:{}, countyTeams:{}, hazmatDB:{}, evLinks:{} };

  function initRealtime(){
    watch('departments', 'departments');
    watch('ems', 'ems');
    watch('coordinators', 'coordinators');
    watch('countyTeams', 'countyTeams');
    watch('hazmatDB', 'hazmatDB');
    watch('evLinks','evLinks');
  }

  function watch(path, key){
    const r = ref(db, path);
    onValue(r, snap=>{
      state[key] = snap.val() || {};
      render(key);
      updateCounts();
    });
  }

  function render(key){
    if(key==='departments') renderDepartments();
    if(key==='ems') renderEms();
    if(key==='coordinators') renderCoordinators();
    if(key==='countyTeams') renderTeams();
  }

  // ---------- Renderers (UI) ----------
  function renderDepartments(){
    const container = document.getElementById('departmentsContainer');
    container.innerHTML = '';
    const items = state.departments || {};
    Object.entries(items).forEach(([id, it])=>{
      const el = document.createElement('div'); el.className='listItem';
      const left = document.createElement('div'); left.className='listLeft';
      const title = document.createElement('div'); title.className='listTitle'; title.textContent = it.name || 'Unnamed';
      const meta = document.createElement('div'); meta.className='listMeta muted'; meta.textContent = `${it.battalion? 'Battalion: '+it.battalion : ''} ${it.address? ' ‚Ä¢ '+it.address : ''}`;
      left.appendChild(title); left.appendChild(meta);
      if(it.apparatus){
        const ul = document.createElement('ul'); ul.className='apparatusList';
        it.apparatus.split('|').map(s=>s.trim()).filter(Boolean).forEach(a=>{
          const li = document.createElement('li'); li.textContent = a; ul.appendChild(li);
        });
        left.appendChild(ul);
      }
      const actions = document.createElement('div'); actions.className='actions';
      if(CURRENT_USER.role === 'ADMIN' || (CURRENT_USER.role === 'DEPTADMIN' && CURRENT_USER.dept === it.name)){
        const edit = document.createElement('button'); edit.className='pill small'; edit.textContent='Edit'; edit.onclick = ()=> editItem('departments', id, it);
        const del = document.createElement('button'); del.className='ghost small'; del.textContent='Delete'; del.onclick = ()=> deleteItem('departments', id);
        actions.appendChild(edit); actions.appendChild(del);
      } else {
        const view = document.createElement('button'); view.className='ghost small'; view.textContent='View'; view.onclick = ()=> showDetails('departments', id);
        actions.appendChild(view);
      }
      el.appendChild(left); el.appendChild(actions);
      container.appendChild(el);
    });
  }

  function renderEms(){
    const container = document.getElementById('emsContainer'); container.innerHTML='';
    const items = state.ems || {};
    Object.entries(items).forEach(([id,it])=>{
      const el = document.createElement('div'); el.className='listItem';
      const left = document.createElement('div'); left.className='listLeft';
      const title = document.createElement('div'); title.className='listTitle'; title.textContent = it.name || 'Unnamed EMS';
      const meta = document.createElement('div'); meta.className='listMeta muted'; meta.textContent = it.address || '';
      left.appendChild(title); left.appendChild(meta);
      if(it.apparatus){
        const ul = document.createElement('ul'); ul.className='apparatusList';
        it.apparatus.split('|').map(s=>s.trim()).filter(Boolean).forEach(a=>{const li=document.createElement('li'); li.textContent=a; ul.appendChild(li);});
        left.appendChild(ul);
      }
      const actions = document.createElement('div'); actions.className='actions';
      if(CURRENT_USER.role === 'ADMIN' || CURRENT_USER.role === 'DEPTADMIN'){
        const edit = document.createElement('button'); edit.className='pill small'; edit.textContent='Edit'; edit.onclick = ()=> editItem('ems', id, it);
        const del = document.createElement('button'); del.className='ghost small'; del.textContent='Delete'; del.onclick = ()=> deleteItem('ems', id);
        actions.appendChild(edit); actions.appendChild(del);
      } else {
        const view = document.createElement('button'); view.className='ghost small'; view.textContent='View'; actions.appendChild(view);
      }
      el.appendChild(left); el.appendChild(actions); container.appendChild(el);
    });
  }

  function renderCoordinators(){
    const container = document.getElementById('coordContainer'); container.innerHTML='';
    const items = state.coordinators || {};
    Object.entries(items).forEach(([id,it])=>{
      const el = document.createElement('div'); el.className='listItem';
      const left = document.createElement('div'); left.className='listLeft';
      const title = document.createElement('div'); title.className='listTitle'; title.textContent = it.name || 'No name';
      const meta = document.createElement('div'); meta.className='listMeta muted'; meta.textContent = it.callsign || it.department || '';
      left.appendChild(title); left.appendChild(meta);
      const actions = document.createElement('div'); actions.className='actions';
      if(CURRENT_USER.role === 'ADMIN'){
        const edit = document.createElement('button'); edit.className='pill small'; edit.textContent='Edit'; edit.onclick = ()=> editItem('coordinators', id, it);
        const del = document.createElement('button'); del.className='ghost small'; del.textContent='Delete'; del.onclick = ()=> deleteItem('coordinators', id);
        actions.appendChild(edit); actions.appendChild(del);
      }
      el.appendChild(left); el.appendChild(actions); container.appendChild(el);
    });
  }

  function renderTeams(){
    const container = document.getElementById('teamsContainer'); container.innerHTML='';
    const items = state.countyTeams || {};
    Object.entries(items).forEach(([id,it])=>{
      const el = document.createElement('div'); el.className='listItem';
      const left = document.createElement('div'); left.className='listLeft';
      const title = document.createElement('div'); title.className='listTitle'; title.textContent = it.name || 'Team';
      const meta = document.createElement('div'); meta.className='listMeta muted'; meta.textContent = it.lead || '';
      left.appendChild(title); left.appendChild(meta);
      const actions = document.createElement('div'); actions.className='actions';
      if(CURRENT_USER.role === 'ADMIN' || CURRENT_USER.role === 'DEPTADMIN'){
        const edit = document.createElement('button'); edit.className='pill small'; edit.textContent='Edit'; edit.onclick = ()=> editItem('countyTeams', id, it);
        const del = document.createElement('button'); del.className='ghost small'; del.textContent='Delete'; del.onclick = ()=> deleteItem('countyTeams', id);
        actions.appendChild(edit); actions.appendChild(del);
      }
      el.appendChild(left); el.appendChild(actions); container.appendChild(el);
    });
  }

  // ---------- CRUD interactions ----------
  function deleteItem(path, key){
    if(!confirm('Delete item?')) return;
    remove(ref(db, `${path}/${key}`)).catch(err=>alert('Delete failed: '+err.message));
  }

  async function editItem(path, key, item){
    // Fetch latest
    const snap = await get(ref(db, `${path}/${key}`));
    const data = snap.val() || item || {};
    const name = prompt('Name / Title', data.name || data.title || '');
    if(!name) return;
    const apparatusPrompt = ('apparatus' in data) ? prompt('Apparatus (use | to separate)', data.apparatus || '') : ''; 
    const update = {...data};
    if('apparatus' in data) { update.name = name; update.apparatus = apparatusPrompt; }
    else { if(data.title) update.title = name; else update.name = name; }
    set(ref(db, `${path}/${key}`), update);
  }

  // ---------- Add buttons ----------
  document.getElementById('addDeptBtn').addEventListener('click', ()=>{
    if(!canModify()) return alert('Permission denied');
    const name = prompt('Department name'); if(!name) return;
    const battalion = prompt('Battalion (optional)') || '';
    const address = prompt('Address (optional)') || '';
    const apparatus = prompt('Apparatus (use | to separate)') || '';
    push(ref(db,'departments')).then(n=> set(ref(db, `departments/${n.key}`), { name, battalion, address, apparatus }));
  });

  document.getElementById('addEmsBtn').addEventListener('click', ()=>{
    if(!canModify()) return alert('Permission denied');
    const name = prompt('EMS name'); if(!name) return;
    const address = prompt('Address (optional)')||'';
    const apparatus = prompt('Apparatus (use |)')||'';
    push(ref(db,'ems')).then(n=> set(ref(db, `ems/${n.key}`), { name, address, apparatus }));
  });

  document.getElementById('addCoordBtn').addEventListener('click', ()=>{
    if(!canModify()) return alert('Permission denied');
    const name = prompt('Coordinator name'); if(!name) return;
    const callsign = prompt('Callsign (optional)')||'';
    push(ref(db,'coordinators')).then(n=> set(ref(db, `coordinators/${n.key}`), { name, callsign }));
  });

  document.getElementById('addTeamBtn').addEventListener('click', ()=>{
    if(!canModify()) return alert('Permission denied');
    const name = prompt('Team name'); if(!name) return;
    const lead = prompt('Team lead (optional)')||'';
    push(ref(db,'countyTeams')).then(n=> set(ref(db, `countyTeams/${n.key}`), { name, lead }));
  });

  // admin hazmat add
  document.getElementById('adminAddHaz').addEventListener('click', ()=>{
    if(!CURRENT_USER || CURRENT_USER.role !== 'ADMIN') return alert('Admin only');
    const un = document.getElementById('adminHazUn').value.trim();
    const name = document.getElementById('adminHazName').value.trim();
    if(!un || !name) return alert('Enter UN and name');
    set(ref(db, `hazmatDB/${un}`), { un, name });
    document.getElementById('adminHazUn').value=''; document.getElementById('adminHazName').value='';
    alert('HazMat entry saved');
  });

  // admin ev link add
  document.getElementById('adminAddEv').addEventListener('click', ()=>{
    if(!CURRENT_USER || CURRENT_USER.role !== 'ADMIN') return alert('Admin only');
    const make = document.getElementById('adminEvMake').value.trim();
    const url = document.getElementById('adminEvUrl').value.trim();
    if(!make || !url) return alert('Enter make and URL');
    const key = make.toLowerCase().replace(/\s+/g,'_');
    set(ref(db, `evLinks/${key}`), { make, url });
    document.getElementById('adminEvMake').value=''; document.getElementById('adminEvUrl').value='';
    alert('EV link added');
  });

  // HazMat search
  document.getElementById('hazSearchBtn').addEventListener('click', async ()=>{
    const q = document.getElementById('hazInput').value.trim();
    if(!q) return alert('Enter UN/NA number');
    const snap = await get(ref(db, `hazmatDB/${q}`));
    const doc = snap.val();
    if(doc){ document.getElementById('hazResults').innerHTML = `<div style="font-weight:800">${doc.name} (UN ${q})</div><div class="muted" style="margin-top:6px">${doc.notes||''}</div>`; }
    else { document.getElementById('hazResults').innerHTML = `<div class="muted">No entry for UN ${q}. Admin can add entries on Admin page.</div>`; }
  });

  document.getElementById('hazExample').addEventListener('click', ()=>{ document.getElementById('hazInput').value='1203'; document.getElementById('hazSearchBtn').click(); });

  // EV search
  document.getElementById('evSearchBtn').addEventListener('click', async ()=>{
    const make = (document.getElementById('evMake').value || '').trim().toLowerCase();
    const model = (document.getElementById('evModel').value || '').trim();
    const year = (document.getElementById('evYear').value || '').trim();
    if(!make) return alert('Enter Make (e.g. Tesla)');
    const key = make.replace(/\s+/g,'_');
    const snap = await get(ref(db, `evLinks/${key}`));
    const doc = snap.val();
    if(doc && doc.url){ document.getElementById('evResults').innerHTML = `<div style="font-weight:800">${make.toUpperCase()} ${model} ${year}</div><div style="margin-top:8px"><a href="${doc.url}" target="_blank" style="color:var(--accent)">${doc.url}</a></div>`; }
    else { document.getElementById('evResults').innerHTML = `<div class="muted">Manufacturer guide not found. Add via Admin.</div>`; }
  });

  // Quick actions
  document.getElementById('quickAddDept').addEventListener('click', ()=> document.getElementById('addDeptBtn').click());
  document.getElementById('quickAddEms').addEventListener('click', ()=> document.getElementById('addEmsBtn').click());
  document.getElementById('quickHaz').addEventListener('click', ()=> navigate('hazmat'));

  // ---------- Weather alerts (NWS) ----------
  async function fetchWeatherAlerts(){
    try{
      const r = await fetch('https://api.weather.gov/alerts/active?area=OSW'); // Oswego County code
      const data = await r.json();
      if(data && data.features && data.features.length){
        const items = data.features.map(f=> f.properties.event);
        document.getElementById('alertsText').textContent = items.join(' ‚Ä¢ ');
        document.getElementById('weatherFull').textContent = data.features.map(f=> `${f.properties.event} ‚Äî ${f.properties.areaDesc}`).join('\n\n');
      } else {
        document.getElementById('alertsText').textContent = 'No active weather alerts';
        document.getElementById('weatherFull').textContent = 'No active alerts';
      }
    } catch(err){
      console.error(err);
      document.getElementById('alertsText').textContent = 'Weather alerts unavailable';
    }
  }
  document.getElementById('btnRefreshWeather').addEventListener('click', fetchWeatherAlerts);

  // ---------- Utilities ----------
  function canModify(){ return CURRENT_USER && (CURRENT_USER.role === 'ADMIN' || CURRENT_USER.role === 'DEPTADMIN'); }

  function updateCounts(){
    document.getElementById('countDept').textContent = Object.keys(state.departments || {}).length;
    document.getElementById('countEms').textContent = Object.keys(state.ems || {}).length;
    document.getElementById('countTeams').textContent = Object.keys(state.countyTeams || {}).length;
    document.getElementById('countCoords').textContent = Object.keys(state.coordinators || {}).length;
    document.getElementById('statDept').textContent = Object.keys(state.departments || {}).length;
    document.getElementById('statEms').textContent = Object.keys(state.ems || {}).length;
    document.getElementById('statTeams').textContent = Object.keys(state.countyTeams || {}).length;
    document.getElementById('statCoords').textContent = Object.keys(state.coordinators || {}).length;
  }

  function showDetails(path, key){
    // For future: show a subpage/modal for department details.
    alert('Details view coming soon (ID: '+key+')');
  }

  // initial: nothing to do until login
</script>
</body>
</html>
