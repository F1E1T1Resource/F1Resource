<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>F1 Resource — Firestore</title>
<style>
:root{
  --bg:#f5f8fc; --card:#fff; --primary:#0b5fff; --dark:#062044; --muted:#6b7280;
  --success:#16a34a; --danger:#ef4444;
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,Arial;background:var(--bg);color:var(--dark);-webkit-font-smoothing:antialiased}
header{display:flex;align-items:center;gap:12px;padding:12px 16px;background:linear-gradient(180deg,#062044 0%, #0b2a56 100%);color:#fff}
header h1{font-size:18px;margin:0}
#appWrap{display:flex;height:calc(100vh - 56px);overflow:hidden}
nav#sidebar{width:260px;background:#062b57;color:#fff;padding:12px 14px;overflow:auto;transition:transform .24s ease}
nav#sidebar.hidden{transform:translateX(-120%)}
nav#sidebar h2{margin:0 0 10px;font-size:18px}
nav#sidebar .muted{color:#9db2d3;font-size:13px;margin-bottom:12px}
nav#sidebar button{display:block;width:100%;text-align:left;padding:10px;border-radius:8px;border:none;background:transparent;color:#fff;margin:6px 0;cursor:pointer}
nav#sidebar button:hover{background:rgba(255,255,255,0.03)}
main#content{flex:1;overflow:auto;padding:18px}
.card{background:var(--card);border-radius:12px;padding:16px;box-shadow:0 8px 30px rgba(2,6,23,0.06);margin-bottom:18px}
.muted{color:var(--muted);font-size:13px}
input,select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #e6edf3;margin:8px 0}
button.primary{background:var(--primary);color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer}
button.ghost{background:transparent;border:1px solid #dbeafe;color:var(--primary);padding:8px 12px;border-radius:8px}
.row{display:flex;gap:12px;align-items:center}
.listItem{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:10px;background:#fff;border:1px solid #eef6ff;margin-top:10px;gap:8px;flex-wrap:wrap}
.small{padding:6px 10px;font-size:13px}
.status-in{color:var(--success);font-weight:600}
.status-out{color:var(--danger);font-weight:600}
.page{display:none}
@media (max-width:900px){
  nav#sidebar{position:fixed;left:0;top:56px;height:calc(100vh - 56px);z-index:60;transform:translateY(-150%);width:80%}
  nav#sidebar.show{transform:translateY(0)}
  nav#sidebar.hidden{transform:translateY(-150%)}
  main#content{padding:12px}
}
#loginModal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(2,6,23,0.45);z-index:80}
#loginCard{width:360px;background:var(--card);padding:20px;border-radius:12px;box-shadow:0 10px 40px rgba(2,6,23,0.25)}
.tiny{font-size:12px;color:var(--muted)}
pre{white-space:pre-wrap;word-break:break-word;font-family:monospace}
</style>
</head>
<body>
<header>
  <button id="menuBtn" aria-label="menu" style="background:transparent;border:none;color:#fff;font-size:20px;cursor:pointer">☰</button>
  <h1>F1 Resource</h1>
  <div style="margin-left:auto" id="currentUserView" class="tiny">Not signed in</div>
</header>

<div id="appWrap">
  <nav id="sidebar" class="hidden" aria-label="Main nav">
    <h2>F1 Resource</h2>
    <div class="muted">Oswego County</div>

    <button data-page="home">Home</button>
    <button data-page="fireAgencies">Fire Agencies</button>
    <button data-page="emsAgencies">EMS Agencies</button>
    <button data-page="countyResources">County Resources</button>
    <button data-page="countyCoordinators">County Coordinators</button>
    <button data-page="hazmat">HazMat Search</button>
    <button data-page="evSafety">EV Safety</button>
    <button data-page="fireRisk">Fire Risk</button>
    <button data-page="drivingSafety">Driving Safety</button>

    <div style="margin-top:12px;border-top:1px solid rgba(255,255,255,0.06);padding-top:12px">
      <div class="muted" style="margin-bottom:8px">Admin</div>
      <button id="manageUsersBtn" style="display:none" data-page="manageUsers">Manage Users</button>
      <button id="signOutBtn" style="margin-top:8px">Sign Out</button>
    </div>

    <div style="margin-top:18px" class="muted tiny">Version 2.0 — Firestore</div>
  </nav>

  <main id="content">
    <section id="home" class="card page" style="display:block">
      <h2>WELCOME</h2>
      <p class="muted">This is <strong>F1 Resource</strong>. Use the menu to manage departments, EMS, resources and coordinators.</p>
    </section>

    <section id="fireAgencies" class="card page" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">Fire Agencies</h3>
        <div><button id="addDeptBtn" class="small primary">Add Department</button></div>
      </div>
      <div id="fireList" style="margin-top:12px"></div>
    </section>

    <section id="emsAgencies" class="card page" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">EMS (enter the department and add units)</h3>
        <div class="muted tiny">EMS units live under departments</div>
      </div>
      <div id="emsList" style="margin-top:12px"></div>
    </section>

    <section id="countyResources" class="card page" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">County Resources</h3>
        <div class="muted tiny">Resources belong to departments</div>
      </div>
      <div id="resourceList" style="margin-top:12px"></div>
    </section>

    <section id="countyCoordinators" class="card page" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">County Coordinators</h3>
      </div>
      <div id="coordinatorList" style="margin-top:12px"></div>
    </section>

    <section id="hazmat" class="card page" style="display:none">
      <h3 style="margin:0">HazMat Search</h3>
      <div style="margin-top:10px" class="row">
        <input id="unInput" placeholder="UN/NA number (e.g. 1203)"/>
        <button id="searchUnBtn" class="small primary">Search</button>
      </div>
      <pre id="unResult" style="margin-top:12px;background:#f3fbff;padding:12px;border-radius:8px;min-height:80px"></pre>
      <div style="margin-top:8px"><button id="editHazmatBtn" class="small ghost">Admin: Add/Edit Entry</button></div>
    </section>

    <section id="evSafety" class="card page" style="display:none">
      <h3 style="margin:0">Electric Vehicle Safety</h3>
      <div style="margin-top:10px" class="row">
        <input id="evQuery" placeholder="VIN / Plate / Year,Make,Model"/>
        <button id="searchEvBtn" class="small primary">Search</button>
      </div>
      <pre id="evResult" style="margin-top:12px;background:#f3fbff;padding:12px;border-radius:8px;min-height:80px"></pre>
      <div style="margin-top:8px"><button id="editEvBtn" class="small ghost">Admin: Add/Edit EV Entry</button></div>
    </section>

    <section id="fireRisk" class="card page" style="display:none">
      <h3>Fire Risk</h3>
      <p class="muted">Placeholder — add your content here.</p>
    </section>

    <section id="drivingSafety" class="card page" style="display:none">
      <h3>Driving Safety</h3>
      <p class="muted">Placeholder — add your content here.</p>
    </section>

    <section id="manageUsers" class="card page" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">Manage Users</h3>
        <div><button id="addUserBtn" class="small primary">Add User</button></div>
      </div>
      <div id="userList" style="margin-top:12px"></div>
    </section>

    <section id="weatherCard" class="card" style="display:block">
      <h3 style="margin:0">Weather (quick lookup)</h3>
      <div style="margin-top:10px" class="row">
        <input id="weatherInput" placeholder="City or address (e.g. Oswego, NY)"/>
        <button id="weatherBtn" class="small primary">Get Weather</button>
      </div>
      <pre id="weatherResult" style="margin-top:12px;background:#f3fbff;padding:12px;border-radius:8px;min-height:60px"></pre>
    </section>
  </main>
</div>

<!-- Login modal -->
<div id="loginModal" style="display:flex;position:fixed;inset:0;align-items:center;justify-content:center;background:rgba(2,6,23,0.45);z-index:80">
  <div id="loginCard" style="width:360px;background:var(--card);padding:20px;border-radius:12px;box-shadow:0 10px 40px rgba(2,6,23,0.25)">
    <h2>F1 Resource Login</h2>
    <div class="muted">Sign in with your account (stored in Firestore). First-run fallback: <strong>ADMIN / ADMIN</strong></div>
    <div style="margin-top:10px">
      <input id="loginUser" placeholder="Username" autocomplete="username" />
      <input id="loginPass" placeholder="Password" type="password" autocomplete="current-password" />
    </div>
    <div style="margin-top:14px;display:flex;gap:10px;align-items:center">
      <button id="loginBtn" class="primary">Sign In</button>
      <button id="demoBtn" class="ghost">Demo (ADMIN/ADMIN)</button>
      <div id="loginMsg" class="tiny" style="margin-left:auto"></div>
    </div>
  </div>
</div>

<script type="module">
/* ================================
  F1 Resource — Firestore Full App
  - Firestore used for all data & login
  - Collections: users, departments
  - Departments: info, apparatus, resources, coordinators, members, hazmat, evDB
  - Roles: ADMIN, DEPT_ADMIN, DEPT_USER
  - NOTE: uses modular Firebase v9+ Firestore SDK
=================================*/
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import {
  getFirestore, collection, doc, setDoc, getDoc, onSnapshot, getDocs, deleteDoc
} from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

/* ---------- Your Firebase config (provided earlier) ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyBi0Xyljx7zzXTmyyRMAru11hZ2s5S3tsw",
  authDomain: "f1resource-8fedc.firebaseapp.com",
  projectId: "f1resource-8fedc",
  storageBucket: "f1resource-8fedc.firebasestorage.app",
  messagingSenderId: "182745701982",
  appId: "1:182745701982:web:9f4f3836b41b450987decf"
};
/* -------------------------------------------------------------- */

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* DOM helper */
const $ = id => document.getElementById(id);
function genId(prefix='id'){ return prefix+'_'+Date.now().toString(36)+'_'+Math.random().toString(36).slice(2,6); }

/* runtime mirrors */
let users = {};         // users keyed by username (doc id)
let departments = {};   // departments keyed by doc id
let currentUser = null;

/* ---------- Snapshot listeners for realtime updates ---------- */
/* users collection */
onSnapshot(collection(db, 'users'), snapshot => {
  users = {};
  snapshot.forEach(docSnap => { users[docSnap.id] = docSnap.data(); });
  renderUsers();
  // ensure fallback admin exists if none
  if(Object.keys(users).length === 0){
    (async ()=>{
      const admin = { password:'ADMIN', role:'ADMIN', department: null };
      await setDoc(doc(db, 'users', 'ADMIN'), admin);
    })();
  }
});

/* departments collection */
onSnapshot(collection(db, 'departments'), snapshot => {
  departments = {};
  snapshot.forEach(docSnap => { departments[docSnap.id] = docSnap.data(); });
  renderDepartments();
});

/* ---------- Auth/Login (Firestore-backed) ---------- */
async function loginAction(){
  const u = $('loginUser').value.trim();
  const p = $('loginPass').value.trim();
  $('loginMsg').textContent = '';
  if(!u || !p){ $('loginMsg').textContent = 'Enter username/password'; return; }

  const userDoc = await getDoc(doc(db, 'users', u));
  if(!userDoc.exists()){
    $('loginMsg').textContent = 'Invalid username';
    return;
  }
  const data = userDoc.data();
  if(data.password !== p){ $('loginMsg').textContent = 'Invalid password'; return; }
  currentUser = { username: u, role: data.role || 'DEPT_USER', department: data.department || null };
  afterLogin();
}

function afterLogin(){
  $('loginModal').style.display = 'none';
  $('sidebar').classList.remove('hidden');
  $('currentUserView').textContent = `${currentUser.username} • ${currentUser.role}`;
  $('manageUsersBtn').style.display = (currentUser.role === 'ADMIN' || currentUser.role === 'DEPT_ADMIN') ? 'block' : 'none';
  showPage('home');
}

/* ---------- UI helpers ---------- */
function showPage(id){
  document.querySelectorAll('.page').forEach(p => p.style.display = 'none');
  const el = $(id); if(el) el.style.display = 'block';
  if(window.innerWidth <= 900) $('sidebar').classList.remove('show');
}

/* ---------- Renderers ---------- */
function renderUsers(){
  const target = $('userList'); if(!target) return;
  target.innerHTML = '';
  Object.keys(users).forEach(username => {
    const u = users[username];
    const div = document.createElement('div'); div.className = 'listItem';
    div.innerHTML = `<div style="min-width:0"><strong>${username}</strong><div class="muted">${u.role}${u.department?(' • dept:'+u.department):''}</div></div>
      <div style="display:flex;gap:8px">
        <button class="small" data-action="editUser" data-user="${username}">Edit</button>
        <button class="small" data-action="deleteUser" data-user="${username}">Delete</button>
      </div>`;
    target.appendChild(div);
  });
}

function renderDepartments(){
  const listEl = $('fireList'); if(!listEl) return; listEl.innerHTML = '';
  Object.keys(departments).forEach(id => {
    const d = departments[id];
    const name = d.info?.name || '(Unnamed)';
    const battalion = d.info?.battalion || '-';
    const address = d.info?.address || '-';
    const appCount = d.apparatus ? Object.keys(d.apparatus).length : 0;
    const memberCount = d.members ? Object.keys(d.members).length : 0;
    const div = document.createElement('div'); div.className = 'listItem';
    div.innerHTML = `<div style="min-width:0"><strong>${name}</strong><div class="muted">Battalion: ${battalion} • Address: ${address} • Apparatus: ${appCount} • Members: ${memberCount}</div></div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="small" data-action="openDept" data-id="${id}">Open</button>
        <button class="small" data-action="editDept" data-id="${id}">Edit</button>
        <button class="small" data-action="deleteDept" data-id="${id}">Delete</button>
      </div>`;
    listEl.appendChild(div);
  });
}

/* ---------- CRUD: Users ---------- */
async function addUser(){
  if(!(currentUser && (currentUser.role === 'ADMIN' || currentUser.role === 'DEPT_ADMIN'))) return alert('Admin privileges required');
  const username = prompt('Username (no spaces)'); if(!username) return;
  const password = prompt('Password','changeme') || 'changeme';
  let role = prompt('Role (ADMIN / DEPT_ADMIN / DEPT_USER)','DEPT_USER') || 'DEPT_USER'; role = role.toUpperCase();
  let department = null;
  if(role === 'DEPT_ADMIN' || role === 'DEPT_USER'){
    if(currentUser.role === 'DEPT_ADMIN') department = currentUser.department;
    else department = prompt('Department ID to assign this user to (deptId):','') || null;
  }
  const payload = { password, role, department };
  await setDoc(doc(db, 'users', username), payload);
}

async function editUser(username){
  if(!(currentUser && (currentUser.role === 'ADMIN' || currentUser.role === 'DEPT_ADMIN'))) return alert('Admin privileges required');
  if(currentUser.role === 'DEPT_ADMIN' && users[username]?.department !== currentUser.department && username !== currentUser.username) return alert('You can only edit users in your department');
  const u = users[username]; if(!u) return;
  const password = prompt('Password', u.password) || u.password;
  let role = prompt('Role (ADMIN / DEPT_ADMIN / DEPT_USER)', u.role) || u.role; role = role.toUpperCase();
  let department = u.department || null;
  if(role === 'DEPT_ADMIN' || role === 'DEPT_USER'){
    if(currentUser.role === 'DEPT_ADMIN') department = currentUser.department;
    else department = prompt('Department ID', u.department || '') || null;
  } else department = null;
  const payload = { password, role, department };
  await setDoc(doc(db, 'users', username), payload);
}

async function deleteUser(username){
  if(!(currentUser && (currentUser.role === 'ADMIN' || currentUser.role === 'DEPT_ADMIN'))) return alert('Admin privileges required');
  if(currentUser.role === 'DEPT_ADMIN' && users[username]?.department !== currentUser.department) return alert('You can only delete users in your department');
  if(!confirm('Delete user '+username+'?')) return;
  await deleteDoc(doc(db, 'users', username));
}

/* ---------- CRUD: Departments (Option B) ---------- */
async function addDepartment(){
  if(!(currentUser && currentUser.role === 'ADMIN')) return alert('Admin only');
  const name = prompt('Department name'); if(!name) return;
  const battalion = prompt('Battalion (optional)','')||'';
  const address = prompt('Address (optional)','')||'';
  const deptId = genId('dept');
  const docObj = {
    info: { name, battalion, address, city:'', state:'', zip:'', phone:'' },
    apparatus: {}, resources: {}, coordinators: {}, members: {}, hazmat: {}, evDB: {}
  };
  await setDoc(doc(db, 'departments', deptId), docObj);
}

async function editDepartment(id){
  const d = departments[id]; if(!d) return;
  if(!(currentUser && (currentUser.role === 'ADMIN' || (currentUser.role === 'DEPT_ADMIN' && currentUser.department === id)))) return alert('No permission');
  const name = prompt('Department name', d.info.name) || d.info.name;
  const battalion = prompt('Battalion', d.info.battalion || '') || d.info.battalion;
  const address = prompt('Address', d.info.address || '') || d.info.address;
  d.info = { ...d.info, name, battalion, address };
  await setDoc(doc(db, 'departments', id), d);
}

async function deleteDepartment(id){
  if(!(currentUser && currentUser.role === 'ADMIN')) return alert('Admin only');
  if(!confirm('Delete department and all nested data?')) return;
  await deleteDoc(doc(db, 'departments', id));
}

/* ---------- Department panel: manage apparatus, members, resources, coordinators ---------- */
function openDepartment(id){
  const dept = departments[id]; if(!dept) return alert('Department not found');
  const main = $('content');
  const old = $('deptPanel'); if(old) old.remove();
  const card = document.createElement('div'); card.id='deptPanel'; card.className='card';
  card.innerHTML = `<h3 style="margin:0 0 8px">${dept.info.name}</h3>
    <div class="muted">Battalion: ${dept.info.battalion||'-'} • Address: ${dept.info.address||'-'}</div>
    <div style="margin-top:12px"><strong>Members</strong><div id="deptMembers" class="muted" style="margin-top:6px">${Object.keys(dept.members||{}).join('; ')||'(no members)'}</div><div style="margin-top:8px"><button id="addMemberBtn" class="small primary">Add Member (assign username)</button></div></div>
    <div style="margin-top:12px"><strong>Apparatus</strong><div id="apparatusList" style="margin-top:8px"></div><div style="margin-top:8px"><button id="addAppBtn" class="small primary">Add Apparatus</button></div></div>
    <div style="margin-top:12px"><strong>Resources</strong><div id="resourcesList" style="margin-top:8px"></div><div style="margin-top:8px"><button id="addResBtn" class="small primary">Add Resource</button></div></div>
    <div style="margin-top:12px"><strong>Coordinators</strong><div id="coordList" style="margin-top:8px"></div><div style="margin-top:8px"><button id="addCoordBtn" class="small primary">Add Coordinator</button></div></div>
    <div style="margin-top:12px"><button id="editDeptBtn" class="small">Edit Dept</button> <button id="closeDeptBtn" class="small ghost">Close</button></div>`;
  main.prepend(card);

  function renderApparatus(){
    const container = card.querySelector('#apparatusList'); container.innerHTML = '';
    const apps = dept.apparatus || {};
    Object.keys(apps).forEach(appId => {
      const a = apps[appId];
      const row = document.createElement('div'); row.className='listItem';
      row.innerHTML = `<div style="min-width:0"><strong>${a.name||'(unnamed)'}</strong><div class="muted">Type: ${a.type||''} • Status: <span class="${a.status==='OOS'?'status-out':'status-in'}">${a.status||'IN SERVICE'}</span></div></div>
        <div style="display:flex;gap:8px"><button class="small" data-act="toggleApp" data-id="${appId}">${a.status==='OOS'?'Mark IN':'Mark OOS'}</button><button class="small" data-act="editApp" data-id="${appId}">Edit</button><button class="small" data-act="delApp" data-id="${appId}">Delete</button></div>`;
      container.appendChild(row);
    });
  }
  function renderResources(){
    const container = card.querySelector('#resourcesList'); container.innerHTML = '';
    const res = dept.resources || {};
    Object.keys(res).forEach(rid=>{
      const r = res[rid];
      const row = document.createElement('div'); row.className='listItem';
      row.innerHTML = `<div style="min-width:0"><strong>${r.name||'(unnamed)'}</strong><div class="muted">${r.description||''}</div></div>
        <div style="display:flex;gap:8px"><button class="small" data-act="editRes" data-id="${rid}">Edit</button><button class="small" data-act="delRes" data-id="${rid}">Delete</button></div>`;
      container.appendChild(row);
    });
  }
  function renderCoords(){
    const container = card.querySelector('#coordList'); container.innerHTML = '';
    const coords = dept.coordinators || {};
    Object.keys(coords).forEach(cid=>{
      const c = coords[cid];
      const row = document.createElement('div'); row.className='listItem';
      row.innerHTML = `<div style="min-width:0"><strong>${c.name||'(unnamed)'}</strong><div class="muted">${c.title||''} • ${c.phone||''}</div></div>
        <div style="display:flex;gap:8px"><button class="small" data-act="editCoord" data-id="${cid}">Edit</button><button class="small" data-act="delCoord" data-id="${cid}">Delete</button></div>`;
      container.appendChild(row);
    });
  }
  renderApparatus(); renderResources(); renderCoords();

  card.querySelector('#addMemberBtn').onclick = async ()=>{
    if(!(currentUser && (currentUser.role === 'ADMIN' || (currentUser.role === 'DEPT_ADMIN' && currentUser.department === id)))) return alert('No permission');
    const username = prompt('Enter an existing username to add to this department:'); if(!username) return;
    if(!users[username]) return alert('User not found');
    dept.members = dept.members || {}; dept.members[username] = true;
    // assign user's department
    users[username].department = id;
    await setDoc(doc(db, 'departments', id), dept);
    await setDoc(doc(db, 'users', username), users[username]);
    card.querySelector('#deptMembers').textContent = Object.keys(dept.members||{}).join('; ');
  };

  card.querySelector('#addAppBtn').onclick = async ()=>{
    if(!(currentUser && (currentUser.role === 'ADMIN' || (currentUser.role === 'DEPT_ADMIN' && currentUser.department === id)))) return alert('No permission');
    const name = prompt('Apparatus name (Engine 1)'); if(!name) return;
    const type = prompt('Type (Engine/Truck/Rescue/Tanker/Other)','Engine')||'Engine';
    const status = prompt('Status (IN SERVICE / OOS)','IN SERVICE')||'IN SERVICE';
    const appId = genId('app');
    dept.apparatus = dept.apparatus || {}; dept.apparatus[appId] = { id: appId, name, type, status };
    await setDoc(doc(db, 'departments', id), dept);
    renderApparatus(); renderDepartments();
  };

  card.querySelector('#addResBtn').onclick = async ()=>{
    if(!(currentUser && (currentUser.role === 'ADMIN' || (currentUser.role === 'DEPT_ADMIN' && currentUser.department === id)))) return alert('No permission');
    const name = prompt('Resource name'); if(!name) return;
    const desc = prompt('Description','')||'';
    const rid = genId('res');
    dept.resources = dept.resources || {}; dept.resources[rid] = { id: rid, name, description: desc };
    await setDoc(doc(db, 'departments', id), dept);
    renderResources(); renderDepartments();
  };

  card.querySelector('#addCoordBtn').onclick = async ()=>{
    if(!(currentUser && (currentUser.role === 'ADMIN' || (currentUser.role === 'DEPT_ADMIN' && currentUser.department === id)))) return alert('No permission');
    const name = prompt('Coordinator name'); if(!name) return;
    const title = prompt('Title','')||'';
    const phone = prompt('Phone','')||'';
    const cid = genId('coord');
    dept.coordinators = dept.coordinators || {}; dept.coordinators[cid] = { id: cid, name, title, phone };
    await setDoc(doc(db, 'departments', id), dept);
    renderCoords(); renderDepartments();
  };

  card.querySelector('#editDeptBtn').onclick = async ()=>{
    if(!(currentUser && (currentUser.role === 'ADMIN' || (currentUser.role === 'DEPT_ADMIN' && currentUser.department === id)))) return alert('No permission');
    const name = prompt('Department name', dept.info.name) || dept.info.name;
    const battalion = prompt('Battalion', dept.info.battalion||'') || dept.info.battalion;
    const address = prompt('Address', dept.info.address||'') || dept.info.address;
    dept.info = { ...dept.info, name, battalion, address };
    await setDoc(doc(db, 'departments', id), dept);
    renderDepartments(); card.remove();
  };

  card.querySelector('#closeDeptBtn').onclick = ()=> card.remove();

  card.addEventListener('click', async (ev)=>{
    const btn = ev.target.closest('button'); if(!btn) return;
    const act = btn.dataset.act; const itemId = btn.dataset.id;
    if(!act) return;
    if(act === 'toggleApp'){
      if(!(currentUser && (currentUser.role === 'ADMIN' || (currentUser.role === 'DEPT_ADMIN' && currentUser.department === id)))) return alert('No permission');
      const app = dept.apparatus[itemId]; if(!app) return;
      app.status = app.status === 'OOS' ? 'IN SERVICE' : 'OOS';
      await setDoc(doc(db, 'departments', id), dept);
      renderApparatus(); renderDepartments();
    } else if(act === 'editApp'){
      if(!(currentUser && (currentUser.role === 'ADMIN' || (currentUser.role === 'DEPT_ADMIN' && currentUser.department === id)))) return alert('No permission');
      const app = dept.apparatus[itemId]; if(!app) return;
      app.name = prompt('Name', app.name) || app.name;
      app.type = prompt('Type', app.type) || app.type;
      app.status = prompt('Status', app.status) || app.status;
      await setDoc(doc(db, 'departments', id), dept);
      renderApparatus(); renderDepartments();
    } else if(act === 'delApp'){
      if(!(currentUser && (currentUser.role === 'ADMIN' || (currentUser.role === 'DEPT_ADMIN' && currentUser.department === id)))) return alert('No permission');
      if(!confirm('Delete apparatus?')) return;
      delete dept.apparatus[itemId];
      await setDoc(doc(db, 'departments', id), dept);
      renderApparatus(); renderDepartments();
    } else if(act === 'editRes'){
      if(!(currentUser && (currentUser.role === 'ADMIN' || (currentUser.role === 'DEPT_ADMIN' && currentUser.department === id)))) return alert('No permission');
      const r = dept.resources[itemId]; if(!r) return;
      r.name = prompt('Name', r.name) || r.name;
      r.description = prompt('Description', r.description||'') || r.description;
      await setDoc(doc(db, 'departments', id), dept);
      renderResources(); renderDepartments();
    } else if(act === 'delRes'){
      if(!(currentUser && (currentUser.role === 'ADMIN' || (currentUser.role === 'DEPT_ADMIN' && currentUser.department === id)))) return alert('No permission');
      if(!confirm('Delete resource?')) return;
      delete dept.resources[itemId];
      await setDoc(doc(db, 'departments', id), dept);
      renderResources(); renderDepartments();
    } else if(act === 'editCoord'){
      if(!(currentUser && (currentUser.role === 'ADMIN' || (currentUser.role === 'DEPT_ADMIN' && currentUser.department === id)))) return alert('No permission');
      const c = dept.coordinators[itemId]; if(!c) return;
      c.name = prompt('Name', c.name) || c.name;
      c.title = prompt('Title', c.title||'') || c.title;
      c.phone = prompt('Phone', c.phone||'') || c.phone;
      await setDoc(doc(db, 'departments', id), dept);
      renderCoords(); renderDepartments();
    } else if(act === 'delCoord'){
      if(!(currentUser && (currentUser.role === 'ADMIN' || (currentUser.role === 'DEPT_ADMIN' && currentUser.department === id)))) return alert('No permission');
      if(!confirm('Delete coordinator?')) return;
      delete dept.coordinators[itemId];
      await setDoc(doc(db, 'departments', id), dept);
      renderCoords(); renderDepartments();
    }
  });
}

/* HazMat search across departments */
function searchHazmat(){
  const q = $('unInput').value.trim();
  if(!q){ $('unResult').textContent = 'Enter UN/NA number'; return; }
  let found = null;
  Object.keys(departments).forEach(did=>{
    const d = departments[did];
    if(d.hazmat && d.hazmat[q]) found = { dept: did, entry: d.hazmat[q] };
  });
  if(found) $('unResult').textContent = `Department: ${found.dept}\n` + JSON.stringify(found.entry, null, 2);
  else $('unResult').textContent = 'Not found';
}

/* Admin HazMat add/edit under department */
async function editHazmat(){
  if(!(currentUser && currentUser.role === 'ADMIN')) return alert('Admin only');
  const deptId = prompt('Department ID to store this HazMat (deptId):'); if(!deptId) return;
  const q = prompt('UN/NA number (e.g. 1203):'); if(!q) return;
  const json = prompt('Paste JSON for this entry (e.g. {"name":"Gasoline","hazard_class":"3"})'); if(!json) return;
  try{
    const obj = JSON.parse(json);
    const dept = departments[deptId] || { info:{name:'(new)'}, apparatus:{}, resources:{}, coordinators:{}, members:{}, hazmat:{}, evDB:{} };
    dept.hazmat = dept.hazmat || {};
    dept.hazmat[q] = obj;
    await setDoc(doc(db, 'departments', deptId), dept);
    alert('Saved HazMat entry');
  }catch(e){ alert('Invalid JSON'); }
}

/* EV search across departments */
function searchEv(){
  const q = $('evQuery').value.trim();
  if(!q){ $('evResult').textContent = 'Enter VIN/Plate or YMM'; return; }
  let found = null;
  Object.keys(departments).forEach(did=>{
    const d = departments[did];
    if(d.evDB && d.evDB[q]) found = { dept: did, entry: d.evDB[q] };
    if(!found && d.evDB && d.evDB[q.toUpperCase()]) found = { dept: did, entry: d.evDB[q.toUpperCase()] };
  });
  if(found) $('evResult').textContent = `Department: ${found.dept}\n` + JSON.stringify(found.entry, null, 2);
  else $('evResult').textContent = 'Not found';
}

/* Admin add/edit EV under department */
async function editEv(){
  if(!(currentUser && currentUser.role === 'ADMIN')) return alert('Admin only');
  const deptId = prompt('Department ID to store this EV (deptId):'); if(!deptId) return;
  const key = prompt('Key (VIN or YMM)'); if(!key) return;
  const json = prompt('Paste JSON for this vehicle'); if(!json) return;
  try{
    const obj = JSON.parse(json);
    const dept = departments[deptId] || { info:{name:'(new)'}, apparatus:{}, resources:{}, coordinators:{}, members:{}, hazmat:{}, evDB:{} };
    dept.evDB = dept.evDB || {}; dept.evDB[key] = obj;
    await setDoc(doc(db, 'departments', deptId), dept);
    alert('Saved EV entry');
  }catch(e){ alert('Invalid JSON'); }
}

/* Weather using Open-Meteo */
async function searchWeather(){
  const loc = $('weatherInput').value.trim();
  if(!loc){ $('weatherResult').textContent = 'Enter a location'; return; }
  $('weatherResult').textContent = 'Geocoding...';
  try{
    const geo = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(loc)}&count=1`).then(r=>r.json());
    if(!geo.results || geo.results.length === 0){ $('weatherResult').textContent = 'Location not found'; return; }
    const p = geo.results[0];
    const weather = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${p.latitude}&longitude=${p.longitude}&current_weather=true`).then(r=>r.json());
    if(!weather.current_weather){ $('weatherResult').textContent = 'Weather not available'; return; }
    const cw = weather.current_weather;
    const out = { location:`${p.name}, ${p.country}`, temp_C:cw.temperature, wind_kmh:cw.windspeed, wind_deg:cw.winddirection, time:cw.time };
    $('weatherResult').textContent = JSON.stringify(out,null,2);
  }catch(e){ console.error(e); $('weatherResult').textContent='Weather lookup failed'; }
}

/* ---------- Delegated click handling ---------- */
document.addEventListener('click', async (ev)=>{
  const btn = ev.target.closest('button'); if(!btn) return;
  if(btn.dataset.action === 'editUser') return editUser(btn.dataset.user);
  if(btn.dataset.action === 'deleteUser') return deleteUser(btn.dataset.user);
  if(btn.dataset.action === 'openDept') return openDepartment(btn.dataset.id);
  if(btn.dataset.action === 'editDept') return editDepartment(btn.dataset.id);
  if(btn.dataset.action === 'deleteDept') return deleteDepartment(btn.dataset.id);
});

/* ---------- UI wiring ---------- */
$('menuBtn').addEventListener('click', ()=> {
  if(window.innerWidth <= 900) $('sidebar').classList.toggle('show'); else $('sidebar').classList.toggle('hidden');
});
document.querySelectorAll('#sidebar button[data-page]').forEach(b=> b.addEventListener('click', ()=> showPage(b.dataset.page)));

$('loginBtn').addEventListener('click', loginAction);
$('demoBtn').addEventListener('click', ()=>{ $('loginUser').value='ADMIN'; $('loginPass').value='ADMIN'; loginAction(); });

$('signOutBtn').addEventListener('click', ()=>{ currentUser=null; $('loginModal').style.display='flex'; $('sidebar').classList.add('hidden'); $('manageUsersBtn').style.display='none'; $('currentUserView').textContent='Not signed in'; });

$('addUserBtn').addEventListener('click', addUser);
$('addDeptBtn').addEventListener('click', addDepartment);

$('searchUnBtn').addEventListener('click', searchHazmat);
$('editHazmatBtn').addEventListener('click', editHazmat);
$('searchEvBtn').addEventListener('click', searchEv);
$('editEvBtn').addEventListener('click', editEv);

$('weatherBtn').addEventListener('click', searchWeather);
$('manageUsersBtn').addEventListener('click', ()=> showPage('manageUsers'));

/* ---------- Init ---------- */
(function init(){
  // snapshots will populate users & departments and render UI
  $('loginModal').style.display = 'flex';
  $('sidebar').classList.add('hidden');
})();

/* debugging helper */
window._debug = ()=> ({ users, departments, currentUser });

</script>
</body>
</html>
